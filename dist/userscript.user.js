// ==UserScript==
// @name         Several QoL
// @namespace    http://tampermonkey.net/
// @version      1.13.1
// @description  A userscript for QoL for the Haremverse
// @author       infarcactus
// @license      GPLv3
// @match        https://nutaku.haremheroes.com/*
// @match        https://*.hentaiheroes.com/*
// @match        https://*.gayharem.com/*
// @match        https://*.comixharem.com/*
// @match        https://*.hornyheroes.com/*
// @match        https://*.pornstarharem.com/*
// @match        https://*.transpornstarharem.com/*
// @match        https://*.gaypornstarharem.com/*
// @match        https://*.mangarpg.com/*
// @updateURL    https://github.com/infarcactus-HH/HH-Several_QoL/raw/refs/heads/main/dist/userscript.user.js
// @downloadURL  https://github.com/infarcactus-HH/HH-Several_QoL/raw/refs/heads/main/dist/userscript.user.js
// @grant        GM.addStyle
// @grant        GM_addStyle
// @grant        GM.openInTab
// @grant        GM_getValue
// @grant        GM_setValue
// @grant        GM_deleteValue
// @grant        unsafeWindow
// @run-at       document-end
// ==/UserScript==

"use strict";(()=>{var e=Object.defineProperty,t=Object.getOwnPropertyDescriptor,a=Object.getOwnPropertyNames,o=Object.prototype.hasOwnProperty,i=(e,t)=>()=>(e&&(t=e(e=0)),t),s=(t,a)=>{for(var o in a)e(t,o,{get:a[o],enumerable:!0})},r=i=>((i,s,r,n)=>{if(s&&"object"==typeof s||"function"==typeof s)for(let r of a(s))!o.call(i,r)&&void 0!==r&&e(i,r,{get:()=>s[r],enumerable:!(n=t(s,r))||n.enumerable});return i})(e({},"__esModule",{value:!0}),i),n={};s(n,{default:()=>l});var l,p=i(()=>{l=".pop-details-container{position:absolute;top:60px;left:10px;width:685px;float:left;min-height:200px;}.pop-details-left{position:absolute;width:300px;height:-webkit-fill-available;}.pop-details-left img{height:800px;mask-image:linear-gradient(to top,transparent 45%,black 60%);overflow:clip;display:block;}.pop-navigation-buttons-original{top:0px;position:absolute;padding:2px 4px;font-size:10px;}.pop-details-right{position:absolute;max-width:320px;width:320px;left:340px;top:35px;}.pop-title{font-size:18px;font-weight:bold;margin-bottom:5px;color:white;overflow:clip;white-space:nowrap;max-width:fit-content;display:block;text-overflow:ellipsis;}.pop-rewards-container{display:flex;justify-content:space-between;max-width:320px;}.claimPoPButton,.startPoPButton{margin-top:5px;width:-webkit-fill-available;}.pop-claimed-rewards-container{position:absolute;bottom:10px;left:340px;max-width:320px;width:320px;margin-top:10px;}.pop-claimed-rewards-items{display:flex;flex-wrap:wrap;justify-content:flex-start;align-items:flex-start;column-gap:20px;row-gap:5px;max-width:320px;}.pop-records-container{display:grid !important;grid-template-columns:repeat(3,1fr) !important;gap:4px !important;justify-content:start;align-items:start;width:300px !important;margin-bottom:10px;position:absolute !important;top:60px !important;right:15px !important;}.pop-record{background-size:cover;background-position:center;position:relative;padding:6px;border-radius:3px;min-height:58px;width:100px;box-shadow:0 1px 3px rgba(0,0,0,0.3);cursor:pointer;}.pop-record.selected{border:2px solid #ffcc00 !important;box-shadow:0 0 10px rgba(255,204,0,0.5) !important;}.pop-icon{position:absolute;top:3px;left:3px;width:15px;height:15px;filter:drop-shadow(0 0 1px rgba(0,0,0,0.6)) drop-shadow(1px 1px 1px rgba(0,0,0,0.6)) drop-shadow(-1px -1px 1px rgba(0,0,0,0.6)) drop-shadow(1px -1px 1px rgba(0,0,0,0.6)) drop-shadow(-1px 1px 1px rgba(0,0,0,0.6));}.pop-lvl{position:absolute;top:3px;right:3px;background:rgba(0,0,0,0.6);font-size:12px;color:#ffb827;}.pop-timer{position:absolute;bottom:3px;background:rgba(0,0,0,0.8);color:white;padding:1px 3px;border-radius:1px;font-size:8px;}.collect_notif{position:absolute;bottom:3px;right:3px;}.pop-koban-buttons-container{position:absolute;left:340px;width:320px;display:flex;flex-direction:row;align-items:center;gap:10px;flex-wrap:nowrap;}.pop-koban-buttons-container > .pop-koban-button{display:flex;flex-direction:row;align-items:center;gap:20px;width:160px;padding:0 10px;margin-top:0;}.pop-koban-button > .action-cost{display:flex;align-items:end;margin-left:auto;}"}),d={};s(d,{default:()=>c});var c,u=i(()=>{c=".popup_wrapper > #popup_PoVInfo{width:1020px;height:550px;top:0.62rem;left:0.62rem;}#popup_PoVInfo close{width:2.4rem;height:2.2rem;background-image:url(/images/clubs/ic_xCross.png);opacity:1;}.PoVInfo-container{width:100%;height:100%;box-shadow:none;border:2px solid #ff9900;align-content:center;}.PoVInfo-container img{height:80%;width:auto;}.PoVInfo-container .PoVInfo-title{width:100%;height:10%;font-size:1.8rem;font-weight:bold;color:#FFB827;}"}),h={};s(h,{default:()=>m});var m,g=i(()=>{m=".me-ranking-tooltip th,.me-ranking-tooltip td{border:1px solid #ccc;padding:5px;text-align:center;}.me-leaderboard-info{position:absolute;right:13rem;width:20px;}"}),f={};s(f,{default:()=>b});var b,_=i(()=>{b=".several-qol-bestrank-timesreached{margin-left:5px;display:flex;width:100%;align-items:center;text-shadow:1px 0 0 #000,0 1px 0 #000,-1px 0 0 #000,0 -1px 0 #000,1px 1px 0 #000,-1px -1px 0 #000,1px -1px 0 #000,-1px 1px 0 #000;}.several-qol-bestrank-timesreached > .rank-container{background-size:cover;text-align:center;min-width:16px;max-width:32px;width:auto;height:16px;font-size:10px;}.several-qol-bestrank-timesreached > .times-reached{margin-left:3px;}.several-qol-top1{background:transparent radial-gradient(closest-side at 50% 50%,#f5a866 0%,#ec0039 51%,#9e0e27 100%) 0% 0% no-repeat padding-box;}.several-qol-top4{background-image:url(/images/legendary.png);}.several-qol-top15{background:#ffb244;}.several-qol-top30{background:#23b56b;}.several-qol-top30plus{background:#8d8e9f;}"}),v={};s(v,{default:()=>w});var w,P=i(()=>{w=".popup_wrapper > #popup-event_info{width:1020px;height:32rem;top:3rem;left:0.62rem;}#popup-event_info > #container-event_info.container-special-bg{display:flex;flex-direction:column;height:100%;}#popup-event_info close{width:2.4rem;height:2.2rem;background-image:url(/images/clubs/ic_xCross.png);opacity:1;}#container-event_info{width:100%;height:100%;box-shadow:none;border:2px solid #ff9900;align-content:center;}#container-event_info > .banner{width:100%;height:3rem;font-size:1.8rem;font-weight:bold;color:#ffb827;text-align:center;line-height:3rem;border-bottom:2px solid #ff9900;flex-shrink:0;}#container-event_info > .event-content{flex:1 1 auto;padding:1rem;overflow:auto;text-align:left;}#container-event_info strong{color:#FFB827;}"}),y=class{constructor(){this.group="severalQoL",this.hasRun=!1}},x=class extends y{constructor(){super(...arguments),this.configSchema={baseKey:"popupPlusPlus",label:"<span tooltip='Stacking popups,click on the popup to make it disappear'>Popup++</span>",default:!0}}shouldRun(){return!0}run(){if(this.hasRun||!this.shouldRun())return;this.hasRun=!0,GM.addStyle("#toast-popups {display:inherit!important;}");let e={},t=null;delete shared.general.objectivePopup.show,shared.general.objectivePopup.show=function(a){if(null==this.LastPoints&&(this.LastPoints={}),a.objective_points&&!a.battle_result){if(!a.objective_points){let e=a.objective_points;if(Object.keys(this.pointsBox).length)for(let t in e)this.pointsBox[t]?this.pointsBox[t].name===e[t].name&&(this.pointsBox[t].points_gained+=e[t].points_gained):this.pointsBox[t]=e[t];else this.pointsBox=a.objective_points;a?.end?.rewards?.hasOwnProperty("lose")}!function(a,o){let i=new Set;Object.keys(o).map(t=>{let a=o[t];if(e[t]){let o=a.points_gained;o>0&&i.add(t),e[t].points_gained+=o}else e[t]=a,a.points_gained>0&&i.add(t)});let s=$(`<div class="popup_wrapper"><div id="objective_popup" class="popup"><div class="noti_box"><div class="points">${Object.keys(e).map(t=>{let a=e[t];return`<div class="row animate" style="transition: all 20ms;"><div class="contest_name">${a.title}:</div><div class="contest_points"><div class="points_name" style="animation:none;">${a.name}: </div><div class="points_num" style="animation:none;"><div class="points_i" style="animation:none;">+${number_format_lang(a.points_gained)}</div></div></div></div>`}).join("")}</div></div></div></div></div>`);$("#toast-popups .popup_wrapper").remove(),$("#toast-popups").css("display","unset"),$("#toast-popups"),$("#toast-popups").append(s),$("#toast-popups").css("display","unset"),t&&(clearTimeout(t),t=null),t=setTimeout(()=>{s.remove(),t=null,e={}},5e3),s.on("click.removePopup",function(){s.remove(),t=null,e={}})}(0,a.objective_points)}}}},k=class extends y{constructor(){super(...arguments),this.configSchema={baseKey:"peopleToWiki",label:"People to Wiki(HH,GH,GPSH)",default:!1,subSettings:[{key:"infoBubbleNameToWiki",default:!0,label:"Info bubble name clickable to wiki"},{key:"portraitToWiki",default:!1,label:"Make portrait clickable to wiki"}]}}shouldRun(){return location.host.includes("heroes")||location.host.includes("gayharem")||location.host.includes("gaypornstarharem")}run(e){this.hasRun||!this.shouldRun()||(this.hasRun=!0,e?.infoBubbleNameToWiki&&setInterval(()=>{this.applyInfoBubbleToWiki()},500),e?.portraitToWiki&&setInterval(()=>{this.applyImageToWiki()},500))}applyInfoBubbleToWiki(){let e=this;$(".new_girl_info .girl_name_wrap > h5[style!='cursor: pointer;']").each(function(){let t=$(this);t.css("cursor","pointer"),t.on("click.InfoBubbleToWiki",function(){let a=t.attr("hh_title");if(!a)return;let o=a.replace(/ /g,"-");GM.openInTab(e.getWikiPageForCurrentGame(o),{active:!0})})})}applyImageToWiki(){let e=this;$(".slot_girl_shards > [data-new-girl-tooltip][style!='cursor: pointer;']").each(function(){let t=$(this),a=t.attr("data-new-girl-tooltip");if(!a)return;let o=a.match(/"name":"(.+)","rarity/);o&&o[1]&&(t.css("cursor","pointer"),t.on("click.ImgToWiki",function(t){t.stopPropagation();let a=o[1].replace(/ /g,"-");GM.openInTab(e.getWikiPageForCurrentGame(a),{active:!0})}))})}getWikiPageForCurrentGame(e){if(location.host.includes("heroes.com"))return`https://harem-battle.club/wiki/Harem-Heroes/HH:${e}`;if(location.host.includes("gayharem"))return`https://harem-battle.club/wiki/Gay-Harem/GH:${e}`;if(location.host.includes("gaypornstarharem"))return`https://harem-battle.club/wiki/Gay-Pornstar-Harem/GPSH:${e}`;throw new Error("Unsupported game for wiki link")}},R=class{static doWhenSelectorAvailable(e,t){if($(e).length)t();else{let a=new MutationObserver(()=>{$(e).length&&(a.disconnect(),t())});a.observe(document.documentElement,{childList:!0,subtree:!0})}}},S=class extends y{constructor(){super(...arguments),this.savedTeamPresetKey="SeveralQoL_LabyTeamPreset",this.configSchema={baseKey:"labyTeamPreset",label:"<span tooltip='Add a button to register laby team presets, and to apply it'>Laby Team Preset</span>",default:!0}}shouldRun(){return location.pathname.includes("/edit-labyrinth-team.html")}run(){if(this.hasRun||!this.shouldRun())return;this.hasRun=!0;let e=$(".boss-bang-panel"),t=$('<button class="green_button_L" tooltip="Save preset for later runs">Save Preset</button>');t.on("click",()=>{this.saveCurrentPreset(),a.removeAttr("disabled")}),e.append(t);let a=$(`<button class="green_button_L" tooltip="Use previously saved preset & leave page" ${localStorage.getItem(this.savedTeamPresetKey)?"":"disabled"}>Fill Preset</button>`);a.on("click",()=>{this.loadSavedPreset()}),R.doWhenSelectorAvailable(".change-team-panel .player-team .average-lvl",()=>{$(".change-team-panel .player-team .average-lvl").replaceWith(a)})}saveCurrentPreset(){let e=[];$(".team-hexagon .team-member-container").each(function(){let t=$(this).attr("data-team-member-position"),a=$(this).attr("data-girl-id");$(this).is("[data-girl-id]")&&t&&a&&(e[t]=a)}),localStorage.setItem(this.savedTeamPresetKey,JSON.stringify(e))}loadSavedPreset(){let e=localStorage.getItem(this.savedTeamPresetKey);if(e)try{let t={class:"Hero",action:"edit_team",girls:JSON.parse(e),battle_type:"labyrinth",id_team:unsafeWindow.teamId};shared.general.hh_ajax(t,e=>{shared.general.navigate(unsafeWindow.redirectUrl)})}catch(e){console.error("Failed to load preset:",e)}else console.warn("No saved preset found")}},C=class extends y{constructor(){super(...arguments),this.configSchema={baseKey:"noAnnoyingPopups",label:"<span tooltip='Tired of shop popups or news popup appearing randomly and breaking your flow ?'>Removes annoying popup appearing automaticly for shops, paths, news</span>",default:!1}}shouldRun(){return!0}run(){this.hasRun||!this.shouldRun()||(this.hasRun=!0,document.cookie="disabledPopups=PassReminder,Bundles,News; path=/")}},G=class extends y{constructor(){super(...arguments),this.configSchema={baseKey:"whaleBossTournament",label:"Renames WBT to Whale Boss Tournament",default:!1}}shouldRun(){return location.pathname.includes("/home.html")}run(){this.hasRun||!this.shouldRun()||(this.hasRun=!0,R.doWhenSelectorAvailable(".world-boss .title",()=>{$(".world-boss .title").text("Whale Boss Tournament")}))}},O=class{static getStoredGirlsNumber(){return GM_getValue(HH_UNIVERSE+"StoredGirls",0)}static setStoredGirlsNumber(e){GM_setValue(HH_UNIVERSE+"StoredGirls",e)}static setEnumGirlsOrderedByClass(e,t){GM_setValue(HH_UNIVERSE+"EnumGirlsOrderedByClass_"+t,e)}static getEnumGirlsOrderedByClass(e){return GM_getValue(HH_UNIVERSE+"EnumGirlsOrderedByClass_"+e,[])}static setLastSortOfGirls(e){GM_setValue(HH_UNIVERSE+"PoPLastSortOfGirls",e)}static getLastSortOfGirls(){return GM_getValue(HH_UNIVERSE+"PoPLastSortOfGirls",0)}static setLeaguePLayerRecord(e){GM_setValue(HH_UNIVERSE+"LeaguePlayerRecord",e)}static getLeaguePlayerRecord(){return GM_getValue(HH_UNIVERSE+"LeaguePlayerRecord",{})}},T=class extends y{constructor(){super(...arguments),this.configSchema={baseKey:"placesOfPowerPlusPlus",label:"<span tooltip='Global overhaul of PoPs especially for claiming & filling manually'>Places of Power++</span>",default:!0},this.isUpdatingGirls=!1,this.currentPoPGirls={},this.minPercentToStartPoP=.05,this.criteriaToClassMap={carac_1:1,carac_2:2,carac_3:3}}shouldRun(){return location.pathname.includes("/activities.html")&&!location.search.includes("?tab=pop&index=")}run(){if(this.hasRun||!this.shouldRun())return;this.hasRun=!0;let e=$(".switch-tab[data-tab='pop']");e.contents()[0].nodeValue="Places of Power++",e.attr("tooltip","By infarctus"),e.on("click",async()=>{if(this.isUpdatingGirls){for(shared.animations.loadingAnimation.start();this.isUpdatingGirls;)await new Promise(e=>setTimeout(e,100));shared.animations.loadingAnimation.stop()}this.buildCustomPopInfo()}),this.injectCustomStyles(),this.girlsHandler().then(()=>{this.whichGirlsInPoP()})}updateHHPlusPlusPoPTrackedTime(e){let t="HHPlusPlusTrackedTimes";if(!localStorage.getItem(t))return;let a=JSON.parse(localStorage.getItem(t)||"{}");if(null==a.pop||null==a.popDuration)return;for(let e of Object.values(pop_data))if("pending_reward"===e.status)return;let o=Math.floor(Date.now()/1e3);0==a.pop&&(a.pop=o+e,a.popDuration=e,localStorage.setItem(t,JSON.stringify(a)))}createOrUpdateKobanButtons(){let e=!1,t=!1;for(let a of Object.values(pop_data))if("pending_reward"===a.status&&(e=!0),"can_start"===a.status&&(t=!0),e&&t)break;$(".pop-koban-buttons-container").length&&$(".pop-koban-buttons-container").remove();let a=$('<div class="pop-koban-buttons-container"></div>'),o=$(`<btn class="pop-koban-button pop-claim-all orange_button_L" price="${hh_prices_auto_claim}" ${e?"":"disabled"}><div class="action-label">Claim All</div><div class="action-cost"><div class="hc-cost"><span class="hard_currency_icn"></span>${hh_prices_auto_claim}</div></div></div>`);o.on("click",function(){let e=$(this);if(void 0!==e.attr("disabled"))return;let t=e.attr("price");shared.general.hc_confirm(t,()=>{e.prop("disabled",!0),shared.general.hh_ajax({action:"pop_claim_all"},t=>{e.prop("disabled",!1);let a=shared.reward.newReward.multipleSlot(t.rewards.data.rewards);$(".pop-claimed-rewards-items").append(a);for(let e of Object.values(pop_data))"pending_reward"===e.status&&(e.status="can_start");$(".pop-record .collect_notif").remove()})})}),a.append(o);let i=$(`<btn class="pop-koban-button pop-fill-all orange_button_L" price="${hh_prices_auto_start}" ${t?"":"disabled"}><div class="action-label">Fill All</div><div class="action-cost"><div class="hc-cost"><span class="hard_currency_icn"></span>${hh_prices_auto_start}</div></div></div>`);i.on("click",function(){let e=$(this);if(void 0!==e.attr("disabled"))return;let t=e.attr("price");shared.general.hc_confirm(t,()=>{e.prop("disabled",!0),shared.general.hh_ajax({action:"pop_auto_start_all"},function(){e.prop("disabled",!1),location.reload()})})}),a.append(i),$(".pop-details-container").append(a)}convertCriteriaKey(e){return e.replace("_","")}assignGirlsToPoP(e){let t=Object.values(pop_data).find(t=>t.id_places_of_power===e);if(!t)return;let a=t.criteria,o=t.max_team_power;return this.selectOptimalGirls(e,o,a)}selectOptimalGirls(e,t,a){let o=this.convertCriteriaKey(a),i=this.criteriaToClassMap[a],s=O.getEnumGirlsOrderedByClass(i);if(0===s.length)return console.error(`[PoP ${e}] No girls available in storage!`),[];let r=new Set;for(let[t,a]of Object.entries(this.currentPoPGirls))parseInt(t)!==e&&a.forEach(e=>r.add(e));let n=[],l=t;for(let e of s){if(r.has(e))continue;let t=pop_hero_girls[e];if(!t)continue;let a=t[o];if(a<=l){if(l-=a,n.push(e),0===l)break}else if(0===n.length||l>0){let t=e;for(let a=s.indexOf(e)+1;a<s.length;a++){let e=s[a];if(r.has(e))continue;let i=pop_hero_girls[e];if(!i)continue;let n=i[o];if(n<=l){n===l&&(t=e);break}t=e}n.push(t);break}}return n}readdGirlsFromCurrentPoP(e){let t=parseInt(e);delete this.currentPoPGirls[t]}selectNextPoPFromFill(e){if(0===e.length)return;let t=e.nextAll().filter(function(){let e=$(this).data("pop-id");return pop_data[e]&&"in_progress"!==pop_data[e].status}).first();if(t.length)t.trigger("click");else if(t=$(".pop-record").filter(function(){let e=$(this).data("pop-id");return pop_data[e]&&"in_progress"!==pop_data[e].status}).first(),t.length)t.trigger("click");else{for(let e of Object.values(pop_data))if("in_progress"!==e.status)return void $(`[data-pop-id='${e.id_places_of_power}']`).trigger("click");$(".pop-record").first().trigger("click")}}selectNextPoPFromClaim(){let e=$(".pop-record.selected");if(0!==e.nextAll().find(".collect_notif").length)return void e.nextAll().find(".collect_notif").first().parent().trigger("click");let t=$(".pop-record").find(".collect_notif").first();if(t.length)t.parent().trigger("click");else{for(let e of Object.values(pop_data))if("can_start"===e.status)return void $(`[data-pop-id='${e.id_places_of_power}']`).trigger("click");$(".pop-record").first().trigger("click")}}sendClaimRequest(e){shared.animations.loadingAnimation.start(),this.readdGirlsFromCurrentPoP(e);let t=pop_data[parseInt(e)];if($(".claimPoPButton").prop("disabled",!0),null===t.ends_in||0!==t.ends_in)$(".claimPoPButton").css("display","none"),$(".startPoPButton").css("display",""),pop_data[parseInt(e)].status="can_start",$(".pop-record.selected .collect_notif").remove();else{let t=$(".pop-record.selected");this.selectNextPoPFromFill(t),delete pop_data[parseInt(e)],t.remove()}let a={namespace:"h\\PlacesOfPower",class:"standard"===t.type?"PlaceOfPower":"TempPlaceOfPower",action:"claim",id_place_of_power:t.id_places_of_power};delete this.currentPoPGirls[t.id_places_of_power],shared.general.hh_ajax(a,e=>{let t=$(".pop-claimed-rewards-items");if(t.length){if(e.rewards.data.rewards){let a=shared.reward.newReward.multipleSlot(e.rewards.data.rewards);t.append(a)}this.selectNextPoPFromClaim(),shared.animations.loadingAnimation.stop()}})}calculateTimeToFinishSeconds(e,t){let a=this.convertCriteriaKey(e.criteria),o=0;for(let e of t){let t=pop_hero_girls[e];t&&(o+=t[a])}if(o>=e.max_team_power)return 21600;let i=e.level_power/o;return Math.floor(60*i)}sendFillRequest(e){shared.animations.loadingAnimation.start();let t=pop_data[parseInt(e)];if("can_start"!==t.status)return;let a=t.id_places_of_power,o=this.assignGirlsToPoP(a)||[];if(this.currentPoPGirls[a]=o,0===o.length)return alert("No girls were assigned to this PoP. This might happen if all your girls are already assigned to other PoPs."),delete this.currentPoPGirls[a],void shared.animations.loadingAnimation.stop();let i=this.convertCriteriaKey(t.criteria),s=0;for(let e of o){let t=pop_hero_girls[e];t&&(s+=t[i])}if(s/t.max_team_power<this.minPercentToStartPoP/100)return alert("Not enough power to start this PoP."),delete this.currentPoPGirls[a],void shared.animations.loadingAnimation.stop();let r=this.calculateTimeToFinishSeconds(t,o);if(s<t.max_team_power&&!confirm(`Warning: This PoP is not fully maxed!\n\nCurrent Power: ${Math.floor(s)}\nMax Power: ${t.max_team_power}\n\nThis will take ${(r/60/60).toFixed(2)} hours to complete.\nDo you want to continue?`))return delete this.currentPoPGirls[a],$(".startPoPButton").css("display",""),$(".claimPoPButton").css("display","none"),void shared.animations.loadingAnimation.stop();$(".startPoPButton").css("display","none"),$(".claimPoPButton").css("display","");let n={namespace:"h\\PlacesOfPower",class:"standard"===t.type?"PlaceOfPower":"TempPlaceOfPower",action:"start",id_place_of_power:a,selected_girls:o},l=$('<div class="pop-timer"></div>'),p=shared.timer.buildTimer(r,"","pop-active-timer",!1);l.append(p),$(".pop-record.selected").append(l),pop_data[parseInt(e)].status="in_progress",shared.general.hh_ajax(n,e=>{shared.timer.activateTimers("pop-record.selected .pop-active-timer",()=>{}),this.selectNextPoPFromFill($(".pop-record.selected")),this.updateHHPlusPlusPoPTrackedTime(r),shared.animations.loadingAnimation.stop()})}buildPopDetails(e){let t=$(".pop-details-container");if(!t.length)return;t.children().not(".pop-claimed-rewards-container").remove();let a=pop_data[parseInt(e)];if(!a)return;let o=$('<div class="pop-details-left"></div>');t.append(o);let i=$("<img></img>");i.attr("src",a.girl?a.girl.avatar:IMAGES_URL+"/pictures/girls/1/avb0-1200x.webp?a=1"),o.append(i);let s=$('<div class="pop-navigation-buttons-original blue_button_L">Visit Original</div>');s.on("click",()=>{shared.general.navigate("/activities.html?tab=pop&index=")}),o.append(s);let r=$("<div class='pop-details-right'></div>");t.prepend(r);let n=$(`<a tooltip="Visit this PoP original page" class="pop-title" href="${shared.general.getDocumentHref("/activities.html?tab=pop&index="+a.id_places_of_power)}">${a.title}</div>`);r.append(n);let l=$('<div class="pop-rewards-container"></div>');for(let[e,t]of Object.entries(a.rewards))if(t.loot){let e=shared.reward.newReward.multipleSlot(t);l.append(e);break}r.append(l);let p=$(`<button class="purple_button_L claimPoPButton" ${"pending_reward"!=a.status?"disabled":""}>Claim</button>`);r.append(p),p.on("click",()=>{this.sendClaimRequest(e)});let d=$('<button class="blue_button_L startPoPButton">Fill & Start</button>');if(d.on("click",()=>{this.sendFillRequest(e)}),r.append(d),"can_start"!==a.status?d.css("display","none"):p.css("display","none"),!$(".pop-claimed-rewards-container").length){let e=$("<div class='pop-claimed-rewards-container'></div>");t.append(e),e.append("<b>Claimed Rewards:</b>");let a=$("<div class='pop-claimed-rewards-items'></div>");e.append(a)}this.createOrUpdateKobanButtons()}buildCustomPopInfo(){let e=$("#pop_info");if(!e.length)return;e.empty();let t=$('<div class="pop-details-container"></div>');e.append(t);let a=$('<div class="pop-records-container"></div>');Object.entries(pop_data).forEach(([e,t])=>{let o=$('<div class="pop-record"></div>');o.attr("data-pop-id",e),o.css("background-image",`url(${t.image})`),o.on("click",()=>{$(".pop-record").removeClass("selected"),o.addClass("selected"),this.buildPopDetails(e)});let i=$(`<img src="https://hh.hh-content.com/pictures/misc/items_icons/${t.class}.png" class="pop-icon" />`);o.append(i);let s=$(`<div class="pop-lvl">Lv. ${t.level}</div>`);if(o.append(s),"in_progress"===t.status){let e=$('<div class="pop-timer"></div>'),a=shared.timer.buildTimer(t.remaining_time,"","pop-active-timer",!1);e.append(a),o.append(e)}if("pending_reward"===t.status){let e=$('<div class="collect_notif"></div>');o.append(e)}a.append(o),o.attr("tooltip",t.title)}),e.append(a),0!==$(".pop-record").find(".collect_notif").length?$(".pop-record").find(".collect_notif").first().parent().trigger("click"):$(".pop-record").first().trigger("click"),shared.timer.activateTimers("pop-active-timer",e=>{let t=e.$dom_element.parent().parent().parent();t.hasClass("selected")&&$(".claimPoPButton").prop("disabled",!1);let a=t.data("pop-id");pop_data[a].status="pending_reward",t.append('<div class="collect_notif"></div>')})}injectCustomStyles(){let e=(p(),r(n)).default;GM.addStyle(e)}binarySearchInsertIndex(e,t,a){let o=0,i=e.length;for(;o<i;){let s=Math.floor((o+i)/2),r=pop_hero_girls[e[s]];r&&t>r[a]?i=s:o=s+1}return o}async girlsHandler(){let e=O.getStoredGirlsNumber(),t=Object.keys(pop_hero_girls).length;if(t-e<5)return;this.isUpdatingGirls=!0;let a=Object.values(pop_hero_girls);if(e<=100||e<O.getLastSortOfGirls()-20){O.setLastSortOfGirls(t);let e=[...a].sort((e,t)=>t.carac1-e.carac1).map(e=>e.id_girl);O.setEnumGirlsOrderedByClass(e,1);let o=[...a].sort((e,t)=>t.carac2-e.carac2).map(e=>e.id_girl);O.setEnumGirlsOrderedByClass(o,2);let i=[...a].sort((e,t)=>t.carac3-e.carac3).map(e=>e.id_girl);O.setEnumGirlsOrderedByClass(i,3),O.setStoredGirlsNumber(t)}else{let e=O.getEnumGirlsOrderedByClass(1),o=O.getEnumGirlsOrderedByClass(2),i=O.getEnumGirlsOrderedByClass(3),s=new Set(e),r=a.filter(e=>!s.has(e.id_girl));for(let t of r){let a=this.binarySearchInsertIndex(e,t.carac1,"carac1");e.splice(a,0,t.id_girl);let s=this.binarySearchInsertIndex(o,t.carac2,"carac2");o.splice(s,0,t.id_girl);let r=this.binarySearchInsertIndex(i,t.carac3,"carac3");i.splice(r,0,t.id_girl)}O.setEnumGirlsOrderedByClass(e,1),O.setEnumGirlsOrderedByClass(o,2),O.setEnumGirlsOrderedByClass(i,3),O.setStoredGirlsNumber(t)}}whichGirlsInPoP(){for(let e of Object.values(pop_hero_girls))null!=e.id_places_of_power&&(this.currentPoPGirls[e.id_places_of_power]||(this.currentPoPGirls[e.id_places_of_power]=[]),this.currentPoPGirls[e.id_places_of_power].push(e.id_girl));this.isUpdatingGirls=!1}},I=class extends y{constructor(){super(...arguments),this.configSchema={baseKey:"noReloadFromClaimingDailyChests",label:"Activities : No reload from claiming daily chests",default:!0}}shouldRun(){return!0}run(){if(this.hasRun||!this.shouldRun())return location.pathname.includes("/activities.html");this.hasRun=!0,$(".switch-tab[data-tab='daily_goals']").on("click",()=>{R.doWhenSelectorAvailable(".progress-bar-claim-reward",()=>{this.applyNoReloadFix()})})}applyNoReloadFix(){let e=this;$(".progress-bar-claim-reward").off("click").on("click",function(t){t.stopPropagation(),t.preventDefault(),$(this).prop("disabled",!0);let a=$(this).attr("tier");if(!a)return;let o={action:"claim_daily_goal_tier_reward",tier:a};daily_goals_member_progression.taken_rewards_array.push(a),shared.general.hh_ajax(o,t=>{let a=t.rewards;shared.reward_popup.Reward.handlePopup(a),e.checkIfAllChestsClaimed()})}),$(".progress-bar-claim-reward").attr("tooltip","Several QoL: Claim without reload")}checkIfAllChestsClaimed(){daily_goals_member_progression.taken_rewards_array.length>=Math.min(Math.floor(daily_goals_member_progression.potions_amount/20),5)&&$('[data-tab="daily_goals"] > .collect_notif').remove()}},j=class extends y{constructor(){super(...arguments),this.configSchema={baseKey:"povInfo",label:"<span tooltip='Click on PoV Info to get more info about PoVs'>PoV Info</span>",default:!0}}shouldRun(){return location.pathname.includes("/path-of-valor.html")}run(){this.hasRun||!this.shouldRun()||(this.hasRun=!0,R.doWhenSelectorAvailable(".potions-paths-objective > h4",()=>{$(".potions-paths-objective > h4").text("PoV Info (click)"),$(".potions-paths-objective > h4").css("cursor","pointer"),$(".potions-paths-objective > h4").on("click",()=>{this.activatePopup()})}))}activatePopup(){let e=$('\n    <div class="popup_background clickable"></div>\n    <div id="popup_PoVInfo" class="popup">\n        <div class="PoVInfo-container container-special-bg">\n            <span class="PoVInfo-title">Path of Valor Info</span>\n            <p>PoV cycle through those goals in order</p>\n            <img src="https://raw.githubusercontent.com/infarcactus-HH/HH-Several_QoL/refs/heads/main/images/PoVInfo.png" alt="PoVInfo" />\n        </div>\n        <close class="closable"></close>\n    </div>\n    '),t=(u(),r(d)).default;GM.addStyle(t);let a={type:"common",init:t=>{let o=$("#common-popups");a.$dom_element.empty().append(e),o.append(a.$dom_element)},destroy:()=>{shared.PopupQueueManager.close({type:"common"})},onClose:()=>{},onOpen:()=>{},$dom_element:$('<div class="popup_wrapper"></div>'),popup_name:"pov_info",close_on_esc:!0,addEventListeners:()=>{a.$dom_element.find("close.closable").on("click",()=>{a.destroy()}),a.$dom_element.find(".popup_background.clickable").on("click",()=>{a.destroy()})},removeEventListeners:()=>{}};shared.PopupQueueManager.add({popup:a})}},E=class extends y{constructor(){super(...arguments),this.configSchema={baseKey:"meRankingInfo",label:"ME : Adds info about rankings in seasonal event",default:!0},this.heroData=null,this.leaderboardData=null}shouldRun(){return location.pathname.includes("seasonal.html")}run(){this.hasRun||!this.shouldRun()||(this.hasRun=!0,this.injectCSS(),this.hookAjaxRequest())}async injectCSS(){let e=(g(),r(h)).default;GM.addStyle(e)}hookAjaxRequest(){$(document).ajaxComplete((e,t,a)=>{"action=leaderboard&feature=seasonal_event_top"===a?.data&&(this.heroData=t.responseJSON?.hero_data,this.leaderboardData=t.responseJSON?.leaderboard,this.hookSpecialHeroRow())})}hookSpecialHeroRow(){R.doWhenSelectorAvailable("#leaderboard_holder > #outer-hero-row",()=>{let e=this.createTooltipTableRankingContent(),t=$('<img class="me-leaderboard-info" src="https://hh.hh-content.com/leagues/ic_rankup.png" tooltip></img>');t.attr("hh_title",e),$("#leaderboard_holder > #outer-hero-row").append(t)})}createTooltipTableRankingContent(){if(!this.heroData||!this.leaderboardData)return"";let e=this.heroData.rank,t=this.heroData.potions,a='<div class="me-ranking-tooltip"><table style="border-collapse: collapse; width: 100%;"><thead><tr><th>Rank</th><th>Resource</th><th>Difference</th></tr></thead><tbody>',o=this.leaderboardData.find(t=>t.rank===e);return[10,50,100,250,500,1e3].forEach(e=>{let i=this.leaderboardData.find(t=>t.rank===e),s=i?.potions??"?",r="?",n="black";if(i){let e=t-i.potions;if(0===e){let e=o?o.id_member:1/0,t=i.id_member;e<t?(r="+0 (above)",n="green"):e>t?(r="+0 (below)",n="red"):(r="= (tie)",n="orange")}else r=e>0?`+${e}`:`${e}`,n=e>0?"green":"red"}a+=`<tr><td>${e}</td><td>${s}</td><td style="color: ${n}; font-weight: bold;">${r}</td></tr>`}),a+="</tbody></table></div>",a}},B=class extends y{constructor(){super(...arguments),this.configSchema={baseKey:"leagueOpponentHistory",label:"League : Show history of opponents (click on the row to refresh, only looks for highest league)",default:!0},this.updatedPlayerRecordsThisSession=new Set}shouldRun(){return location.pathname.includes("/leagues.html")}run(){this.hasRun||!this.shouldRun()||(this.hasRun=!0,this.injectCSS(),this.leaguePlayerRecord=O.getLeaguePlayerRecord(),R.doWhenSelectorAvailable(".league_table",()=>{this.applyRankingsToOpponentLists(),this.startObserverClickOnTable(),this.applyRankingsToTable()}),$(document).on("league:table-sorted",()=>{this.startObserverClickOnTable(),this.applyRankingsToTable()}))}async injectCSS(){let e=(_(),r(f)).default;GM.addStyle(e)}applyRankingsToOpponentLists(){void 0!==this.leaguePlayerRecord&&opponents_list.forEach(e=>{let t=e.player.id_fighter,a=this.leaguePlayerRecord[t];a&&(e.Several_QoL={chechExpiresAt:a.checkExpiresAt,bestPlace:a.bestPlace,timesReached:a.timesReached})})}startObserverClickOnTable(){let e=this;$(".league_table > .data-list > .body-row").on("click.SeveralQoL",function(){let t=parseInt($(this).children("[column='place']").text().trim()),a=opponents_list.find(e=>e.place===t);a?a.Several_QoL&&a.Several_QoL.chechExpiresAt>server_now_ts||e.updatedPlayerRecordsThisSession.has(a.player.id_fighter)||e.sendRequestAndAnalyzeOpponent(a.player.id_fighter,$(this)):console.warn("Could not find opponent for place ",t)})}sendRequestAndAnalyzeOpponent(e,t){let a={action:"fetch_hero",id:"profile",preview:!1,player_id:e},o=Object.keys(league_rewards).length,i=new RegExp(`<img src="https:\\/\\/.*?\\/pictures\\/design\\/leagues\\/${o}\\.png">\\n\\s*?<div class=\\"tier-stats\\">\\n\\s*?<div>Best place:\\s*<span>(\\d+)<sup>[^<]+<\\/sup><\\/span><\\/div>[\\s\\S]*?<div>Times reached: <span>(\\d+)<\\/span><\\/div>`,"g");shared.general.hh_ajax(a,a=>{let s=i.exec(a.html),r=s?parseInt(s[1]):null,n=s?parseInt(s[2]):null;if(this.updatedPlayerRecordsThisSession.add(e),!r||!n)return void console.warn(`Could not find league ${o} placement info for opponent id `,e);let l=this.leaguePlayerRecord[e];l&&l.bestPlace===r&&l.timesReached===n||(this.updateOpponentRecord(e,r,n),t.children("[column='nickname']").find(".several-qol-bestrank-timesreached").remove(),t.children("[column='nickname']").append(this.generateRankHtml(r,n)))})}updateOpponentRecord(e,t,a){this.leaguePlayerRecord[e]={bestPlace:t,timesReached:a,checkExpiresAt:server_now_ts+season_end_at+10},O.setLeaguePLayerRecord(this.leaguePlayerRecord)}applyRankingsToTable(){let e=$(".data-row.body-row");void 0!==this.leaguePlayerRecord&&e.each((e,t)=>{let a=parseInt($(t).children("[column='place']").text().trim());if(!a)return;let o=opponents_list.find(e=>e.place===a);if(!o)return;let i=o.player.id_fighter,s=this.leaguePlayerRecord[i];s&&!$(t).children("[column='nickname']").find(".several-qol-bestrank-timesreached").length&&$(t).children("[column='nickname']").append(this.generateRankHtml(s.bestPlace,s.timesReached))})}generateRankHtml(e,t){let a=$('<div class="several-qol-bestrank-timesreached"></div>'),o=$(`<span class="rank-container ${this.generateRankClass(e)}">${e}</span>`),i=$(`<span class="times-reached">x${t}</span>`);return a.prepend(o),a.append(i),a}generateRankClass(e){return 1==e?"several-qol-top1":e<=4?"several-qol-top4":e<=15?"several-qol-top15":e<=30?"several-qol-top30":"several-qol-top30plus"}},L=class extends y{constructor(){super(...arguments),this.configSchema={baseKey:"leagueNoPlayerProfileOnNameClick",label:"League : Disable opening player profile when clicking on their name",default:!1}}shouldRun(){return location.pathname.includes("/leagues.html")}run(){this.hasRun||!this.shouldRun()||(this.hasRun=!0,R.doWhenSelectorAvailable('.data-row.body-row .data-column[column="nickname"]',()=>{$("body").off("click",'.data-row.body-row .data-column[column="nickname"]')}),$(document).on("league:table-sorted",()=>{$("body").off("click",'.data-row.body-row .data-column[column="nickname"]')}))}},H=class{static createCommonPopup(e,t){let a={init:function(e){$("#common-popups").prepend(this.$dom_element),t(this,e)},popup_name:"several_qol_common_popup",type:"common",$dom_element:$(`<div class="popup_wrapper"><div class="popup_background clickable"></div><div class="popup several-qol-popup" id="popup-${e}"><div class="container-special-bg" id="container-${e}"></div><close class="closable"></close></div></div>`),close_on_esc:!0,addEventListeners:function(){this.$dom_element.find("close, .popup_background").on("click",()=>{this.destroy()})},removeEventListeners(){},onOpen(){$("#common-popups").append(this.$dom_element)},onClose(){},destroy:function(){shared.PopupQueueManager.close({type:this.type})}};return shared.PopupQueueManager.add({popup:a}),a}},M=class extends y{constructor(){super(...arguments),this.configSchema={baseKey:"eventInfo",label:"<span tooltip='Click on the Information top right of event (only DP for now)'>Event Info (WIP): Show guides tips & tricks for events</span>",default:!0}}shouldRun(){return location.pathname.includes("/event.html")}run(){if(this.hasRun||!this.shouldRun())return;this.hasRun=!0,this.injectCSS();let e=new URLSearchParams(location.search).get("tab")?.replace(/_\d+$/,"");this.whichEventToCall(e)}injectCSS(){let e=(P(),r(v)).default;GM.addStyle(e)}whichEventToCall(e){e&&"dp_event"===e&&this.dp_eventRun()}dp_eventRun(){R.doWhenSelectorAvailable(".button-notification-action.notif_button_s",()=>{$(".button-notification-action.notif_button_s").attr("tooltip","Several QoL: More Info on this event").off("click").on("click",e=>{e.preventDefault(),e.stopPropagation(),H.createCommonPopup("event_info",(e,t)=>{e.$dom_element.find(".container-special-bg").append('<div class="banner">Several QoL - Event Info - DP</div><div class="event-content dp_event"><span>Before going\n into more details read <a href="https://forum.kinkoid.com/index.php?/topic/31207-vademecum-rerum-gestarum-ex-haremverse-a-guide-to-the-events/#comment-304655"><strong>this</strong></a> guide made by bolitho<br><br>There are important things to note for this event:<br>First there are some missions that are not in the daily missions list that can appear on easy & hard side :<br>- Claim chest n°X on daily missions (idk if you can land on a chest you already claimed)<br>- Claim X number of PoP<br>- Gain PoV potions<br>- Get shards<br>- Score points in contests<br><br>There\'s one that\'s <strong>really annoying</strong> that can only appear on the hard side:<br>- Restock market<br><br>One info not given is that a challenge cannot be the same on both easy & hard side as such try to lock an annoying mission on the hard side before you get stuck with "Restock Market"</span></div>')})})})}};new class{constructor(){this.allModules=[new x,new T,new S,new C,new k,new I,new E,new B,new L,new G,new j,new M],void 0!==unsafeWindow.hhPlusPlusConfig?this.run():Promise.race([new Promise(e=>{$(document).one("hh++-bdsm:loaded",()=>e("hh++-bdsm:loaded"))}),new Promise(e=>setTimeout(()=>e("timeout"),50))]).then(e=>{"hh++-bdsm:loaded"===e?this.run():this.runWithoutBdsm()})}run(){unsafeWindow.hhPlusPlusConfig.registerGroup({key:"severalQoL",name:"<span tooltip='By infarctus'>Several QoL</span>"}),location.pathname.includes("/home.html")?this.allModules.forEach(e=>{unsafeWindow.hhPlusPlusConfig.registerModule(e)}):this.allModules.forEach(e=>{e.shouldRun()&&unsafeWindow.hhPlusPlusConfig.registerModule(e)}),unsafeWindow.hhPlusPlusConfig.loadConfig(),unsafeWindow.hhPlusPlusConfig.runModules()}runWithoutBdsm(){this.allModules.forEach(e=>{try{let t=e.configSchema;if(e.shouldRun())if(t.subSettings){let a=t.subSettings.reduce((e,t)=>(e[t.key]=!0,e),{});e.run(a)}else e.run(void 0)}catch(t){console.error("Error running module",e,t)}})}}})();