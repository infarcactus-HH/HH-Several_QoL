// ==UserScript==
// @name         Several QoL
// @namespace    http://tampermonkey.net/
// @version      1.19.3
// @description  A userscript for QoL for the Haremverse
// @author       infarcactus
// @license      GPLv3
// @match        https://nutaku.haremheroes.com/*
// @match        https://*.hentaiheroes.com/*
// @match        https://*.gayharem.com/*
// @match        https://*.comixharem.com/*
// @match        https://*.hornyheroes.com/*
// @match        https://*.pornstarharem.com/*
// @match        https://*.transpornstarharem.com/*
// @match        https://*.gaypornstarharem.com/*
// @match        https://*.mangarpg.com/*
// @updateURL    https://github.com/infarcactus-HH/HH-Several_QoL/raw/refs/heads/main/dist/userscript.user.js
// @downloadURL  https://github.com/infarcactus-HH/HH-Several_QoL/raw/refs/heads/main/dist/userscript.user.js
// @grant        GM_addStyle
// @grant        GM_openInTab
// @grant        GM_getValue
// @grant        GM_setValue
// @grant        GM_deleteValue
// @grant        GM_info
// @grant        GM_listValues
// @grant        unsafeWindow
// @run-at       document-end
// ==/UserScript==

"use strict";(()=>{var e=class{constructor(){this.group="severalQoL",this.hasRun=!1}},t=class t extends e{constructor(){super(...arguments),this.configSchema={baseKey:"popupPlusPlus",label:"<span tooltip='Stacking popups, click on the popup to make it disappear'>Popup++</span>",default:!0}}static shouldRun(){return!0}run(){if(this.hasRun||!t.shouldRun())return;this.hasRun=!0,GM_addStyle("#toast-popups {display:inherit!important;}");let e={},a=null;delete shared.general.objectivePopup.show,shared.general.objectivePopup.show=function(t){if(null==this.LastPoints&&(this.LastPoints={}),t.objective_points&&!t.battle_result){if(!t.objective_points){let e=t.objective_points;if(Object.keys(this.pointsBox).length)for(let t in e)this.pointsBox[t]?this.pointsBox[t].name===e[t].name&&(this.pointsBox[t].points_gained+=e[t].points_gained):this.pointsBox[t]=e[t];else this.pointsBox=t.objective_points;t?.end?.rewards?.hasOwnProperty("lose")}!function(t,o){Object.keys(o).map(t=>{let a=o[t];e[a.title]||(e[a.title]={}),e[a.title][a.name]?e[a.title][a.name]+=a.points_gained:e[a.title][a.name]=a.points_gained});let i=$(`<div class="popup_wrapper"><div id="objective_popup" class="popup"><div class="noti_box"><div class="points">${Object.keys(e).map(t=>{let a=e[t],o=`<div class="row animate" style="transition: all 20ms;"><div class="contest_name">${t}:</div>`;for(let e in a){let t=a[e];o+=`<div class="contest_points"><div class="points_name" style="animation:none;">${e}: </div><div class="points_num" style="animation:none;"><div class="points_i" style="animation:none;">+${number_format_lang(t)}</div></div></div>`}return o+="</div>",o}).join("")}</div></div></div></div>`);$("#toast-popups .popup_wrapper").remove(),$("#toast-popups").css("display","unset"),$("#toast-popups"),$("#toast-popups").append(i),$("#toast-popups").css("display","unset"),a&&(clearTimeout(a),a=null),a=setTimeout(()=>{i.remove(),a=null,e={}},5e3),i.on("click.removePopup",function(){i.remove(),a=null,e={}})}(0,t.objective_points)}}}},a=class t extends e{constructor(){super(...arguments),this.configSchema={baseKey:"peopleToWiki",label:"People to Wiki(HH,GH,GPSH)",default:!1,subSettings:[{key:"infoBubbleNameToWiki",default:!0,label:"Info bubble name clickable to wiki"},{key:"portraitToWiki",default:!1,label:"Make portrait clickable to wiki"}]}}static shouldRun(){return location.host.includes("heroes")||location.host.includes("gayharem")||location.host.includes("gaypornstarharem")}run(e){this.hasRun||!t.shouldRun()||(this.hasRun=!0,e.infoBubbleNameToWiki&&$(document).on("click.InfoBubbleToWiki",".girl-information > .speech_bubble_info_icn",()=>{this.applyInfoBubbleToWiki(),$(document).off("click.InfoBubbleToWiki"),setInterval(()=>{this.applyInfoBubbleToWiki()},300)}),e.portraitToWiki&&setInterval(()=>{this.applyImageToWiki()},500))}applyInfoBubbleToWiki(){let e=this;$(".new_girl_info .girl_name_wrap > h5[style!='cursor: pointer;']").each(function(){let t=$(this);t.css("cursor","pointer"),t.on("click.InfoBubbleToWiki",function(){let a=t.attr("hh_title");if(!a)return;let o=a.replace(/ /g,"-");GM_openInTab(e.getWikiPageForCurrentGame(o),{active:!0})})})}applyImageToWiki(){let e=this;$(".slot_girl_shards > [data-new-girl-tooltip][style!='cursor: pointer;']").each(function(){let t=$(this),a=t.attr("data-new-girl-tooltip");if(!a)return;let o=a.match(/"name":"(.+)","rarity/);o&&o[1]&&(t.css("cursor","pointer"),t.on("click.ImgToWiki",function(t){t.stopPropagation();let a=o[1].replace(/ /g,"-");GM_openInTab(e.getWikiPageForCurrentGame(a),{active:!0})}))})}getWikiPageForCurrentGame(e){if(location.host.includes("heroes.com"))return`https://harem-battle.club/wiki/Harem-Heroes/HH:${e}`;if(location.host.includes("gayharem"))return`https://harem-battle.club/wiki/Gay-Harem/GH:${e}`;if(location.host.includes("gaypornstarharem"))return`https://harem-battle.club/wiki/Gay-Pornstar-Harem/GPSH:${e}`;throw new Error("Unsupported game for wiki link")}},o=class{static doWhenSelectorAvailable(e,t){let a=$(e);if(a.length)t(a);else{let a=new MutationObserver(()=>{let o=$(e);o.length&&(a.disconnect(),t(o))});a.observe(document.documentElement,{childList:!0,subtree:!0})}}static conditionalDoWhenSelectorAvailable(e,t,a){let o=$(t);if(e(o))a(o);else{let o=new MutationObserver(()=>{let i=$(t);e(i)&&(o.disconnect(),a(i))});o.observe(document.documentElement,{childList:!0,subtree:!0})}}},i=class{static setStoredScriptVersion(e){GM_setValue("StoredScriptVersion",e)}static getStoredScriptVersion(){return GM_getValue("StoredScriptVersion","0.0.0")}static setShowUpdatePopup(e){GM_setValue("ShowUpdatePopup",e)}static getShowUpdatePopup(){return GM_getValue("ShowUpdatePopup",!0)}},n=class{static setLeaguePLayerRecord(e){GM_setValue(HH_UNIVERSE+"LeaguePlayerRecord",e)}static getLeaguePlayerRecord(){return GM_getValue(HH_UNIVERSE+"LeaguePlayerRecord",{})}static setLeagueCurrentRank(e){GM_setValue(HH_UNIVERSE+"LeagueCurrentRank",e)}static getLeagueCurrentRank(){return GM_getValue(HH_UNIVERSE+"LeagueCurrentRank",-1)}},s=class{static setSMShopRefreshTimeComparedToServerTS(e){GM_setValue(HH_UNIVERSE+"SMShopRefreshTime",e)}static getSMShopRefreshTimeComparedToServerTS(){return GM_getValue(HH_UNIVERSE+"SMShopRefreshTime",0)}static setPoVEndTimeComparedToServerTS(e){GM_setValue(HH_UNIVERSE+"PoVEndTime",e)}static getPoVEndTimeComparedToServerTS(){return GM_getValue(HH_UNIVERSE+"PoVEndTime",0)}static setPoGEndTimeComparedToServerTS(e){GM_setValue(HH_UNIVERSE+"PoGEndTime",e)}static getPoGEndTimeComparedToServerTS(){return GM_getValue(HH_UNIVERSE+"PoGEndTime",0)}},r=class{static setTeamPreset(e){GM_setValue(HH_UNIVERSE+"LabyTeamPreset",e)}static getTeamPreset(){return GM_getValue(HH_UNIVERSE+"LabyTeamPreset",void 0)}},l=class{static setTeamPreset(e){GM_setValue(HH_UNIVERSE+"WBTTeamPreset",e)}static getTeamPreset(){return GM_getValue(HH_UNIVERSE+"WBTTeamPreset",void 0)}static setWBTId(e){GM_setValue(HH_UNIVERSE+"WBTId",e)}static getWBTId(){return GM_getValue(HH_UNIVERSE+"WBTId",-1)}},d=class{static setReducedLoveRaids(e){GM_setValue(HH_UNIVERSE+"ReducedLoveRaids",e)}static getReducedLoveRaids(){return GM_getValue(HH_UNIVERSE+"ReducedLoveRaids",[])}static setLoveRaidNotifications(e){GM_setValue(HH_UNIVERSE+"LoveRaidNotifications",e)}static getLoveRaidNotifications(){return GM_getValue(HH_UNIVERSE+"LoveRaidNotifications",[])}static setShouldHideCompletedRaids(e){GM_setValue("HideCompletedLoveRaids",e)}static getShouldHideCompletedRaids(){return GM_getValue("HideCompletedLoveRaids",!0)}},p=class{static setSessID(e){GM_setValue(location.hostname+"SessID",e)}static getSessID(){return GM_getValue(location.hostname+"SessID","")}static clearSessID(){GM_deleteValue(location.hostname+"SessID")}},c=class t extends e{constructor(){super(...arguments),this.configSchema={baseKey:"labyTeamPreset",label:"<span tooltip='Add a button to register laby team presets, and to apply it (also for WBT)'>Laby Team Preset</span>",default:!0},this.StorageHandlerTeam="/edit-labyrinth-team.html"===location.pathname?r:l}static shouldRun(){return"/edit-labyrinth-team.html"===location.pathname||"/edit-world-boss-team.html"===location.pathname||"/world-boss-pre-battle.html"===location.pathname}run(){this.hasRun||!t.shouldRun()||(this.hasRun=!0,this.migrateLocalStorageIfNeeded(),"/world-boss-pre-battle.html"===location.pathname?this.WBTPreBattlePageRun():this.editTeamPageRun())}WBTPreBattlePageRun(){let e=unsafeWindow.event_data?.id_world_boss_event;e&&e!==l.getWBTId()&&(o.doWhenSelectorAvailable("#perform_opponent.blue_button_L",()=>{$("#perform_opponent.blue_button_L").removeClass("blue_button_L").addClass("red_button_L").attr("tooltip","Set your WBT Team before continuing").text("Perform without saved team ?")}),l.setWBTId(e))}editTeamPageRun(){let e=$(".boss-bang-panel"),t=$('<button class="green_button_L" tooltip="Save preset for later runs">Save Preset</button>');t.on("click",()=>{this.saveCurrentPreset(),a.removeAttr("disabled")}),e.append(t);let a=$(`<button class="green_button_L" tooltip="Use previously saved preset & leave page" ${this.StorageHandlerTeam.getTeamPreset()?"":"disabled"}>Fill Preset</button>`);a.on("click",()=>{this.loadSavedPreset()}),o.doWhenSelectorAvailable(".change-team-panel .player-team .average-lvl",()=>{$(".change-team-panel .player-team .average-lvl").replaceWith(a)})}migrateLocalStorageIfNeeded(){let e="SeveralQoL_LabyTeamPreset",t=localStorage.getItem(e);t&&(r.setTeamPreset(JSON.parse(t)),localStorage.removeItem(e))}saveCurrentPreset(){let e={};$(".team-hexagon .team-member-container").each(function(){let t=$(this).attr("data-team-member-position"),a=$(this).attr("data-girl-id");$(this).is("[data-girl-id]")&&t&&a&&(e[t]=a)}),this.StorageHandlerTeam.setTeamPreset(e)}loadSavedPreset(){let e=this.StorageHandlerTeam.getTeamPreset();if(e)try{let t={class:"Hero",action:"edit_team",girls:e,battle_type:"/edit-labyrinth-team.html"===location.pathname?"labyrinth":"world_boss",id_team:unsafeWindow.teamId};shared.general.hh_ajax(t,e=>{shared.general.navigate(unsafeWindow.redirectUrl)})}catch(e){console.error("Failed to load preset:",e)}else console.warn("No saved preset found")}},u=class t extends e{constructor(){super(...arguments),this.configSchema={baseKey:"noAnnoyingPopups",label:"<span tooltip='Tired of shop popups or news popup appearing randomly and breaking your flow ?'>Removes annoying popup appearing automatically for shops, paths, news</span>",default:!1}}static shouldRun(){return!0}run(){this.hasRun||!t.shouldRun()||(this.hasRun=!0,document.cookie="disabledPopups=PassReminder,Bundles,News; path=/")}},h=class t extends e{constructor(){super(...arguments),this.configSchema={baseKey:"whaleBossTournament",label:"Renames WBT to Whale Boss Tournament",default:!1}}static shouldRun(){return location.pathname.includes("/home.html")}run(){this.hasRun||!t.shouldRun()||(this.hasRun=!0,o.doWhenSelectorAvailable(".world-boss .title",()=>{$(".world-boss .title").text("Whale Boss Tournament")}))}},m=class t extends e{constructor(){super(...arguments),this.configSchema={baseKey:"placesOfPowerPlusPlus",label:"<span tooltip='Global overhaul of PoPs especially for claiming & filling manually'>Places of Power++</span>",default:!0,subSettings:[{key:"rewardPopup",default:!0,label:"Show reward popup on PoP claim"}]},this.sortedGirlsCache={1:[],2:[],3:[]},this.isLoadingGirls=!1,this.currentPoPGirls={},this.minPercentToStartPoP=.05,this.hasPopupEnabled=!1,this.criteriaToClassMap={carac_1:1,carac_2:2,carac_3:3},this.idealPoPOrder=["1","2","3","13","14","15","7","8","9","4","5","6","16","17","18","22","23","24","19","20","21","10","11","12"]}static shouldRun(){return location.pathname.includes("/activities.html")&&!location.search.includes("?tab=pop&index=")&&void 0!==unsafeWindow.pop_data}run(e){if(this.hasRun||!t.shouldRun())return;this.hasPopupEnabled=e?.rewardPopup??!0,this.hasRun=!0;let a=$(".switch-tab[data-tab='pop']");a.contents()[0].nodeValue="Places of Power++",a.attr("tooltip","By infarctus"),a.on("click",async()=>{if(this.isLoadingGirls){for(shared.animations.loadingAnimation.start();this.isLoadingGirls;)await new Promise(e=>setTimeout(e,100));shared.animations.loadingAnimation.stop()}this.buildCustomPopInfo()}),this.injectCustomStyles(),Object.values(pop_data).find(e=>"can_start"===e.status||"pending_reward"===e.status),this.girlsHandler()}updateSuckless(){unsafeWindow.suckless&&unsafeWindow.suckless.parsePopData&&unsafeWindow.suckless.parsePopData(pop_data)}updateOtherScriptsPoPTrackedTime(){this.updateSuckless();let e="HHPlusPlusTrackedTimes";if(!localStorage.getItem(e))return;let t=JSON.parse(localStorage.getItem(e)||"{}");if(null==t.pop||null==t.popDuration)return;let a=Object.values(pop_data).map(({remaining_time:e,time_to_finish:t})=>({endAt:e,duration:t})).filter(({endAt:e})=>e).sort((e,t)=>e.endAt>t.endAt?1:-1)[0]||{endAt:0,duration:0},o=Math.floor(Date.now()/1e3);t.pop=o+a.endAt,t.popDuration=a.duration,localStorage.setItem(e,JSON.stringify(t))}createOrUpdateKobanButtons(){let e=!1,t=!1;for(let a of Object.values(pop_data))if("pending_reward"===a.status&&(e=!0),"can_start"===a.status&&(t=!0),e&&t)break;$(".pop-koban-buttons-container").length&&$(".pop-koban-buttons-container").remove();let a=$('<div class="pop-koban-buttons-container"></div>'),o=$(`<btn class="pop-koban-button pop-claim-all orange_button_L" price="${hh_prices_auto_claim}" ${e?"":"disabled"}><div class="action-label">Claim All</div><div class="action-cost"><div class="hc-cost"><span class="hard_currency_icn"></span>${hh_prices_auto_claim}</div></div></div>`),i=this;o.on("click",function(){let e=$(this);if(void 0!==e.attr("disabled"))return;let t=e.attr("price");shared.general.hc_confirm(t,()=>{shared.animations.loadingAnimation.start(),e.prop("disabled",!0),shared.general.hh_ajax({action:"pop_claim_all"},e=>{for(let e of Object.values(pop_data))"pending_reward"===e.status&&(delete i.currentPoPGirls[e.id_places_of_power],e.status="can_start");i.hasPopupEnabled&&shared.reward_popup.Reward.handlePopup(e.rewards),$(".pop-record .collect_notif").remove(),i.buildPopDetails("1"),$("pop-record").first().trigger("click"),shared.animations.loadingAnimation.stop()})})}),a.append(o);let n=$(`<btn class="pop-koban-button pop-fill-all orange_button_L" price="${hh_prices_auto_start}" ${t?"":"disabled"}><div class="action-label">Fill All</div><div class="action-cost"><div class="hc-cost"><span class="hard_currency_icn"></span>${hh_prices_auto_start}</div></div></div>`);n.on("click",function(){let e=$(this);if(void 0!==e.attr("disabled"))return;let t=e.attr("price");shared.general.hc_confirm(t,()=>{e.prop("disabled",!0),shared.general.hh_ajax({action:"pop_auto_start_all"},function(){e.prop("disabled",!1),location.reload()})})}),a.append(n),$("#pop_info").append(a)}convertCriteriaKey(e){return e.replace("_","")}assignGirlsToPoP(e){let t=Object.values(pop_data).find(t=>t.id_places_of_power===e);if(!t)return;let a=t.criteria,o=t.max_team_power;return this.selectOptimalGirls(e,o,a)}selectOptimalGirls(e,t,a){let o=this.convertCriteriaKey(a),i=this.criteriaToClassMap[a],n=this.sortedGirlsCache[i];if(0===n.length)return console.error(`[PoP ${e}] No girls available in storage!`),[];let s=new Set;for(let[t,a]of Object.entries(this.currentPoPGirls))parseInt(t)!==e&&a.forEach(e=>s.add(e));let r=[],l=t;for(let e of n){if(s.has(e))continue;let t=pop_hero_girls[e];if(!t)continue;let a=t[o];if(a<=l){if(l-=a,r.push(e),0===l)break}else if(0===r.length||l>0){let t=e;for(let a=n.indexOf(e)+1;a<n.length;a++){let e=n[a];if(s.has(e))continue;let i=pop_hero_girls[e];if(!i)continue;let r=i[o];if(r<=l){r===l&&(t=e);break}t=e}r.push(t);break}}return r}readdGirlsFromCurrentPoP(e){let t=parseInt(e);delete this.currentPoPGirls[t]}selectNextPoPFromFill(e){if(0===e.length)return;let t=e.nextAll().filter(function(){let e=$(this).data("pop-id"),t=pop_data[e];return!t.locked&&t&&"in_progress"!==t.status}).first();if(t.length)t.trigger("click");else if(t=$(".pop-record").filter(function(){let e=$(this).data("pop-id"),t=pop_data[e];return!t.locked&&t&&"in_progress"!==t.status}).first(),t.length)t.trigger("click");else{for(let e of Object.values(pop_data))if(!e.locked&&"in_progress"!==e.status)return void $(`[data-pop-id='${e.id_places_of_power}']`).trigger("click");$(".pop-record").first().trigger("click")}}selectNextPoPFromClaim(){let e=$(".pop-record.selected");if(0!==e.nextAll().find(".collect_notif").length)return void e.nextAll().find(".collect_notif").first().parent().trigger("click");let t=$(".pop-record").find(".collect_notif").first();if(t.length)t.parent().trigger("click");else{for(let e of Object.values(pop_data))if(!e.locked&&"can_start"===e.status)return void $(`[data-pop-id='${e.id_places_of_power}']`).trigger("click");$(".pop-record").first().trigger("click")}}sendClaimRequest(e){shared.animations.loadingAnimation.start();let t=parseInt(e);this.readdGirlsFromCurrentPoP(e);let a=pop_data[t];if($(".claimPoPButton").prop("disabled",!0),null===a.ends_in||0!==a.ends_in)$(".claimPoPButton").css("display","none"),$(".startPoPButton").css("display",""),a.status="can_start",a.ends_in=null,a.time_to_finish=0,$(".pop-record.selected .collect_notif").remove();else{let e=$(".pop-record.selected");this.selectNextPoPFromFill(e),delete pop_data[t],e.remove()}let o={namespace:"h\\PlacesOfPower",class:"standard"===a.type?"PlaceOfPower":"TempPlaceOfPower",action:"claim",id_place_of_power:a.id_places_of_power};delete this.currentPoPGirls[a.id_places_of_power],shared.general.hh_ajax(o,e=>{this.hasPopupEnabled&&shared.reward_popup.Reward.handlePopup(e.rewards),this.selectNextPoPFromClaim(),this.updateSuckless(),shared.animations.loadingAnimation.stop()})}calculateTimeToFinishSeconds(e,t){let a=this.convertCriteriaKey(e.criteria),o=0;for(let e of t){let t=pop_hero_girls[e];t&&(o+=t[a])}if(o>=e.max_team_power)return 21600;let i=e.level_power/o;return Math.floor(60*i)}sendFillRequest(e){shared.animations.loadingAnimation.start();let t=parseInt(e),a=pop_data[t];if("can_start"!==a.status)return;let o=a.id_places_of_power,i=this.assignGirlsToPoP(o)||[];if(this.currentPoPGirls[o]=i,0===i.length)return alert(`No ${GT.design.Girls} were assigned to this PoP. This might happen if all your ${GT.design.Girls} are already assigned to other PoPs.`),delete this.currentPoPGirls[o],void shared.animations.loadingAnimation.stop();let n=this.convertCriteriaKey(a.criteria),s=0;for(let e of i){let t=pop_hero_girls[e];t&&(s+=t[n])}if(s/a.max_team_power<this.minPercentToStartPoP)return alert("Not enough power to start this PoP."),delete this.currentPoPGirls[o],void shared.animations.loadingAnimation.stop();let r=this.calculateTimeToFinishSeconds(a,i);if(s<a.max_team_power&&!confirm(`Warning: This PoP is not fully maxed!\n\nCurrent Power: ${Math.floor(s)}\nMax Power: ${a.max_team_power}\n\nThis will take ${(r/60/60).toFixed(2)} hours to complete.\nDo you want to continue?`))return delete this.currentPoPGirls[o],$(".startPoPButton").css("display",""),$(".claimPoPButton").css("display","none"),void shared.animations.loadingAnimation.stop();$(".startPoPButton").css("display","none"),$(".claimPoPButton").css("display","");let l={namespace:"h\\PlacesOfPower",class:"standard"===a.type?"PlaceOfPower":"TempPlaceOfPower",action:"start",id_place_of_power:o,selected_girls:i},d=$('<div class="pop-timer"></div>'),p=shared.timer.buildTimer(r,"","pop-active-timer",!1);d.append(p),$(".pop-record.selected").append(d),pop_data[t].status="in_progress",pop_data[t].time_to_finish=r,pop_data[t].end_ts=r+Math.floor(Date.now()/1e3),shared.general.hh_ajax(l,e=>{shared.timer.activateTimers("pop-record.selected .pop-active-timer",()=>{}),this.selectNextPoPFromFill($(".pop-record.selected")),this.updateOtherScriptsPoPTrackedTime(),shared.animations.loadingAnimation.stop()})}buildPopDetails(e){let t=$(".pop-details-container");if(!t.length)return;let a=pop_data[parseInt(e)];if(!a)return;t.empty();let o=$('<div class="pop-details-left"></div>');t.append(o);let i=$("<img></img>");i.attr("src",a.girl?a.girl.avatar:IMAGES_URL+"/pictures/girls/1/avb0-1200x.webp?a=1"),o.append(i);let n=$('<div class="pop-navigation-buttons-original blue_button_L">Visit Original</div>');n.on("click",()=>{shared.general.navigate("/activities.html?tab=pop&index=")}),o.append(n);let s=$("<div class='pop-details-right'></div>");t.prepend(s);let r=$(`<a tooltip="Visit this PoP original page" class="pop-title" href="${shared.general.getDocumentHref("/activities.html?tab=pop&index="+a.id_places_of_power)}">${a.title}</div>`);s.append(r);let l=$('<div class="pop-rewards-container"></div>');for(let[e,t]of Object.entries(a.rewards))if(t.loot){let e=shared.reward.newReward.multipleSlot(t);l.append(e);break}s.append(l);let d=$(`<button class="purple_button_L claimPoPButton" ${"pending_reward"!=a.status?"disabled":""}>Claim</button>`);s.append(d),d.on("click",()=>{this.sendClaimRequest(e)});let p=$('<button class="blue_button_L startPoPButton">Fill & Start</button>');p.on("click",()=>{this.sendFillRequest(e)}),s.append(p),"can_start"!==a.status?p.css("display","none"):d.css("display","none"),this.createOrUpdateKobanButtons()}buildCustomPopInfo(){let e=$("#pop_info");if(!e.length)return;e.empty();let t=$('<div class="pop-details-container"></div>');e.append(t);let a=$('<div class="pop-records-container"></div>');Object.entries(pop_data).sort(([e,t],[a,o])=>{let i=String(t.id_places_of_power??e),n=String(o.id_places_of_power??a),s=this.idealPoPOrder.indexOf(i),r=this.idealPoPOrder.indexOf(n);return-1!==s||-1!==r?-1===s?1:-1===r?-1:s-r:Number(i)-Number(n)}).forEach(([e,t])=>{let o=t.locked||0,i=$(`<div class="${o?"pop-record-locked":"pop-record"}"></div>`);if(i.attr("data-pop-id",e),i.css("background-image",`url(${t.image})`),!o){i.on("click",()=>{$(".pop-record").removeClass("selected"),i.addClass("selected"),this.buildPopDetails(e)});let a=$(`<img src="https://hh.hh-content.com/pictures/misc/items_icons/${t.class}.png" class="pop-icon" />`);i.append(a);let o=$(`<div class="pop-lvl">Lv. ${t.level}</div>`);if(i.append(o),"in_progress"===t.status){let e=$('<div class="pop-timer"></div>'),a=shared.timer.buildTimer(t.remaining_time,"","pop-active-timer",!1);e.append(a),i.append(e)}if("pending_reward"===t.status){let e=$('<div class="collect_notif"></div>');i.append(e)}}a.append(i),i.attr("tooltip",t.title)}),e.append(a),0!==$(".pop-record").find(".collect_notif").length?$(".pop-record").find(".collect_notif").first().parent().trigger("click"):$(".pop-record").first().trigger("click"),shared.timer.activateTimers("pop-active-timer",e=>{let t=e.$dom_element.parent().parent().parent();t.hasClass("selected")&&$(".claimPoPButton").prop("disabled",!1);let a=t.data("pop-id");pop_data[a].status="pending_reward",pop_data[a].remaining_time=0,t.append('<div class="collect_notif"></div>')})}async injectCustomStyles(){GM_addStyle(".pop-details-container{position:absolute;top:60px;left:10px;width:685px;float:left;min-height:200px}.pop-details-left{position:absolute;width:300px;height:-webkit-fill-available}.pop-details-left img{height:800px;mask-image:linear-gradient(to top,transparent 45%,black 60%);overflow:clip;display:block}.pop-navigation-buttons-original{top:0!important;position:absolute!important;padding:2px 4px!important;font-size:10px!important}.pop-details-right{position:absolute;max-width:320px;width:320px;bottom:0;z-index:1}.pop-title{font-size:18px;font-weight:700;margin-bottom:5px;color:#ffb827;text-shadow:1px 1px 0 #000,-1px 1px 0 #000,-1px -1px 0 #000,1px -1px 0 #000;overflow:clip;white-space:nowrap;max-width:fit-content;display:block;text-overflow:ellipsis}.pop-rewards-container{display:flex;justify-content:space-between;max-width:320px}.claimPoPButton,.startPoPButton{margin-top:5px;width:-webkit-fill-available}#pop_info>.pop-records-container{display:grid;grid-template-columns:repeat(3,1fr);gap:15px;justify-content:end;width:640px;margin-bottom:10px;position:absolute;top:60px;right:15px}.pop-records-container>.pop-record{background-size:cover;background-position:center;position:relative;padding:6px;border-radius:3px;box-shadow:0 1px 3px #0000004d;cursor:pointer;height:-webkit-fill-available;width:auto}.pop-record-locked{filter:grayscale(1);background-size:cover;background-position:center;position:relative;padding:6px;border-radius:3px;box-shadow:0 1px 3px #0000004d;cursor:pointer;height:-webkit-fill-available;width:auto}.pop-record.selected{outline:2px solid #ffcc00!important;outline-offset:-2px;box-shadow:0 0 10px #ffcc0080!important}.pop-icon{position:absolute;top:5px;left:5px;width:20px;height:20px;filter:drop-shadow(0 0 1px rgba(0,0,0,.6)) drop-shadow(1px 1px 1px rgba(0,0,0,.6)) drop-shadow(-1px -1px 1px rgba(0,0,0,.6)) drop-shadow(1px -1px 1px rgba(0,0,0,.6)) drop-shadow(-1px 1px 1px rgba(0,0,0,.6))}.pop-lvl{position:absolute;top:5px;right:5px;background:#0009;font-size:14px;color:#ffb827;padding:0 3px}.pop-timer{position:absolute;bottom:5px;background:#000c;color:#fff;padding:1px 3px;border-radius:1px;font-size:10px}.collect_notif{position:absolute;bottom:3px;right:3px}#pop_info>.pop-koban-buttons-container{position:absolute;width:320px;display:flex;flex-direction:row;align-items:center;gap:10px;flex-wrap:nowrap;height:auto;top:8px;right:70px}.pop-koban-buttons-container>.pop-koban-button{display:flex;flex-direction:row;align-items:center;gap:20px;width:160px;padding:0 10px;margin-top:0}.pop-koban-button>.action-cost{display:flex;align-items:end;margin-left:auto}")}async girlsHandler(){this.isLoadingGirls=!0;let e={1:[],2:[],3:[]};for(let t of Object.values(pop_hero_girls))!t||null==t.id_girl||(e[1].push({id:t.id_girl,carac:t.carac1}),e[2].push({id:t.id_girl,carac:t.carac2}),e[3].push({id:t.id_girl,carac:t.carac3}),null!=t.id_places_of_power&&(this.currentPoPGirls[t.id_places_of_power]||(this.currentPoPGirls[t.id_places_of_power]=[]),this.currentPoPGirls[t.id_places_of_power].push(t.id_girl)));this.sortedGirlsCache[1]=e[1].sort((e,t)=>t.carac-e.carac).map(e=>e.id),this.sortedGirlsCache[2]=e[2].sort((e,t)=>t.carac-e.carac).map(e=>e.id),this.sortedGirlsCache[3]=e[3].sort((e,t)=>t.carac-e.carac).map(e=>e.id),this.isLoadingGirls=!1}},f=class t extends e{constructor(){super(...arguments),this.configSchema={baseKey:"noReloadFromClaimingDailyChests",label:"Activities : No reload from claiming daily chests",default:!0,subSettings:[{key:"popupEnabled",default:!0,label:"Show reward popup on claiming"}]}}static shouldRun(){return!0}run(e){if(this.hasRun||!t.shouldRun())return location.pathname.includes("/activities.html");this.hasRun=!0,$(".switch-tab[data-tab='daily_goals']").on("click",()=>{o.doWhenSelectorAvailable(".progress-bar-claim-reward",()=>{this.applyNoReloadFix(e.popupEnabled)})})}applyNoReloadFix(e){let t=this;$(".progress-bar-claim-reward").off("click").on("click",function(a){a.stopPropagation(),a.preventDefault(),$(this).prop("disabled",!0);let o=$(this).attr("tier");if(!o)return;let i={action:"claim_daily_goal_tier_reward",tier:o};daily_goals_member_progression.taken_rewards_array.push(o),shared.animations.loadingAnimation.start(),shared.general.hh_ajax(i,a=>{if(e){let e=a.rewards;shared.reward_popup.Reward.handlePopup(e)}else shared.Hero.updates(a.rewards.heroChangesUpdate,!1);t.checkIfAllChestsClaimed(),shared.animations.loadingAnimation.stop()})}),$(".progress-bar-claim-reward").attr("tooltip","Several QoL: Claim without reload"+(e?"":" & without popup"))}checkIfAllChestsClaimed(){daily_goals_member_progression.taken_rewards_array.length>=Math.min(Math.floor(daily_goals_member_progression.potions_amount/20),5)&&$('[data-tab="daily_goals"] > .collect_notif').remove()}},g=class t extends e{constructor(){super(...arguments),this.configSchema={baseKey:"meRankingInfo",label:"ME : Adds info about rankings in seasonal event",default:!0},this.heroData=null,this.leaderboardData=null}static shouldRun(){return location.pathname.includes("seasonal.html")}run(){this.hasRun||!t.shouldRun()||(this.hasRun=!0,this.injectCSS(),this.hookAjaxRequest())}async injectCSS(){GM_addStyle(".me-ranking-tooltip th,.me-ranking-tooltip td{border:1px solid #ccc;padding:5px;text-align:center}.me-leaderboard-info{position:absolute;right:13rem;width:20px}")}hookAjaxRequest(){$(document).ajaxComplete((e,t,a)=>{"action=leaderboard&feature=seasonal_event_top"===a?.data&&(this.heroData=t.responseJSON?.hero_data,this.leaderboardData=t.responseJSON?.leaderboard,this.hookSpecialHeroRow())})}hookSpecialHeroRow(){o.doWhenSelectorAvailable("#leaderboard_holder > #outer-hero-row",()=>{let e=this.createTooltipTableRankingContent(),t=$('<img class="me-leaderboard-info" src="https://hh.hh-content.com/leagues/ic_rankup.png" tooltip></img>');t.attr("hh_title",e),$("#leaderboard_holder > #outer-hero-row").append(t)})}createTooltipTableRankingContent(){if(!this.heroData||!this.leaderboardData)return"";let e=this.heroData.rank,t=this.heroData.potions,a='<div class="me-ranking-tooltip"><table style="border-collapse: collapse; width: 100%;"><thead><tr><th>Rank</th><th>Resource</th><th>Difference</th></tr></thead><tbody>',o=this.leaderboardData.find(t=>t.rank===e);return[10,50,100,250,500,1e3].forEach(e=>{let i=this.leaderboardData.find(t=>t.rank===e),n=i?.potions??"?",s="?",r="black";if(i){let e=t-i.potions;if(0===e){let e=o?o.id_member:1/0,t=i.id_member;e<t?(s="+0 (above)",r="green"):e>t?(s="+0 (below)",r="red"):(s="= (tie)",r="orange")}else s=e>0?`+${e}`:`${e}`,r=e>0?"green":"red"}a+=`<tr><td>${e}</td><td>${n}</td><td style="color: ${r}; font-weight: bold;">${s}</td></tr>`}),a+="</tbody></table></div>",a}},v=class t extends e{constructor(){super(...arguments),this.configSchema={baseKey:"leagueOpponentHistory",label:"League : Show history of opponents (click on the row to refresh, only looks for highest league)",default:!0},this.updatedPlayerRecordsThisSession=new Set}static shouldRun(){return location.pathname.includes("/leagues.html")}run(){this.hasRun||!t.shouldRun()||(this.hasRun=!0,this.injectCSS(),this.leaguePlayerRecord=n.getLeaguePlayerRecord(),o.doWhenSelectorAvailable(".league_table",()=>{this.applyRankingsToOpponentLists(),this.startObserverClickOnTable(),this.applyRankingsToTable()}),$(document).on("league:table-sorted",()=>{this.startObserverClickOnTable(),this.applyRankingsToTable()}))}async injectCSS(){GM_addStyle(".several-qol-bestrank-timesreached{margin-left:5px;display:flex;width:100%;align-items:center;text-shadow:1px 0 0 #000,0 1px 0 #000,-1px 0 0 #000,0 -1px 0 #000,1px 1px 0 #000,-1px -1px 0 #000,1px -1px 0 #000,-1px 1px 0 #000}.several-qol-bestrank-timesreached>.rank-container{background-size:cover;text-align:center;min-width:16px;max-width:32px;width:auto;height:16px;font-size:10px}.several-qol-bestrank-timesreached>.times-reached{margin-left:3px}.several-qol-top1{background:transparent radial-gradient(closest-side at 50% 50%,#f5a866,#ec0039 51%,#9e0e27) 0% 0% no-repeat padding-box}.several-qol-top4{background-image:url(/images/legendary.png)}.several-qol-top15{background:#ffb244}.several-qol-top30{background:#23b56b}.several-qol-top30plus{background:#8d8e9f}")}applyRankingsToOpponentLists(){void 0!==this.leaguePlayerRecord&&opponents_list.forEach(e=>{let t=e.player.id_fighter,a=this.leaguePlayerRecord[t];a&&(e.Several_QoL={chechExpiresAt:a.checkExpiresAt,bestPlace:a.bestPlace,timesReached:a.timesReached})})}startObserverClickOnTable(){let e=this;$(".league_table > .data-list > .body-row").on("click.SeveralQoL",function(){let t=parseInt($(this).children("[column='place']").text().trim()),a=opponents_list.find(e=>e.place===t);a?a.Several_QoL&&a.Several_QoL.chechExpiresAt>server_now_ts||e.updatedPlayerRecordsThisSession.has(a.player.id_fighter)||e.sendRequestAndAnalyzeOpponent(a.player.id_fighter,$(this)):console.warn("Could not find opponent for place ",t)})}sendRequestAndAnalyzeOpponent(e,t){let a={action:"fetch_hero",id:"profile",preview:!1,player_id:e},o=Object.keys(league_rewards).length,i=new RegExp(`<img src="https:\\/\\/.*?\\/pictures\\/design\\/leagues\\/${o}\\.png">\\n\\s*?<div class=\\"tier-stats\\">\\n\\s*?<div>Best place:\\s*<span>(\\d+)<sup>[^<]+<\\/sup><\\/span><\\/div>[\\s\\S]*?<div>Times reached: <span>(\\d+)<\\/span><\\/div>`,"g");shared.general.hh_ajax(a,a=>{let n=i.exec(a.html),s=n?parseInt(n[1]):null,r=n?parseInt(n[2]):null;if(this.updatedPlayerRecordsThisSession.add(e),!s||!r)return void console.warn(`Could not find league ${o} placement info for opponent id `,e);let l=this.leaguePlayerRecord[e];l&&l.bestPlace===s&&l.timesReached===r||(this.updateOpponentRecord(e,s,r),t.children("[column='nickname']").find(".several-qol-bestrank-timesreached").remove(),t.children("[column='nickname']").append(this.generateRankHtml(s,r)))})}updateOpponentRecord(e,t,a){this.leaguePlayerRecord[e]={bestPlace:t,timesReached:a,checkExpiresAt:server_now_ts+season_end_at+10},n.setLeaguePLayerRecord(this.leaguePlayerRecord)}applyRankingsToTable(){let e=$(".data-row.body-row");void 0!==this.leaguePlayerRecord&&e.each((e,t)=>{let a=parseInt($(t).children("[column='place']").text().trim());if(!a)return;let o=opponents_list.find(e=>e.place===a);if(!o)return;let i=o.player.id_fighter,n=this.leaguePlayerRecord[i];n&&!$(t).children("[column='nickname']").find(".several-qol-bestrank-timesreached").length&&$(t).children("[column='nickname']").append(this.generateRankHtml(n.bestPlace,n.timesReached))})}generateRankHtml(e,t){let a=$('<div class="several-qol-bestrank-timesreached"></div>'),o=$(`<span class="rank-container ${this.generateRankClass(e)}">${e}</span>`),i=$(`<span class="times-reached">x${t}</span>`);return a.prepend(o),a.append(i),a}generateRankClass(e){return 1==e?"several-qol-top1":e<=4?"several-qol-top4":e<=15?"several-qol-top15":e<=30?"several-qol-top30":"several-qol-top30plus"}},_=class t extends e{constructor(){super(...arguments),this.configSchema={baseKey:"leagueNoPlayerProfileOnNameClick",label:"League : Disable opening player profile when clicking on their name",default:!1}}static shouldRun(){return location.pathname.includes("/leagues.html")}run(){this.hasRun||!t.shouldRun()||(this.hasRun=!0,o.doWhenSelectorAvailable('.data-row.body-row .data-column[column="nickname"]',()=>{$("body").off("click",'.data-row.body-row .data-column[column="nickname"]')}),$(document).on("league:table-sorted",()=>{$("body").off("click",'.data-row.body-row .data-column[column="nickname"]')}))}},b=class{static createCommonPopup(e,t){let a={init:function(e){$("#common-popups").prepend(this.$dom_element),t(this,e)},popup_name:"several_qol_common_popup",type:"common",$dom_element:$(`<div class="popup_wrapper"><div class="popup_background clickable"></div><div class="popup several-qol-popup" id="popup-${e}"><div class="container-special-bg" id="container-${e}"></div><close class="closable"></close></div></div>`),close_on_esc:!0,addEventListeners:function(){this.$dom_element.find("close, .popup_background").on("click",()=>{this.destroy()})},removeEventListeners(){},onOpen(){$("#common-popups").append(this.$dom_element)},onClose(){},destroy:function(){shared.PopupQueueManager.close({type:this.type})}};return shared.PopupQueueManager.add({popup:a}),a}},w=".popup_wrapper>#popup-event_info{width:1020px;height:32rem;top:3rem;left:.62rem}#popup-event_info>#container-event_info.container-special-bg{display:flex;flex-direction:column;height:100%}#popup-event_info close{width:2.4rem;height:2.2rem;background-image:url(/images/clubs/ic_xCross.png);opacity:1}#container-event_info{width:100%;height:100%;box-shadow:none;border:2px solid #ff9900;align-content:center}#container-event_info>.banner{width:100%;height:3rem;font-size:1.8rem;font-weight:700;color:#ffb827;text-align:center;line-height:3rem;border-bottom:2px solid #ff9900;flex-shrink:0}#container-event_info>.event-content{flex:1 1 auto;padding:1rem;overflow:auto;text-align:left}#container-event_info strong{color:#ffb827}.severalQoL-event-shop-timer{margin-left:10px;width:min-content}.severalQoL-event-shop-timer>span{font-size:12px}",k=class{constructor(){this.EventInfoLinks={dp_event:"https://forum.kinkoid.com/index.php?/topic/31207-vademecum-rerum-gestarum-ex-haremverse-a-guide-to-the-events/#comment-304655",sm_event:"https://forum.kinkoid.com/index.php?/topic/31207-vademecum-rerum-gestarum-ex-haremverse-a-guide-to-the-events/#comment-309998",cumback_contest:"https://forum.kinkoid.com/index.php?/topic/31207-vademecum-rerum-gestarum-ex-haremverse-a-guide-to-the-events/#comment-304660",event:"https://forum.kinkoid.com/index.php?/topic/31207-vademecum-rerum-gestarum-ex-haremverse-a-guide-to-the-events/#comment-304653",legendary_contest:"https://forum.kinkoid.com/index.php?/topic/31207-vademecum-rerum-gestarum-ex-haremverse-a-guide-to-the-events/#comment-304657",mythic_event:"https://forum.kinkoid.com/index.php?/topic/23259-everything-about-mythic-days-revival/",path_event:"https://forum.kinkoid.com/index.php?/topic/31207-vademecum-rerum-gestarum-ex-haremverse-a-guide-to-the-events/#comment-304650",crazy_cumback_contest:"https://forum.kinkoid.com/index.php?/topic/31207-vademecum-rerum-gestarum-ex-haremverse-a-guide-to-the-events/#comment-304661"}}run(){let e=new URLSearchParams(location.search).get("tab")?.replace(/_\d+$/,"");this.injectCSS(),this.whichEventToCall(e)}async injectCSS(){GM_addStyle(w)}helperCreateNotifButton(e){let t=$('<div class="button-notification-action notif_button_s sm-event-info-button" tooltip="Several QoL: More Info on this event"></div>');return o.doWhenSelectorAvailable(".nc-panel-header .nc-pull-right",()=>{$(".nc-panel-header .nc-pull-right").prepend(t)}),t.off("click").on("click",t=>{GM_openInTab(this.EventInfoLinks[e],{active:!0})}),t}helperReplaceNotifButton(e,t=!1){o.doWhenSelectorAvailable(".nc-pull-right > .button-notification-action",()=>{$(".nc-pull-right > .button-notification-action").attr("tooltip","Several QoL: More Info on this event").off("click").on("click",a=>{t&&(a.preventDefault(),a.stopPropagation(),a.stopImmediatePropagation()),GM_openInTab(this.EventInfoLinks[e],{active:!0})})})}whichEventToCall(e){if(e)switch(e){case"cumback_contest":case"legendary_contest":case"event":case"path_event":case"crazy_cumback_contest":return void this.helperCreateNotifButton(e);case"mythic_event":return void this.mythic_eventRun();case"dp_event":return void this.dp_eventRun();case"sm_event":return void this.sm_eventRun();default:return}}mythic_eventRun(){o.doWhenSelectorAvailable(".nc-pull-right > .button-notification-action",()=>{$(".nc-pull-right > .button-notification-action").removeClass("js-mythic-help-open-button"),this.helperReplaceNotifButton("mythic_event")})}dp_eventRun(){o.doWhenSelectorAvailable(".button-notification-action.notif_button_s",()=>{$(".button-notification-action.notif_button_s").attr("tooltip","Several QoL: More Info on this event").off("click").on("click",e=>{e.preventDefault(),e.stopPropagation(),b.createCommonPopup("event_info",(e,t)=>{e.$dom_element.find(".container-special-bg").append(`<div class="banner">Several QoL - Event Info - DP</div><div class="event-content dp_event"><span>Before goinginto more details read <a target="_blank" href="${this.EventInfoLinks.dp_event}"><strong>this</strong></a> guide made by bolitho<br><br>There are important things to note for this event:<br>First there are some missions that are not in the daily missions list that can appear on easy & hard side :<br>- Claim chest n°X on daily missions (idk if you can land on a chest you already claimed)<br>- Claim X number of PoP<br>- Gain PoV potions<br>- Get shards<br>- Score points in contests<br><br>There's one that's <strong>really annoying</strong> that can only appear on the hard side:<br>- Restock the Market<br><br>One info not given is that a challenge cannot be the same on both easy & hard side as such try to lock an annoying mission on the hard side before you get stuck with "Restock the Market"</span></div>`)})})})}sm_eventRun(){this.helperReplaceNotifButton("sm_event");let e=unsafeWindow.sm_event_data,t=shared.timer.buildTimer(e.seconds_until_event_end,GT.design.event_ends_in,"event-timer nc-expiration-label",!1);$(".nc-pull-right").append(t),shared.timer.activateTimers("event-timer.nc-expiration-label"),$("#sultry-mysteries-tabs > #shop_tab").on("click.SeveralQoLEventInfo",function(){$(this).off("click.SeveralQoLEventInfo"),o.doWhenSelectorAvailable(".shop-timer.timer",()=>{let e=$(".shop-timer.timer").attr("data-time-stamp");if(!e||isNaN(Number(e)))return;let t=Number(e)+Math.floor(Date.now()/1e3);s.setSMShopRefreshTimeComparedToServerTS(t)})});let a=s.getSMShopRefreshTimeComparedToServerTS();if(a>server_now_ts){let e=shared.timer.buildTimer(a-server_now_ts,"","severalQoL-event-shop-timer nc-expiration-label",!1);$("#sultry-mysteries-tabs > #shop_tab").append(e),shared.timer.activateTimers("severalQoL-event-shop-timer.nc-expiration-label")}}},S=class{run(){this.injectCSS(),o.doWhenSelectorAvailable("[rel='path-of-valor']",()=>{this.PoVPoGHandler()}),this.SMEventHandler()}async injectCSS(){GM_addStyle(".timer-box .severalQoL-event-timer.expired{color:#f5252a}[rel=sm_event] .severalQoL-event-timer{padding-bottom:0!important}.severalQoL-PoVPoG-timer{position:absolute;left:6px}.potions-paths-buttons .severalQoL-PoVPoG-timer{bottom:-2px;left:8px}.severalQoL-PoVPoG-timer>p{font-size:12px;color:#8ec3ff}.potions-paths-buttons .severalQoL-PoVPoG-timer>p{font-size:10px;color:#8ec3ff}")}SMEventHandler(){let e=s.getSMShopRefreshTimeComparedToServerTS(),t=$("[rel='sm_event']").find(".timer-box");if(0==e||t)if(e>server_now_ts){let a=shared.timer.buildTimer(e-server_now_ts,GT.design.market_new_stock,"severalQoL-event-timer nc-expiration-label",!1);t.prepend(a),shared.timer.activateTimers("severalQoL-event-timer.nc-expiration-label")}else t.prepend(`<div class="severalQoL-event-timer expired">${GT.design.sm_event_restock_now}</div>`);else s.setSMShopRefreshTimeComparedToServerTS(0)}PoVPoGHandler(){let e=s.getPoVEndTimeComparedToServerTS(),t=s.getPoGEndTimeComparedToServerTS();function a(e,t,a){for(;e<server_now_ts;)e+=a;let o=shared.timer.buildTimer(e-server_now_ts,GT.design.event_ends_in,"severalQoL-PoVPoG-timer nc-expiration-label",!1);t.find(".white_text").append(o)}0!==e&&a(e,$("[rel='path-of-valor']"),1209600),0!==t&&a(t,$("[rel='path-of-glory']"),3024e3),shared.timer.activateTimers("severalQoL-PoVPoG-timer.nc-expiration-label",()=>{})}},P=class{run(){this.injectCSS();let e=+unsafeWindow.time_remaining;"/path-of-valor.html"===window.location.pathname?(s.setPoVEndTimeComparedToServerTS(server_now_ts+e),this.replacePoVNotifButton()):"/path-of-glory.html"===window.location.pathname&&(s.setPoGEndTimeComparedToServerTS(server_now_ts+e),this.replacePoGNotifButton())}async injectCSS(){GM_addStyle(w)}replacePoVNotifButton(){o.doWhenSelectorAvailable(".button-notification-action.notif_button_s",()=>{$(".button-notification-action.notif_button_s").attr("tooltip","Several QoL: More Info on this event").off("click").on("click",e=>{e.preventDefault(),e.stopImmediatePropagation(),GM_openInTab("https://forum.kinkoid.com/index.php?/topic/31207-vademecum-rerum-gestarum-ex-haremverse-a-guide-to-the-events/#comment-310477",{active:!0})})})}replacePoGNotifButton(){o.doWhenSelectorAvailable(".button-notification-action.notif_button_s",()=>{$(".button-notification-action.notif_button_s").attr("tooltip","Several QoL: More Info on this event").off("click").on("click",e=>{e.preventDefault(),e.stopImmediatePropagation(),GM_openInTab("https://forum.kinkoid.com/index.php?/topic/31207-vademecum-rerum-gestarum-ex-haremverse-a-guide-to-the-events/#comment-310673",{active:!0})})})}},y=class{constructor(){this.EventInfoSeasonalLinks=["https://forum.kinkoid.com/index.php?/topic/31207-vademecum-rerum-gestarum-ex-haremverse-a-guide-to-the-events/#comment-310475","https://forum.kinkoid.com/index.php?/topic/31207-vademecum-rerum-gestarum-ex-haremverse-a-guide-to-the-events/#comment-310068","https://forum.kinkoid.com/index.php?/topic/31207-vademecum-rerum-gestarum-ex-haremverse-a-guide-to-the-events/#comment-310473"]}run(){let e=unsafeWindow.event_functionalities?.id_seasonal_event_type;e&&this.EventInfoSeasonalLinks[e-1]&&this.replaceSeasonalNotifButton(this.EventInfoSeasonalLinks[e-1])}replaceSeasonalNotifButton(e){e&&o.doWhenSelectorAvailable(".button-notification-action.notif_button_s",()=>{$(".button-notification-action.notif_button_s").attr("tooltip","Several QoL: More Info on this event").off("click").on("click",t=>{t.preventDefault(),t.stopImmediatePropagation(),GM_openInTab(e,{active:!0})})})}},x=class t extends e{constructor(){super(...arguments),this.configSchema={baseKey:"eventInfo",label:"<span tooltip='Click on the Information top right of event (only Mythic, DP, SM, CbC, OD, PoV & PoG)'>Event Info (WIP): Show guides, tips, tricks & more info on events</span>",default:!0}}static shouldRun(){return"/event.html"===location.pathname||"/home.html"===location.pathname||"/path-of-glory.html"===location.pathname||"/path-of-valor.html"===location.pathname||"/seasonal.html"===location.pathname||"/world-boss-event"===location.pathname||"/season.html"===location.pathname||"/love-raids.html"===location.pathname}run(){if(!this.hasRun&&t.shouldRun())switch(this.hasRun=!0,location.pathname){case"/home.html":this.runHome();break;case"/event.html":this.runEvent();break;case"/path-of-glory.html":case"/path-of-valor.html":this.runPathes();break;case"/seasonal.html":this.runSeasonal();break;case"/season.html":this.runSeason();break;case"/love-raids.html":this.runLoveRaids()}}runHome(){(new S).run()}runEvent(){(new k).run()}runPathes(){(new P).run()}runSeasonal(){(new y).run()}runSeason(){this.helperReplaceNotifButton("https://forum.kinkoid.com/index.php?/topic/31207-vademecum-rerum-gestarum-ex-haremverse-a-guide-to-the-events/#comment-310674")}runLoveRaids(){this.helperReplaceNotifButton("https://forum.kinkoid.com/index.php?/topic/31207-vademecum-rerum-gestarum-ex-haremverse-a-guide-to-the-events/#comment-316577")}helperReplaceNotifButton(e){o.doWhenSelectorAvailable(".button-notification-action.notif_button_s",()=>{$(".button-notification-action.notif_button_s").attr("tooltip","Several QoL: More Info on this event").off("click").on("click",t=>{GM_openInTab(e,{active:!0})})})}},R=class e{static run(){let t=GM_info.script.version,a=i.getStoredScriptVersion();if(e.addOptionToHHPlusPlusConfig(),a===t)return;let[o,n,s]=a.split(".").map(Number);if(18===n&&i.getShowUpdatePopup()){if(!location.hostname.startsWith("nutaku"))return;e.injectCSS(),b.createCommonPopup("update-several-qol",(e,a)=>{let o=e.$dom_element.find(".container-special-bg");o.append($(`<div class="banner">Several QoL - Update to ${t}</div>`)),o.append($('<div class="changelog-content"><h2> New Feature : League show correct rank on home page </h2><p>This feature fixes the slowly update rank displayed on home page, to update it go to league page and it\'ll show the correct rank after.</p></div>'));let n=$('<div class="footer"><span>Thank you for using Several QoL! </span> <span style="margin-left:10px" tooltip="Won\'t be show often only on new features"> Show this popup:</span></div>'),s=$('<input name=\'severalQoL-show-update-popup\' type="checkbox" tooltip="Won\'t be show often only on new features" checked></input>');s.on("change",()=>{let e=s.prop("checked");i.setShowUpdatePopup(e)}),n.append(s),o.append(n)})}i.setStoredScriptVersion(t)}static async injectCSS(){GM_addStyle(".popup_wrapper>#popup-update-several-qol{width:1020px;height:32rem;top:3rem;left:.62rem}#popup-update-several-qol>#container-update-several-qol.container-special-bg{display:flex;flex-direction:column;height:100%}#popup-update-several-qol close{width:2.4rem;height:2.2rem;background-image:url(/images/clubs/ic_xCross.png);opacity:1}#container-update-several-qol{width:100%;height:100%;box-shadow:none;border:2px solid #ff9900;align-content:center}#container-update-several-qol>.banner{width:100%;height:3rem;font-size:1.8rem;font-weight:700;color:#ffb827;text-align:center;line-height:3rem;border-bottom:2px solid #ff9900;flex-shrink:0}#container-update-several-qol>.changelog-content{flex:1 1 auto;padding:1rem;overflow:auto;text-align:left}#container-update-several-qol>.footer{width:100%;height:3rem;font-size:1.4rem;font-weight:700;color:#ffb827;text-align:center;line-height:3rem;border-top:2px solid #ff9900;flex-shrink:0;display:flex;align-items:center;justify-content:center}#container-update-several-qol>.footer input[type=checkbox]{vertical-align:middle;margin-left:.5rem;height:-webkit-fill-available}#container-update-several-qol>.changelog-content h2{font-size:25px;color:#f5252a;margin-top:1rem;margin-bottom:.5rem}#container-update-several-qol>.changelog-content h3{font-size:20px;color:#ff6f61;margin-top:1rem;margin-bottom:.5rem}")}static addOptionToHHPlusPlusConfig(){let e=i.getShowUpdatePopup();o.doWhenSelectorAvailable(".hh-plus-plus-config-button"+(unsafeWindow.hhPlusPlusConfig?.BoobStrapped?".boob-strapped":":not(.boob-strapped)"),t=>{t.on("click.severalQoLAddConfig",()=>{t.off("click.severalQoLAddConfig"),o.doWhenSelectorAvailable(".group-panel[rel='severalQoL']",t=>{let a=$(`<div class="config-setting ${e?"enabled":""}"><label class="base-setting"><span tooltip="It will only appear for important update, or new features">Show update Popup</span></label></div>`),o=$(`<input type="checkbox" ${e?'checked="checked"':""}>`);a.find("label").append(o),o.on("change",()=>{e=!e,i.setShowUpdatePopup(e),e?a.addClass("enabled"):a.removeClass("enabled")}),t.children().first().append(a)})})})}},T=class t extends e{constructor(){super(...arguments),this.configSchema={baseKey:"loveRaids",label:"<span tooltip='Show mysterious raids, CSS tweaks, Hide completed raids ...'>Additional Love Raids tweaks</span>",default:!0,subSettings:[{key:"hideRaidCardsUntillStart",default:!1,label:'<span tooltip="Hides raids until they start (5min before starting they\'ll appear)">Hide raids cards until they start</span>'}]}}static shouldRun(){return location.pathname.includes("/home.html")||void 0!==unsafeWindow.love_raids&&love_raids?.length}run(e){if(!this.hasRun&&t.shouldRun())switch(this.hasRun=!0,location.pathname){case"/home.html":this.homePageModifications();break;case"/love-raids.html":this.loveRaidsPageModifications();break;default:o.doWhenSelectorAvailable("a.love-raid-container.raid",()=>{this.handleRaidCards(e.hideRaidCardsUntillStart)})}}handleRaidCards(e){void 0!==love_raids&&$("a.love-raid-container.raid").each(function(t,a){let o=URL.parse(a.href)?.searchParams?.get("raid");if(!o)return;let i=+o,n=love_raids.find(e=>e.id_raid===i);void 0!==n&&function(t,a){(t.all_is_owned||e&&"upcoming"===t.status&&t.seconds_until_event_start>300)&&a.remove()}(n,a)})}loveRaidsPageModifications(){if(void 0===love_raids)return;!async function(){GM_addStyle(`.notify-toggle {background-image: url(${IMAGES_URL}/ic_new.png);`),GM_addStyle("#love-raids .raid-card:not(.expanded) .raid-content .info-box{padding-top:0;top:4.8em}#love-raids .raid-card:not(.expanded).multiple-girl .raid-content .info-box .classic-girl:nth-of-type(2) div.shards-container{top:0}.notify-toggle{position:relative;display:inline-block;height:25px;width:25px;background-size:contain;background-repeat:no-repeat;background-position:center;opacity:.5;filter:grayscale(1)}.raid-name[data-notify=true] .notify-toggle{opacity:1;filter:grayscale(0)}.love-raids-hide-completed-btn>img{margin-left:10px;height:2rem;width:50px;vertical-align:middle;cursor:pointer}")}();let e=function(){let e=d.getLoveRaidNotifications(),t=e.filter(e=>love_raids.some(t=>t.id_raid===e));d.setLoveRaidNotifications(t);let a=love_raids.map(e=>{let t,a,{id_raid:o,all_is_owned:i}=e;if("ongoing"===e.status){let{seconds_until_event_end:o}=e;t=0,a=server_now_ts+o}else{let{event_duration_seconds:o,seconds_until_event_start:i}=e;t=server_now_ts+i,a=t+o}return{all_is_owned:i,id_raid:o,start:t,end:a}});return d.setReducedLoveRaids(a),{reducedLoveRaids:a,loveRaidNotifs:e}}().loveRaidNotifs;function t(e){e&&!$(e).find(".redirect_button").length&&$(e).find(".shards-container").append('<a class="redirect_button blue_button_L" disabled>Go</a>')}o.doWhenSelectorAvailable(".raid-card",()=>{(function(){let e,t=d.getShouldHideCompletedRaids();t&&(e=GM_addStyle(".raid-card.grey-overlay{display:none!important;}")),o.doWhenSelectorAvailable(".head-section > a",a=>{let o=$(`<div class="eye btn-control love-raids-hide-completed-btn" tooltip="Toggle hiding completed raids"><img src="${IMAGES_URL}/quest/${t?"ic_eyeopen":"ic_eyeclosed"}.svg"></div>`);a.after(o),o.on("click",()=>{t=!t,d.setShouldHideCompletedRaids(t),o.find("img").attr("src",`${IMAGES_URL}/quest/${t?"ic_eyeopen":"ic_eyeclosed"}.svg`),t?e=GM_addStyle(".raid-card.grey-overlay{display:none!important;}"):e?.remove()})})})(),o.doWhenSelectorAvailable(".raid-content > .eye.btn-control",()=>{$(".raid-content > .eye.btn-control").remove()}),o.doWhenSelectorAvailable(".raid-card",()=>{void 0!==love_raids&&$(".raid-card").each((t,a)=>{let i=love_raids[t];if(void 0===i)return void console.warn("love_raids data is undefined for index ",t);let n=$(a);return i.all_is_owned?void 0:(function(e,t){if("full"!==e.announcement_type_name&&"ongoing"!==e.status){let a=t.find(".girl-img.avatar");a.attr("src",`${IMAGES_URL}/pictures/girls/${e.id_girl}/ava0.png`),"hidden"===a.css("visibility")&&a.css("visibility","visible")}}(i,n),void o.doWhenSelectorAvailable(".raid-name > .type_icon",()=>{!function(t,a){let o=a.find(".raid-name");e.includes(t.id_raid)&&o.attr("data-notify","true");let i=$('<span tooltip="Toggle favorite (shows an indicator on home page when raid is ongoing)" class="notify-toggle"></span>');i.on("click",a=>{a.stopPropagation(),e.includes(t.id_raid)?(e=e.filter(e=>e!==t.id_raid),o.attr("data-notify","false")):(e.push(t.id_raid),o.attr("data-notify","true")),d.setLoveRaidNotifications(e)}),o.append(i)}(i,n)}))})}),unsafeWindow.HHPlusPlus?.Helpers?.getGirlDictionary().then(e=>{!function(e){if(void 0===love_raids)return;let a=love_raids.map(t=>e.get(t.id_girl.toString()));$(".raid-card").each((e,i)=>{if(!a[e])return;let n=$(i),{name:s,shards:r,skins:l}=a[e],{id_girl:d,girl_data:{grade_skins:p}}=love_raids[e],c=shared.general.getDocumentHref(`/characters/${d}`),u=unsafeWindow.HHPlusPlus.Helpers.getWikiLink(s,d,unsafeWindow.HHPlusPlus.I18n.getLang());if(p.length&&!i.classList.contains("multiple-girl")&&l){let e=l.filter(e=>33!==e.shards_count)[0],t=$(i.querySelector(".girl-img.left"));i.classList.add("multiple-girl"),i.classList.remove("single-girl"),n.find("div.raid-content").append($(`<div class="right-girl-container"><img class="girl-img right" src="${IMAGES_URL}/pictures/girls/${d}/grade_skins/grade_skin${e.num_order}.png" alt="Right" style="margin-top: ${t.css("marginTop")}"></div>`)),n.find(".info-box .info-container .classic-girl").after($(`<div class="classic-girl"><div class="shards-container"><div class="progress-container"><div class="shards_bar_wrapper"><div class="shards"><span class="skins_shard_icn"></span><p><span>${e.shards_count}/33</span></p></div><div class="shards_bar skins-shards"><div class="bar basic-progress-bar-fill pink" style="width: ${e.shards_count/33*100}%"></div></div></div></div><a href="" class="redirect_button blue_button_L" disabled="">Go</a></div><div class="border-bottom"></div></div>`))}let h=i.querySelectorAll(".classic-girl"),m=h[0],f=h[1];o.doWhenSelectorAvailable(".raid-name span span",()=>{n.find(".raid-name > span > span").first().text(`${s} ${GT.design.love_raid}`),n.find(".girl-name").html(`<a href="${u}" target="_blank">${s}</a>`)}),t(m),t(f);let g=i.querySelectorAll(".redirect_button");if(100===r&&(m&&(m.querySelector(".objective").innerText=GT.design.girl_town_event_owned_v2,g[0].removeAttribute("disabled"),g[0].href=c),f)){let e=f.querySelector(".shards_bar .bar")?.style?.width;e&&100===parseFloat(e)&&(g[1].removeAttribute("disabled"),g[1].href=c)}})}(e)})})}homePageModifications(){let e=d.getReducedLoveRaids(),t=d.getLoveRaidNotifications();o.doWhenSelectorAvailable(".raids",()=>{0!==e.length&&0!==t.length&&e.reduce((e,a)=>!!(a.start<server_now_ts&&a.end>server_now_ts&&t.includes(a.id_raid)&&!a.all_is_owned&&a.end>server_now_ts)||e,!1)&&$(".raids").append(`<img class="new_notif" src="${IMAGES_URL}/ic_new.png" style="position: relative;" alt="!">`),0!==e.length&&function(){let{ongoing_love_raids_count:t,upcoming_love_raids_count:a}=unsafeWindow,o=0,i=0,n=0;e.forEach(e=>{e.end<server_now_ts?o+=1:e.all_is_owned||(e.start<server_now_ts?i+=1:n+=1)});let s=e.length-o<t+a,r=$(".raids .raids-amount");r.first().html(`<span ${s?'style="color:pink"':""}>${i}</span> ${GT.design.love_raid}`),r.last().html(`<span ${s?'style="color:pink"':""}>${n}</span> ${GT.design.upcoming_love_raids}`)}()})}},L=class t extends e{constructor(){super(...arguments),this.configSchema={baseKey:"povPoGHideClaimAllUntilLastDay",label:"PoV/PoG: Hide 'Claim All' until last day",default:!1}}static shouldRun(){return"/path-of-glory.html"===location.pathname||"/path-of-valor.html"===location.pathname}run(){if(this.hasRun||!t.shouldRun())return;this.hasRun=!0;let e=unsafeWindow.time_remaining;void 0!==e&&e>84600&&this.injectCSS()}async injectCSS(){GM_addStyle(".potions-paths-tier>#claim-all{display:none}.potions-paths-tier.claim-all-rewards{width:19.5rem}")}},G=class t extends e{constructor(){super(...arguments),this.configSchema={baseKey:"fixSessID",label:"<span tooltip='For example when viewing some scenes'>[NUTAKU] Fix session in URLs</span>",default:location.hostname.startsWith("nutaku")}}static shouldRun(){return location.hostname.startsWith("nutaku")}run(){this.hasRun||!t.shouldRun()||(this.hasRun=!0,"/home.html"===location.pathname&&$(document).on("click.severalQoL_toggleFixSessID",'input[name="severalQoL_fixSessID"]',()=>{p.clearSessID()}),unsafeWindow.PLATFORM_SESS&&unsafeWindow.PLATFORM_COOKIELESS&&(p.setSessID(unsafeWindow.PLATFORM_SESS),$(document).on("click","#girl_preview_btn",()=>{o.doWhenSelectorAvailable(".scene-preview_wrapper.unlocked",e=>{e.each((e,t)=>{let a=$(t).find("img.scene-preview");0!==a.length&&a.attr("src",function(e,t){return t.includes("sess=")?t:t+`?sess=${unsafeWindow.PLATFORM_SESS}`})})})})))}},C=class t extends e{constructor(){super(...arguments),this.configSchema={baseKey:"leagueCorrectRankShowing",label:"<span tooltip='Go to League page to update'>League : Show correct rank on home page</span>",default:!0}}static shouldRun(){return"/leagues.html"===location.pathname||"/home.html"===location.pathname}run(){this.hasRun||!t.shouldRun()||(this.hasRun=!0,"/home.html"===location.pathname?this.updateDisplayedRank():"/leagues.html"===location.pathname&&this.fetchCurrentRank())}updateDisplayedRank(){let e=n.getLeagueCurrentRank();-1!==e&&o.doWhenSelectorAvailable('[rel="leaderboard"] .league-rank',t=>{t.text(`${GT.design.Rank} ${e}`)})}async fetchCurrentRank(){let e=unsafeWindow.opponents_list;if(!e)return;let t=e.find(e=>e.player.id_fighter===shared.Hero.infos.id);t&&n.setLeagueCurrentRank(t.place)}};new class{constructor(){if(this.allModules=[m,t,c,u,a,f,g,h,v,_,x,T,L,C],"/integrations/"!==location.pathname){if(location.hostname.startsWith("nutaku")&&(this.applySessionFix(),this.allModules.push(G)),void 0===unsafeWindow.hhPlusPlusConfig)return void Promise.race([new Promise(e=>{$(document).one("hh++-bdsm:loaded",()=>e("hh++-bdsm:loaded"))}),new Promise(e=>setTimeout(()=>e("timeout"),50))]).then(e=>{"hh++-bdsm:loaded"===e?this.runWithBDSM():this.runWithoutBdsm()});this.runWithBDSM(),this.run()}}runWithBDSM(){unsafeWindow.hhPlusPlusConfig.registerGroup({key:"severalQoL",name:"<span tooltip='By infarctus'>Several QoL</span>"}),location.pathname.includes("/home.html")?this.allModules.forEach(e=>{unsafeWindow.hhPlusPlusConfig.registerModule(new e)}):this.allModules.forEach(e=>{e.shouldRun()&&unsafeWindow.hhPlusPlusConfig.registerModule(new e)}),unsafeWindow.hhPlusPlusConfig.loadConfig(),unsafeWindow.hhPlusPlusConfig.runModules()}runWithoutBdsm(){this.allModules.forEach(e=>{if(null===e)return;let t=new e;try{let a=t.configSchema;if(e.shouldRun()&&a.default)try{if(a.subSettings){let e=a.subSettings.reduce((e,t)=>(e[t.key]=t.default,e),{});t.run(e)}else t.run(void 0)}catch(t){console.error("Error running module with subsettings",e,t)}}catch(t){console.error("Error running module",e,t)}})}applySessionFix(){if(!location.search.includes("sess=")&&""!=p.getSessID()){let e=p.getSessID();if(!e)return;let t=location.href+(location.href.includes("?")?"&":"?")+"sess="+e;window.location.href=t}}run(){R.run()}}})();