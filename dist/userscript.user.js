// ==UserScript==
// @name         Several QoL
// @namespace    http://tampermonkey.net/
// @version      1.14.2
// @description  A userscript for QoL for the Haremverse
// @author       infarcactus
// @license      GPLv3
// @match        https://nutaku.haremheroes.com/*
// @match        https://*.hentaiheroes.com/*
// @match        https://*.gayharem.com/*
// @match        https://*.comixharem.com/*
// @match        https://*.hornyheroes.com/*
// @match        https://*.pornstarharem.com/*
// @match        https://*.transpornstarharem.com/*
// @match        https://*.gaypornstarharem.com/*
// @match        https://*.mangarpg.com/*
// @updateURL    https://github.com/infarcactus-HH/HH-Several_QoL/raw/refs/heads/main/dist/userscript.user.js
// @downloadURL  https://github.com/infarcactus-HH/HH-Several_QoL/raw/refs/heads/main/dist/userscript.user.js
// @grant        GM.addStyle
// @grant        GM_addStyle
// @grant        GM.openInTab
// @grant        GM_getValue
// @grant        GM_setValue
// @grant        GM_deleteValue
// @grant        GM_info
// @grant        GM_listValues
// @grant        unsafeWindow
// @run-at       document-end
// ==/UserScript==

"use strict";(()=>{var e=Object.defineProperty,t=Object.getOwnPropertyDescriptor,o=Object.getOwnPropertyNames,a=Object.prototype.hasOwnProperty,i=(e,t)=>()=>(e&&(t=e(e=0)),t),n=(t,o)=>{for(var a in o)e(t,a,{get:o[a],enumerable:!0})},r=i=>((i,n,r,s)=>{if(n&&"object"==typeof n||"function"==typeof n)for(let r of o(n))!a.call(i,r)&&void 0!==r&&e(i,r,{get:()=>n[r],enumerable:!(s=t(n,r))||s.enumerable});return i})(e({},"__esModule",{value:!0}),i),s={};n(s,{default:()=>l});var l,p=i(()=>{l=".pop-details-container{position:absolute;top:60px;left:10px;width:685px;float:left;min-height:200px;}.pop-details-left{position:absolute;width:300px;height:-webkit-fill-available;}.pop-details-left img{height:800px;mask-image:linear-gradient(to top,transparent 45%,black 60%);overflow:clip;display:block;}.pop-navigation-buttons-original{top:0px !important;position:absolute !important;padding:2px 4px !important;font-size:10px !important;}.pop-details-right{position:absolute;max-width:320px;width:320px;bottom:0px;z-index:1;}.pop-title{font-size:18px;font-weight:bold;margin-bottom:5px;color:#ffb827;text-shadow:1px 1px 0 #000,-1px 1px 0 #000,-1px -1px 0 #000,1px -1px 0 #000;overflow:clip;white-space:nowrap;max-width:fit-content;display:block;text-overflow:ellipsis;}.pop-rewards-container{display:flex;justify-content:space-between;max-width:320px;}.claimPoPButton,.startPoPButton{margin-top:5px;width:-webkit-fill-available;}#pop_info > .pop-records-container{display:grid;grid-template-columns:repeat(3,1fr);gap:15px;justify-content:end;width:640px;margin-bottom:10px;position:absolute;top:60px;right:15px;}.pop-records-container > .pop-record{background-size:cover;background-position:center;position:relative;padding:6px;border-radius:3px;box-shadow:0 1px 3px rgba(0,0,0,0.3);cursor:pointer;height:-webkit-fill-available;width:auto;}.pop-record.selected{outline:2px solid #ffcc00 !important;outline-offset:-2px;box-shadow:0 0 10px rgba(255,204,0,0.5) !important;}.pop-icon{position:absolute;top:5px;left:5px;width:20px;height:20px;filter:drop-shadow(0 0 1px rgba(0,0,0,0.6)) drop-shadow(1px 1px 1px rgba(0,0,0,0.6)) drop-shadow(-1px -1px 1px rgba(0,0,0,0.6)) drop-shadow(1px -1px 1px rgba(0,0,0,0.6)) drop-shadow(-1px 1px 1px rgba(0,0,0,0.6));}.pop-lvl{position:absolute;top:5px;right:5px;background:rgba(0,0,0,0.6);font-size:14px;color:#ffb827;padding:0px 3px;}.pop-timer{position:absolute;bottom:5px;background:rgba(0,0,0,0.8);color:white;padding:1px 3px;border-radius:1px;font-size:10px;}.collect_notif{position:absolute;bottom:3px;right:3px;}#pop_info > .pop-koban-buttons-container{position:absolute;width:320px;display:flex;flex-direction:row;align-items:center;gap:10px;flex-wrap:nowrap;height:auto;top:8px;right:70px;}.pop-koban-buttons-container > .pop-koban-button{display:flex;flex-direction:row;align-items:center;gap:20px;width:160px;padding:0 10px;margin-top:0;}.pop-koban-button > .action-cost{display:flex;align-items:end;margin-left:auto;}"}),d={};n(d,{default:()=>c});var c,h=i(()=>{c=".me-ranking-tooltip th,.me-ranking-tooltip td{border:1px solid #ccc;padding:5px;text-align:center;}.me-leaderboard-info{position:absolute;right:13rem;width:20px;}"}),u={};n(u,{default:()=>m});var m,f=i(()=>{m=".several-qol-bestrank-timesreached{margin-left:5px;display:flex;width:100%;align-items:center;text-shadow:1px 0 0 #000,0 1px 0 #000,-1px 0 0 #000,0 -1px 0 #000,1px 1px 0 #000,-1px -1px 0 #000,1px -1px 0 #000,-1px 1px 0 #000;}.several-qol-bestrank-timesreached > .rank-container{background-size:cover;text-align:center;min-width:16px;max-width:32px;width:auto;height:16px;font-size:10px;}.several-qol-bestrank-timesreached > .times-reached{margin-left:3px;}.several-qol-top1{background:transparent radial-gradient(closest-side at 50% 50%,#f5a866 0%,#ec0039 51%,#9e0e27 100%) 0% 0% no-repeat padding-box;}.several-qol-top4{background-image:url(/images/legendary.png);}.several-qol-top15{background:#ffb244;}.several-qol-top30{background:#23b56b;}.several-qol-top30plus{background:#8d8e9f;}"}),g={};n(g,{default:()=>b});var b,v=i(()=>{b=".popup_wrapper > #popup-event_info{width:1020px;height:32rem;top:3rem;left:0.62rem;}#popup-event_info > #container-event_info.container-special-bg{display:flex;flex-direction:column;height:100%;}#popup-event_info close{width:2.4rem;height:2.2rem;background-image:url(/images/clubs/ic_xCross.png);opacity:1;}#container-event_info{width:100%;height:100%;box-shadow:none;border:2px solid #ff9900;align-content:center;}#container-event_info > .banner{width:100%;height:3rem;font-size:1.8rem;font-weight:bold;color:#ffb827;text-align:center;line-height:3rem;border-bottom:2px solid #ff9900;flex-shrink:0;}#container-event_info > .event-content{flex:1 1 auto;padding:1rem;overflow:auto;text-align:left;}#container-event_info strong{color:#FFB827;}.severalQoL-event-shop-timer{margin-left:10px;width:min-content;}.severalQoL-event-shop-timer > span{font-size:12px;}"}),_={};n(_,{default:()=>P});var P,w=i(()=>{P='.timer-box .severalQoL-event-timer.expired{color:#f5252a;}[rel="sm_event"] .severalQoL-event-timer{padding-bottom:0px !important;}.severalQoL-PoVPoG-timer{position:absolute;left:6px;}.potions-paths-buttons .severalQoL-PoVPoG-timer{bottom:-2px;left:8px;}.severalQoL-PoVPoG-timer > p{font-size:12px;color:#8EC3FF;}.potions-paths-buttons .severalQoL-PoVPoG-timer > p{font-size:10px;color:#8EC3FF;}'}),k=class{constructor(){this.group="severalQoL",this.hasRun=!1}},x=class extends k{constructor(){super(...arguments),this.configSchema={baseKey:"popupPlusPlus",label:"<span tooltip='Stacking popups,click on the popup to make it disappear'>Popup++</span>",default:!0}}shouldRun(){return!0}run(){if(this.hasRun||!this.shouldRun())return;this.hasRun=!0,GM.addStyle("#toast-popups {display:inherit!important;}");let e={},t=null;delete shared.general.objectivePopup.show,shared.general.objectivePopup.show=function(o){if(null==this.LastPoints&&(this.LastPoints={}),o.objective_points&&!o.battle_result){if(!o.objective_points){let e=o.objective_points;if(Object.keys(this.pointsBox).length)for(let t in e)this.pointsBox[t]?this.pointsBox[t].name===e[t].name&&(this.pointsBox[t].points_gained+=e[t].points_gained):this.pointsBox[t]=e[t];else this.pointsBox=o.objective_points;o?.end?.rewards?.hasOwnProperty("lose")}!function(o,a){let i=new Set;Object.keys(a).map(t=>{let o=a[t];if(e[t]){let a=o.points_gained;a>0&&i.add(t),e[t].points_gained+=a}else e[t]=o,o.points_gained>0&&i.add(t)});let n=$(`<div class="popup_wrapper"><div id="objective_popup" class="popup"><div class="noti_box"><div class="points">${Object.keys(e).map(t=>{let o=e[t];return`<div class="row animate" style="transition: all 20ms;"><div class="contest_name">${o.title}:</div><div class="contest_points"><div class="points_name" style="animation:none;">${o.name}: </div><div class="points_num" style="animation:none;"><div class="points_i" style="animation:none;">+${number_format_lang(o.points_gained)}</div></div></div></div>`}).join("")}</div></div></div></div></div>`);$("#toast-popups .popup_wrapper").remove(),$("#toast-popups").css("display","unset"),$("#toast-popups"),$("#toast-popups").append(n),$("#toast-popups").css("display","unset"),t&&(clearTimeout(t),t=null),t=setTimeout(()=>{n.remove(),t=null,e={}},5e3),n.on("click.removePopup",function(){n.remove(),t=null,e={}})}(0,o.objective_points)}}}},y=class extends k{constructor(){super(...arguments),this.configSchema={baseKey:"peopleToWiki",label:"People to Wiki(HH,GH,GPSH)",default:!1,subSettings:[{key:"infoBubbleNameToWiki",default:!0,label:"Info bubble name clickable to wiki"},{key:"portraitToWiki",default:!1,label:"Make portrait clickable to wiki"}]}}shouldRun(){return location.host.includes("heroes")||location.host.includes("gayharem")||location.host.includes("gaypornstarharem")}run(e){this.hasRun||!this.shouldRun()||(this.hasRun=!0,e?.infoBubbleNameToWiki&&setInterval(()=>{this.applyInfoBubbleToWiki()},500),e?.portraitToWiki&&setInterval(()=>{this.applyImageToWiki()},500))}applyInfoBubbleToWiki(){let e=this;$(".new_girl_info .girl_name_wrap > h5[style!='cursor: pointer;']").each(function(){let t=$(this);t.css("cursor","pointer"),t.on("click.InfoBubbleToWiki",function(){let o=t.attr("hh_title");if(!o)return;let a=o.replace(/ /g,"-");GM.openInTab(e.getWikiPageForCurrentGame(a),{active:!0})})})}applyImageToWiki(){let e=this;$(".slot_girl_shards > [data-new-girl-tooltip][style!='cursor: pointer;']").each(function(){let t=$(this),o=t.attr("data-new-girl-tooltip");if(!o)return;let a=o.match(/"name":"(.+)","rarity/);a&&a[1]&&(t.css("cursor","pointer"),t.on("click.ImgToWiki",function(t){t.stopPropagation();let o=a[1].replace(/ /g,"-");GM.openInTab(e.getWikiPageForCurrentGame(o),{active:!0})}))})}getWikiPageForCurrentGame(e){if(location.host.includes("heroes.com"))return`https://harem-battle.club/wiki/Harem-Heroes/HH:${e}`;if(location.host.includes("gayharem"))return`https://harem-battle.club/wiki/Gay-Harem/GH:${e}`;if(location.host.includes("gaypornstarharem"))return`https://harem-battle.club/wiki/Gay-Pornstar-Harem/GPSH:${e}`;throw new Error("Unsupported game for wiki link")}},S=class{static doWhenSelectorAvailable(e,t){if($(e).length)t();else{let o=new MutationObserver(()=>{$(e).length&&(o.disconnect(),t())});o.observe(document.documentElement,{childList:!0,subtree:!0})}}},T=class{static setStoredScriptVersion(e){GM_setValue("StoredScriptVersion",e)}static getStoredScriptVersion(){return GM_getValue("StoredScriptVersion","0.0.0")}static setLeaguePLayerRecord(e){GM_setValue(HH_UNIVERSE+"LeaguePlayerRecord",e)}static getLeaguePlayerRecord(){return GM_getValue(HH_UNIVERSE+"LeaguePlayerRecord",{})}},R=class{static setSMShopRefreshTimeComparedToServerTS(e){GM_setValue(HH_UNIVERSE+"SMShopRefreshTime",e)}static getSMShopRefreshTimeComparedToServerTS(){return GM_getValue(HH_UNIVERSE+"SMShopRefreshTime",0)}static setPoVEndTimeComparedToServerTS(e){GM_setValue(HH_UNIVERSE+"PoVEndTime",e)}static getPoVEndTimeComparedToServerTS(){return GM_getValue(HH_UNIVERSE+"PoVEndTime",0)}static setPoGEndTimeComparedToServerTS(e){GM_setValue(HH_UNIVERSE+"PoGEndTime",e)}static getPoGEndTimeComparedToServerTS(){return GM_getValue(HH_UNIVERSE+"PoGEndTime",0)}},G=class{static setTeamPreset(e){GM_setValue(HH_UNIVERSE+"LabyTeamPreset",e)}static getTeamPreset(){return GM_getValue(HH_UNIVERSE+"LabyTeamPreset",void 0)}},C=class{static setTeamPreset(e){GM_setValue(HH_UNIVERSE+"WBTTeamPreset",e)}static getTeamPreset(){return GM_getValue(HH_UNIVERSE+"WBTTeamPreset",void 0)}},L=class extends k{constructor(){super(...arguments),this.configSchema={baseKey:"labyTeamPreset",label:"<span tooltip='Add a button to register laby team presets, and to apply it (also for WBT)'>Laby Team Preset</span>",default:!0},this.StorageHandlerTeam="/edit-labyrinth-team.html"===location.pathname?G:C}shouldRun(){return"/edit-labyrinth-team.html"===location.pathname||"/edit-world-boss-team.html"===location.pathname}run(){if(this.hasRun||!this.shouldRun())return;this.hasRun=!0,this.migrateLocalStorageIfNeeded();let e=$(".boss-bang-panel"),t=$('<button class="green_button_L" tooltip="Save preset for later runs">Save Preset</button>');t.on("click",()=>{this.saveCurrentPreset(),o.removeAttr("disabled")}),e.append(t);let o=$(`<button class="green_button_L" tooltip="Use previously saved preset & leave page" ${this.StorageHandlerTeam.getTeamPreset()?"":"disabled"}>Fill Preset</button>`);o.on("click",()=>{this.loadSavedPreset()}),S.doWhenSelectorAvailable(".change-team-panel .player-team .average-lvl",()=>{$(".change-team-panel .player-team .average-lvl").replaceWith(o)})}migrateLocalStorageIfNeeded(){let e="SeveralQoL_LabyTeamPreset",t=localStorage.getItem(e);t&&(G.setTeamPreset(JSON.parse(t)),localStorage.removeItem(e))}saveCurrentPreset(){let e={};$(".team-hexagon .team-member-container").each(function(){let t=$(this).attr("data-team-member-position"),o=$(this).attr("data-girl-id");$(this).is("[data-girl-id]")&&t&&o&&(e[t]=o)}),this.StorageHandlerTeam.setTeamPreset(e)}loadSavedPreset(){let e=this.StorageHandlerTeam.getTeamPreset();if(e)try{let t={class:"Hero",action:"edit_team",girls:e,battle_type:"/edit-labyrinth-team.html"===location.pathname?"labyrinth":"world_boss",id_team:unsafeWindow.teamId};shared.general.hh_ajax(t,e=>{shared.general.navigate(unsafeWindow.redirectUrl)})}catch(e){console.error("Failed to load preset:",e)}else console.warn("No saved preset found")}},E=class extends k{constructor(){super(...arguments),this.configSchema={baseKey:"noAnnoyingPopups",label:"<span tooltip='Tired of shop popups or news popup appearing randomly and breaking your flow ?'>Removes annoying popup appearing automaticly for shops, paths, news</span>",default:!1}}shouldRun(){return!0}run(){this.hasRun||!this.shouldRun()||(this.hasRun=!0,document.cookie="disabledPopups=PassReminder,Bundles,News; path=/")}},M=class extends k{constructor(){super(...arguments),this.configSchema={baseKey:"whaleBossTournament",label:"Renames WBT to Whale Boss Tournament",default:!1}}shouldRun(){return location.pathname.includes("/home.html")}run(){this.hasRun||!this.shouldRun()||(this.hasRun=!0,S.doWhenSelectorAvailable(".world-boss .title",()=>{$(".world-boss .title").text("Whale Boss Tournament")}))}},I=class extends k{constructor(){super(...arguments),this.configSchema={baseKey:"placesOfPowerPlusPlus",label:"<span tooltip='Global overhaul of PoPs especially for claiming & filling manually'>Places of Power++</span>",default:!0,subSettings:[{key:"rewardPopup",default:!0,label:"Show reward popup on PoP claim"}]},this.sortedGirlsCache={1:[],2:[],3:[]},this.isLoadingGirls=!1,this.currentPoPGirls={},this.minPercentToStartPoP=.05,this.hasPopupEnabled=!1,this.criteriaToClassMap={carac_1:1,carac_2:2,carac_3:3},this.idealPoPOrder=["1","2","3","13","14","15","7","8","9","4","5","6","16","17","18","22","23","24","19","20","21","10","11","12"]}shouldRun(){return location.pathname.includes("/activities.html")&&!location.search.includes("?tab=pop&index=")}run(e){if(this.hasRun||!this.shouldRun())return;this.hasPopupEnabled=e?.rewardPopup??!0,this.hasRun=!0;let t=$(".switch-tab[data-tab='pop']");t.contents()[0].nodeValue="Places of Power++",t.attr("tooltip","By infarctus"),t.on("click",async()=>{if(this.isLoadingGirls){for(shared.animations.loadingAnimation.start();this.isLoadingGirls;)await new Promise(e=>setTimeout(e,100));shared.animations.loadingAnimation.stop()}this.buildCustomPopInfo()}),this.injectCustomStyles(),Object.values(pop_data).find(e=>"can_start"===e.status)&&this.girlsHandler()}updateSuckless(){unsafeWindow.suckless&&unsafeWindow.suckless.parsePopData&&unsafeWindow.suckless.parsePopData(pop_data)}updateOtherScriptsPoPTrackedTime(){this.updateSuckless();let e="HHPlusPlusTrackedTimes";if(!localStorage.getItem(e))return;let t=JSON.parse(localStorage.getItem(e)||"{}");if(null==t.pop||null==t.popDuration)return;if(0!=t.pop)return;let o=Object.values(pop_data).map(({remaining_time:e,time_to_finish:t})=>({endAt:e,duration:t})).filter(({endAt:e})=>e).sort((e,t)=>e.endAt>t.endAt?1:-1)[0]||{endAt:0,duration:0},a=Math.floor(Date.now()/1e3);t.pop=a+o.endAt,t.popDuration=o.duration,localStorage.setItem(e,JSON.stringify(t))}createOrUpdateKobanButtons(){let e=!1,t=!1;for(let o of Object.values(pop_data))if("pending_reward"===o.status&&(e=!0),"can_start"===o.status&&(t=!0),e&&t)break;$(".pop-koban-buttons-container").length&&$(".pop-koban-buttons-container").remove();let o=$('<div class="pop-koban-buttons-container"></div>'),a=$(`<btn class="pop-koban-button pop-claim-all orange_button_L" price="${hh_prices_auto_claim}" ${e?"":"disabled"}><div class="action-label">Claim All</div><div class="action-cost"><div class="hc-cost"><span class="hard_currency_icn"></span>${hh_prices_auto_claim}</div></div></div>`),i=this;a.on("click",function(){let e=$(this);if(void 0!==e.attr("disabled"))return;let t=e.attr("price");shared.general.hc_confirm(t,()=>{shared.animations.loadingAnimation.start(),e.prop("disabled",!0),shared.general.hh_ajax({action:"pop_claim_all"},e=>{for(let e of Object.values(pop_data))"pending_reward"===e.status&&(delete i.currentPoPGirls[e.id_places_of_power],e.status="can_start");i.hasPopupEnabled&&shared.reward_popup.Reward.handlePopup(e.rewards),$(".pop-record .collect_notif").remove(),i.buildPopDetails("1"),$("pop-record").first().trigger("click"),shared.animations.loadingAnimation.stop()})})}),o.append(a);let n=$(`<btn class="pop-koban-button pop-fill-all orange_button_L" price="${hh_prices_auto_start}" ${t?"":"disabled"}><div class="action-label">Fill All</div><div class="action-cost"><div class="hc-cost"><span class="hard_currency_icn"></span>${hh_prices_auto_start}</div></div></div>`);n.on("click",function(){let e=$(this);if(void 0!==e.attr("disabled"))return;let t=e.attr("price");shared.general.hc_confirm(t,()=>{e.prop("disabled",!0),shared.general.hh_ajax({action:"pop_auto_start_all"},function(){e.prop("disabled",!1),location.reload()})})}),o.append(n),$("#pop_info").append(o)}convertCriteriaKey(e){return e.replace("_","")}assignGirlsToPoP(e){let t=Object.values(pop_data).find(t=>t.id_places_of_power===e);if(!t)return;let o=t.criteria,a=t.max_team_power;return this.selectOptimalGirls(e,a,o)}selectOptimalGirls(e,t,o){let a=this.convertCriteriaKey(o),i=this.criteriaToClassMap[o],n=this.sortedGirlsCache[i];if(0===n.length)return console.error(`[PoP ${e}] No girls available in storage!`),[];let r=new Set;for(let[t,o]of Object.entries(this.currentPoPGirls))parseInt(t)!==e&&o.forEach(e=>r.add(e));let s=[],l=t;for(let e of n){if(r.has(e))continue;let t=pop_hero_girls[e];if(!t)continue;let o=t[a];if(o<=l){if(l-=o,s.push(e),0===l)break}else if(0===s.length||l>0){let t=e;for(let o=n.indexOf(e)+1;o<n.length;o++){let e=n[o];if(r.has(e))continue;let i=pop_hero_girls[e];if(!i)continue;let s=i[a];if(s<=l){s===l&&(t=e);break}t=e}s.push(t);break}}return s}readdGirlsFromCurrentPoP(e){let t=parseInt(e);delete this.currentPoPGirls[t]}selectNextPoPFromFill(e){if(0===e.length)return;let t=e.nextAll().filter(function(){let e=$(this).data("pop-id");return pop_data[e]&&"in_progress"!==pop_data[e].status}).first();if(t.length)t.trigger("click");else if(t=$(".pop-record").filter(function(){let e=$(this).data("pop-id");return pop_data[e]&&"in_progress"!==pop_data[e].status}).first(),t.length)t.trigger("click");else{for(let e of Object.values(pop_data))if("in_progress"!==e.status)return void $(`[data-pop-id='${e.id_places_of_power}']`).trigger("click");$(".pop-record").first().trigger("click")}}selectNextPoPFromClaim(){let e=$(".pop-record.selected");if(0!==e.nextAll().find(".collect_notif").length)return void e.nextAll().find(".collect_notif").first().parent().trigger("click");let t=$(".pop-record").find(".collect_notif").first();if(t.length)t.parent().trigger("click");else{for(let e of Object.values(pop_data))if("can_start"===e.status)return void $(`[data-pop-id='${e.id_places_of_power}']`).trigger("click");$(".pop-record").first().trigger("click")}}sendClaimRequest(e){shared.animations.loadingAnimation.start();let t=parseInt(e);this.readdGirlsFromCurrentPoP(e);let o=pop_data[t];if($(".claimPoPButton").prop("disabled",!0),null===o.ends_in||0!==o.ends_in)$(".claimPoPButton").css("display","none"),$(".startPoPButton").css("display",""),pop_data[t].status="can_start",pop_data[t].ends_in=null,$(".pop-record.selected .collect_notif").remove();else{let e=$(".pop-record.selected");this.selectNextPoPFromFill(e),delete pop_data[t],e.remove()}let a={namespace:"h\\PlacesOfPower",class:"standard"===o.type?"PlaceOfPower":"TempPlaceOfPower",action:"claim",id_place_of_power:o.id_places_of_power};delete this.currentPoPGirls[o.id_places_of_power],shared.general.hh_ajax(a,e=>{this.hasPopupEnabled&&shared.reward_popup.Reward.handlePopup(e.rewards),this.selectNextPoPFromClaim(),this.updateSuckless(),shared.animations.loadingAnimation.stop()})}calculateTimeToFinishSeconds(e,t){let o=this.convertCriteriaKey(e.criteria),a=0;for(let e of t){let t=pop_hero_girls[e];t&&(a+=t[o])}if(a>=e.max_team_power)return 21600;let i=e.level_power/a;return Math.floor(60*i)}sendFillRequest(e){shared.animations.loadingAnimation.start();let t=parseInt(e),o=pop_data[t];if("can_start"!==o.status)return;let a=o.id_places_of_power,i=this.assignGirlsToPoP(a)||[];if(this.currentPoPGirls[a]=i,0===i.length)return alert(`No ${GT.design.girl} were assigned to this PoP. This might happen if all your ${GT.design.girl} are already assigned to other PoPs.`),delete this.currentPoPGirls[a],void shared.animations.loadingAnimation.stop();let n=this.convertCriteriaKey(o.criteria),r=0;for(let e of i){let t=pop_hero_girls[e];t&&(r+=t[n])}if(r/o.max_team_power<this.minPercentToStartPoP)return alert("Not enough power to start this PoP."),delete this.currentPoPGirls[a],void shared.animations.loadingAnimation.stop();let s=this.calculateTimeToFinishSeconds(o,i);if(r<o.max_team_power&&!confirm(`Warning: This PoP is not fully maxed!\n\nCurrent Power: ${Math.floor(r)}\nMax Power: ${o.max_team_power}\n\nThis will take ${(s/60/60).toFixed(2)} hours to complete.\nDo you want to continue?`))return delete this.currentPoPGirls[a],$(".startPoPButton").css("display",""),$(".claimPoPButton").css("display","none"),void shared.animations.loadingAnimation.stop();$(".startPoPButton").css("display","none"),$(".claimPoPButton").css("display","");let l={namespace:"h\\PlacesOfPower",class:"standard"===o.type?"PlaceOfPower":"TempPlaceOfPower",action:"start",id_place_of_power:a,selected_girls:i},p=$('<div class="pop-timer"></div>'),d=shared.timer.buildTimer(s,"","pop-active-timer",!1);p.append(d),$(".pop-record.selected").append(p),pop_data[t].status="in_progress",pop_data[t].time_to_finish=s,pop_data[t].end_ts=s+Math.floor(Date.now()/1e3),shared.general.hh_ajax(l,e=>{shared.timer.activateTimers("pop-record.selected .pop-active-timer",()=>{}),this.selectNextPoPFromFill($(".pop-record.selected")),this.updateOtherScriptsPoPTrackedTime(),shared.animations.loadingAnimation.stop()})}buildPopDetails(e){let t=$(".pop-details-container");if(!t.length)return;let o=pop_data[parseInt(e)];if(!o)return;t.empty();let a=$('<div class="pop-details-left"></div>');t.append(a);let i=$("<img></img>");i.attr("src",o.girl?o.girl.avatar:IMAGES_URL+"/pictures/girls/1/avb0-1200x.webp?a=1"),a.append(i);let n=$('<div class="pop-navigation-buttons-original blue_button_L">Visit Original</div>');n.on("click",()=>{shared.general.navigate("/activities.html?tab=pop&index=")}),a.append(n);let r=$("<div class='pop-details-right'></div>");t.prepend(r);let s=$(`<a tooltip="Visit this PoP original page" class="pop-title" href="${shared.general.getDocumentHref("/activities.html?tab=pop&index="+o.id_places_of_power)}">${o.title}</div>`);r.append(s);let l=$('<div class="pop-rewards-container"></div>');for(let[e,t]of Object.entries(o.rewards))if(t.loot){let e=shared.reward.newReward.multipleSlot(t);l.append(e);break}r.append(l);let p=$(`<button class="purple_button_L claimPoPButton" ${"pending_reward"!=o.status?"disabled":""}>Claim</button>`);r.append(p),p.on("click",()=>{this.sendClaimRequest(e)});let d=$('<button class="blue_button_L startPoPButton">Fill & Start</button>');d.on("click",()=>{this.sendFillRequest(e)}),r.append(d),"can_start"!==o.status?d.css("display","none"):p.css("display","none"),this.createOrUpdateKobanButtons()}buildCustomPopInfo(){let e=$("#pop_info");if(!e.length)return;e.empty();let t=$('<div class="pop-details-container"></div>');e.append(t);let o=$('<div class="pop-records-container"></div>');Object.entries(pop_data).sort(([e,t],[o,a])=>{let i=String(t.id_places_of_power??e),n=String(a.id_places_of_power??o),r=this.idealPoPOrder.indexOf(i),s=this.idealPoPOrder.indexOf(n);return-1!==r||-1!==s?-1===r?1:-1===s?-1:r-s:Number(i)-Number(n)}).forEach(([e,t])=>{let a=$('<div class="pop-record"></div>');a.attr("data-pop-id",e),a.css("background-image",`url(${t.image})`),a.on("click",()=>{$(".pop-record").removeClass("selected"),a.addClass("selected"),this.buildPopDetails(e)});let i=$(`<img src="https://hh.hh-content.com/pictures/misc/items_icons/${t.class}.png" class="pop-icon" />`);a.append(i);let n=$(`<div class="pop-lvl">Lv. ${t.level}</div>`);if(a.append(n),"in_progress"===t.status){let e=$('<div class="pop-timer"></div>'),o=shared.timer.buildTimer(t.remaining_time,"","pop-active-timer",!1);e.append(o),a.append(e)}if("pending_reward"===t.status){let e=$('<div class="collect_notif"></div>');a.append(e)}o.append(a),a.attr("tooltip",t.title)}),e.append(o),0!==$(".pop-record").find(".collect_notif").length?$(".pop-record").find(".collect_notif").first().parent().trigger("click"):$(".pop-record").first().trigger("click"),shared.timer.activateTimers("pop-active-timer",e=>{let t=e.$dom_element.parent().parent().parent();t.hasClass("selected")&&$(".claimPoPButton").prop("disabled",!1);let o=t.data("pop-id");pop_data[o].status="pending_reward",t.append('<div class="collect_notif"></div>')})}injectCustomStyles(){let e=(p(),r(s)).default;GM.addStyle(e)}async girlsHandler(){this.isLoadingGirls=!0;let e={1:[],2:[],3:[]};for(let t of Object.values(pop_hero_girls))!t||null==t.id_girl||(e[1].push({id:t.id_girl,carac:t.carac1}),e[2].push({id:t.id_girl,carac:t.carac2}),e[3].push({id:t.id_girl,carac:t.carac3}),null!=t.id_places_of_power&&(this.currentPoPGirls[t.id_places_of_power]||(this.currentPoPGirls[t.id_places_of_power]=[]),this.currentPoPGirls[t.id_places_of_power].push(t.id_girl)));this.sortedGirlsCache[1]=e[1].sort((e,t)=>t.carac-e.carac).map(e=>e.id),this.sortedGirlsCache[2]=e[2].sort((e,t)=>t.carac-e.carac).map(e=>e.id),this.sortedGirlsCache[3]=e[3].sort((e,t)=>t.carac-e.carac).map(e=>e.id),this.isLoadingGirls=!1}},O=class extends k{constructor(){super(...arguments),this.configSchema={baseKey:"noReloadFromClaimingDailyChests",label:"Activities : No reload from claiming daily chests",default:!0}}shouldRun(){return!0}run(){if(this.hasRun||!this.shouldRun())return location.pathname.includes("/activities.html");this.hasRun=!0,$(".switch-tab[data-tab='daily_goals']").on("click",()=>{S.doWhenSelectorAvailable(".progress-bar-claim-reward",()=>{this.applyNoReloadFix()})})}applyNoReloadFix(){let e=this;$(".progress-bar-claim-reward").off("click").on("click",function(t){t.stopPropagation(),t.preventDefault(),$(this).prop("disabled",!0);let o=$(this).attr("tier");if(!o)return;let a={action:"claim_daily_goal_tier_reward",tier:o};daily_goals_member_progression.taken_rewards_array.push(o),shared.general.hh_ajax(a,t=>{let o=t.rewards;shared.reward_popup.Reward.handlePopup(o),e.checkIfAllChestsClaimed()})}),$(".progress-bar-claim-reward").attr("tooltip","Several QoL: Claim without reload")}checkIfAllChestsClaimed(){daily_goals_member_progression.taken_rewards_array.length>=Math.min(Math.floor(daily_goals_member_progression.potions_amount/20),5)&&$('[data-tab="daily_goals"] > .collect_notif').remove()}},H=class extends k{constructor(){super(...arguments),this.configSchema={baseKey:"meRankingInfo",label:"ME : Adds info about rankings in seasonal event",default:!0},this.heroData=null,this.leaderboardData=null}shouldRun(){return location.pathname.includes("seasonal.html")}run(){this.hasRun||!this.shouldRun()||(this.hasRun=!0,this.injectCSS(),this.hookAjaxRequest())}async injectCSS(){let e=(h(),r(d)).default;GM.addStyle(e)}hookAjaxRequest(){$(document).ajaxComplete((e,t,o)=>{"action=leaderboard&feature=seasonal_event_top"===o?.data&&(this.heroData=t.responseJSON?.hero_data,this.leaderboardData=t.responseJSON?.leaderboard,this.hookSpecialHeroRow())})}hookSpecialHeroRow(){S.doWhenSelectorAvailable("#leaderboard_holder > #outer-hero-row",()=>{let e=this.createTooltipTableRankingContent(),t=$('<img class="me-leaderboard-info" src="https://hh.hh-content.com/leagues/ic_rankup.png" tooltip></img>');t.attr("hh_title",e),$("#leaderboard_holder > #outer-hero-row").append(t)})}createTooltipTableRankingContent(){if(!this.heroData||!this.leaderboardData)return"";let e=this.heroData.rank,t=this.heroData.potions,o='<div class="me-ranking-tooltip"><table style="border-collapse: collapse; width: 100%;"><thead><tr><th>Rank</th><th>Resource</th><th>Difference</th></tr></thead><tbody>',a=this.leaderboardData.find(t=>t.rank===e);return[10,50,100,250,500,1e3].forEach(e=>{let i=this.leaderboardData.find(t=>t.rank===e),n=i?.potions??"?",r="?",s="black";if(i){let e=t-i.potions;if(0===e){let e=a?a.id_member:1/0,t=i.id_member;e<t?(r="+0 (above)",s="green"):e>t?(r="+0 (below)",s="red"):(r="= (tie)",s="orange")}else r=e>0?`+${e}`:`${e}`,s=e>0?"green":"red"}o+=`<tr><td>${e}</td><td>${n}</td><td style="color: ${s}; font-weight: bold;">${r}</td></tr>`}),o+="</tbody></table></div>",o}},B=class extends k{constructor(){super(...arguments),this.configSchema={baseKey:"leagueOpponentHistory",label:"League : Show history of opponents (click on the row to refresh, only looks for highest league)",default:!0},this.updatedPlayerRecordsThisSession=new Set}shouldRun(){return location.pathname.includes("/leagues.html")}run(){this.hasRun||!this.shouldRun()||(this.hasRun=!0,this.injectCSS(),this.leaguePlayerRecord=T.getLeaguePlayerRecord(),S.doWhenSelectorAvailable(".league_table",()=>{this.applyRankingsToOpponentLists(),this.startObserverClickOnTable(),this.applyRankingsToTable()}),$(document).on("league:table-sorted",()=>{this.startObserverClickOnTable(),this.applyRankingsToTable()}))}async injectCSS(){let e=(f(),r(u)).default;GM.addStyle(e)}applyRankingsToOpponentLists(){void 0!==this.leaguePlayerRecord&&opponents_list.forEach(e=>{let t=e.player.id_fighter,o=this.leaguePlayerRecord[t];o&&(e.Several_QoL={chechExpiresAt:o.checkExpiresAt,bestPlace:o.bestPlace,timesReached:o.timesReached})})}startObserverClickOnTable(){let e=this;$(".league_table > .data-list > .body-row").on("click.SeveralQoL",function(){let t=parseInt($(this).children("[column='place']").text().trim()),o=opponents_list.find(e=>e.place===t);o?o.Several_QoL&&o.Several_QoL.chechExpiresAt>server_now_ts||e.updatedPlayerRecordsThisSession.has(o.player.id_fighter)||e.sendRequestAndAnalyzeOpponent(o.player.id_fighter,$(this)):console.warn("Could not find opponent for place ",t)})}sendRequestAndAnalyzeOpponent(e,t){let o={action:"fetch_hero",id:"profile",preview:!1,player_id:e},a=Object.keys(league_rewards).length,i=new RegExp(`<img src="https:\\/\\/.*?\\/pictures\\/design\\/leagues\\/${a}\\.png">\\n\\s*?<div class=\\"tier-stats\\">\\n\\s*?<div>Best place:\\s*<span>(\\d+)<sup>[^<]+<\\/sup><\\/span><\\/div>[\\s\\S]*?<div>Times reached: <span>(\\d+)<\\/span><\\/div>`,"g");shared.general.hh_ajax(o,o=>{let n=i.exec(o.html),r=n?parseInt(n[1]):null,s=n?parseInt(n[2]):null;if(this.updatedPlayerRecordsThisSession.add(e),!r||!s)return void console.warn(`Could not find league ${a} placement info for opponent id `,e);let l=this.leaguePlayerRecord[e];l&&l.bestPlace===r&&l.timesReached===s||(this.updateOpponentRecord(e,r,s),t.children("[column='nickname']").find(".several-qol-bestrank-timesreached").remove(),t.children("[column='nickname']").append(this.generateRankHtml(r,s)))})}updateOpponentRecord(e,t,o){this.leaguePlayerRecord[e]={bestPlace:t,timesReached:o,checkExpiresAt:server_now_ts+season_end_at+10},T.setLeaguePLayerRecord(this.leaguePlayerRecord)}applyRankingsToTable(){let e=$(".data-row.body-row");void 0!==this.leaguePlayerRecord&&e.each((e,t)=>{let o=parseInt($(t).children("[column='place']").text().trim());if(!o)return;let a=opponents_list.find(e=>e.place===o);if(!a)return;let i=a.player.id_fighter,n=this.leaguePlayerRecord[i];n&&!$(t).children("[column='nickname']").find(".several-qol-bestrank-timesreached").length&&$(t).children("[column='nickname']").append(this.generateRankHtml(n.bestPlace,n.timesReached))})}generateRankHtml(e,t){let o=$('<div class="several-qol-bestrank-timesreached"></div>'),a=$(`<span class="rank-container ${this.generateRankClass(e)}">${e}</span>`),i=$(`<span class="times-reached">x${t}</span>`);return o.prepend(a),o.append(i),o}generateRankClass(e){return 1==e?"several-qol-top1":e<=4?"several-qol-top4":e<=15?"several-qol-top15":e<=30?"several-qol-top30":"several-qol-top30plus"}},W=class extends k{constructor(){super(...arguments),this.configSchema={baseKey:"leagueNoPlayerProfileOnNameClick",label:"League : Disable opening player profile when clicking on their name",default:!1}}shouldRun(){return location.pathname.includes("/leagues.html")}run(){this.hasRun||!this.shouldRun()||(this.hasRun=!0,S.doWhenSelectorAvailable('.data-row.body-row .data-column[column="nickname"]',()=>{$("body").off("click",'.data-row.body-row .data-column[column="nickname"]')}),$(document).on("league:table-sorted",()=>{$("body").off("click",'.data-row.body-row .data-column[column="nickname"]')}))}},N=class{static createCommonPopup(e,t){let o={init:function(e){$("#common-popups").prepend(this.$dom_element),t(this,e)},popup_name:"several_qol_common_popup",type:"common",$dom_element:$(`<div class="popup_wrapper"><div class="popup_background clickable"></div><div class="popup several-qol-popup" id="popup-${e}"><div class="container-special-bg" id="container-${e}"></div><close class="closable"></close></div></div>`),close_on_esc:!0,addEventListeners:function(){this.$dom_element.find("close, .popup_background").on("click",()=>{this.destroy()})},removeEventListeners(){},onOpen(){$("#common-popups").append(this.$dom_element)},onClose(){},destroy:function(){shared.PopupQueueManager.close({type:this.type})}};return shared.PopupQueueManager.add({popup:o}),o}},A=class{constructor(){this.EventInfoLinks={dp_event:"https://forum.kinkoid.com/index.php?/topic/31207-vademecum-rerum-gestarum-ex-haremverse-a-guide-to-the-events/#comment-304655",sm_event:"https://forum.kinkoid.com/index.php?/topic/31207-vademecum-rerum-gestarum-ex-haremverse-a-guide-to-the-events/#comment-309998",cumback_contest:"https://forum.kinkoid.com/index.php?/topic/31207-vademecum-rerum-gestarum-ex-haremverse-a-guide-to-the-events/#comment-304660",event:"https://forum.kinkoid.com/index.php?/topic/31207-vademecum-rerum-gestarum-ex-haremverse-a-guide-to-the-events/#comment-304653",legendary_contest:"https://forum.kinkoid.com/index.php?/topic/31207-vademecum-rerum-gestarum-ex-haremverse-a-guide-to-the-events/#comment-304657"}}run(){let e=new URLSearchParams(location.search).get("tab")?.replace(/_\d+$/,"");this.injectCSS(),this.whichEventToCall(e)}async injectCSS(){let e=(v(),r(g)).default;GM_addStyle(e)}helperCreateNotifButton(e){let t=$('<div class="button-notification-action notif_button_s sm-event-info-button" tooltip="Several QoL: More Info on this event"></div>');return S.doWhenSelectorAvailable(".nc-panel-header .nc-pull-right",()=>{$(".nc-panel-header .nc-pull-right").prepend(t)}),t.off("click").on("click",t=>{GM.openInTab(this.EventInfoLinks[e],{active:!0})}),t}helperReplaceNotifButton(e){S.doWhenSelectorAvailable(".button-notification-action.notif_button_s",()=>{$(".button-notification-action.notif_button_s").attr("tooltip","Several QoL: More Info on this event").off("click").on("click",t=>{GM.openInTab(this.EventInfoLinks[e],{active:!0})})})}whichEventToCall(e){if(e)switch(e){case"dp_event":return void this.dp_eventRun();case"sm_event":return void this.sm_eventRun();case"cumback_contest":return void this.helperCreateNotifButton("cumback_contest");case"event":this.helperCreateNotifButton("event");case"legendary_contest":this.helperCreateNotifButton("legendary_contest");default:return}}dp_eventRun(){S.doWhenSelectorAvailable(".button-notification-action.notif_button_s",()=>{$(".button-notification-action.notif_button_s").attr("tooltip","Several QoL: More Info on this event").off("click").on("click",e=>{e.preventDefault(),e.stopPropagation(),N.createCommonPopup("event_info",(e,t)=>{e.$dom_element.find(".container-special-bg").append(`<div class="banner">Several QoL - Event Info - DP</div><div class="event-content dp_event"><span>Before going\n into more details read <a target="_blank" href="${this.EventInfoLinks.dp_event}"><strong>this</strong></a> guide made by bolitho<br><br>There are important things to note for this event:<br>First there are some missions that are not in the daily missions list that can appear on easy & hard side :<br>- Claim chest n°X on daily missions (idk if you can land on a chest you already claimed)<br>- Claim X number of PoP<br>- Gain PoV potions<br>- Get shards<br>- Score points in contests<br><br>There's one that's <strong>really annoying</strong> that can only appear on the hard side:<br>- Restock the Market<br><br>One info not given is that a challenge cannot be the same on both easy & hard side as such try to lock an annoying mission on the hard side before you get stuck with "Restock the Market"</span></div>`)})})})}sm_eventRun(){this.helperReplaceNotifButton("sm_event");let e=unsafeWindow.sm_event_data,t=shared.timer.buildTimer(e.seconds_until_event_end,GT.design.event_ends_in,"event-timer nc-expiration-label",!1);$(".nc-pull-right").append(t),shared.timer.activateTimers("event-timer.nc-expiration-label"),$("#sultry-mysteries-tabs > #shop_tab").on("click.SeveralQoLEventInfo",function(){$(this).off("click.SeveralQoLEventInfo"),S.doWhenSelectorAvailable(".shop-timer.timer",()=>{let e=$(".shop-timer.timer").attr("data-time-stamp");if(!e||isNaN(Number(e)))return;let t=Number(e)+Math.floor(Date.now()/1e3);R.setSMShopRefreshTimeComparedToServerTS(t)})});let o=R.getSMShopRefreshTimeComparedToServerTS();if(o>server_now_ts){let e=shared.timer.buildTimer(o-server_now_ts,"","severalQoL-event-shop-timer nc-expiration-label",!1);$("#sultry-mysteries-tabs > #shop_tab").append(e),shared.timer.activateTimers("severalQoL-event-shop-timer.nc-expiration-label")}}},V=class{run(){this.injectCSS(),S.doWhenSelectorAvailable("[rel='path-of-valor']",()=>{this.PoVPoGHandler()}),this.SMEventHandler()}async injectCSS(){let e=(w(),r(_)).default;GM_addStyle(e)}SMEventHandler(){let e=R.getSMShopRefreshTimeComparedToServerTS(),t=$("[rel='sm_event']").find(".timer-box");if(0==e||t)if(e>server_now_ts){let o=shared.timer.buildTimer(e-server_now_ts,GT.design.market_new_stock,"severalQoL-event-timer nc-expiration-label",!1);t.prepend(o),shared.timer.activateTimers("severalQoL-event-timer.nc-expiration-label")}else t.prepend(`<div class="severalQoL-event-timer expired">${GT.design.sm_event_restock_now}</div>`);else R.setSMShopRefreshTimeComparedToServerTS(0)}PoVPoGHandler(){localStorage.removeItem("HHsucklessPoV"),localStorage.removeItem("HHsucklessPoG");let e=R.getPoVEndTimeComparedToServerTS(),t=R.getPoGEndTimeComparedToServerTS();function o(e,t,o){for(;e<server_now_ts;)e+=o;let a=shared.timer.buildTimer(e-server_now_ts,GT.design.event_ends_in,"severalQoL-PoVPoG-timer nc-expiration-label",!1);t.find(".white_text").append(a)}0!==e&&o(e,$("[rel='path-of-valor']"),1209600),0!==t&&o(t,$("[rel='path-of-glory']"),3024e3),shared.timer.activateTimers("severalQoL-PoVPoG-timer.nc-expiration-label",()=>{})}},j=class{run(){this.injectCSS();let e=+unsafeWindow.time_remaining;"/path-of-valor.html"===window.location.pathname?(R.setPoVEndTimeComparedToServerTS(server_now_ts+e),this.replacePoVNotifButton()):"/path-of-glory.html"===window.location.pathname&&(R.setPoGEndTimeComparedToServerTS(server_now_ts+e),this.replacePoGNotifButton())}async injectCSS(){let e=(v(),r(g)).default;GM_addStyle(e)}replacePoVNotifButton(){S.doWhenSelectorAvailable(".button-notification-action.notif_button_s",()=>{$(".button-notification-action.notif_button_s").attr("tooltip","Several QoL: More Info on this event").off("click").on("click",e=>{e.preventDefault(),e.stopImmediatePropagation(),GM.openInTab("https://forum.kinkoid.com/index.php?/topic/31207-vademecum-rerum-gestarum-ex-haremverse-a-guide-to-the-events/#comment-310477",{active:!0})})})}replacePoGNotifButton(){S.doWhenSelectorAvailable(".button-notification-action.notif_button_s",()=>{$(".button-notification-action.notif_button_s").attr("tooltip","Several QoL: More Info on this event").off("click").on("click",e=>{e.preventDefault(),e.stopImmediatePropagation(),GM.openInTab("https://forum.kinkoid.com/index.php?/topic/31207-vademecum-rerum-gestarum-ex-haremverse-a-guide-to-the-events/#comment-310673",{active:!0})})})}},D=class{constructor(){this.EventInfoSeasonalLinks=["","https://forum.kinkoid.com/index.php?/topic/31207-vademecum-rerum-gestarum-ex-haremverse-a-guide-to-the-events/#comment-310068",""]}run(){let e=unsafeWindow.event_functionalities?.id_seasonal_event_type;e&&2===e&&this.replaceSeasonalNotifButton(this.EventInfoSeasonalLinks[e-1])}replaceSeasonalNotifButton(e){e&&S.doWhenSelectorAvailable(".button-notification-action.notif_button_s",()=>{$(".button-notification-action.notif_button_s").attr("tooltip","Several QoL: More Info on this event").off("click").on("click",t=>{t.preventDefault(),t.stopImmediatePropagation(),GM.openInTab(e,{active:!0})})})}},Q=class extends k{constructor(){super(...arguments),this.configSchema={baseKey:"eventInfo",label:"<span tooltip='Click on the Information top right of event (only DP, SM, CbC, OD, PoV & PoG)'>Event Info (WIP): Show guides, tips, tricks & more info on events</span>",default:!0}}shouldRun(){return"/event.html"===location.pathname||"/home.html"===location.pathname||"/path-of-glory.html"===location.pathname||"/path-of-valor.html"===location.pathname||"/seasonal.html"===location.pathname||"/world-boss-event"===location.pathname||"/season.html"===location.pathname||"/love-raids.html"===location.pathname}run(){if(this.hasRun||!this.shouldRun())return;this.hasRun=!0;let e=location.pathname;"/home.html"!==e?"/event.html"!==e?"/path-of-glory.html"!==e&&"/path-of-valor.html"!==e?"/seasonal.html"!==e?"/season.html"!==e||this.runSeason():this.runSeasonal():this.runPathes():this.runEvent():this.runHome()}runHome(){(new V).run()}runEvent(){(new A).run()}runPathes(){(new j).run()}runSeasonal(){(new D).run()}runSeason(){this.helperReplaceNotifButton("https://forum.kinkoid.com/index.php?/topic/31207-vademecum-rerum-gestarum-ex-haremverse-a-guide-to-the-events/#comment-310674")}runLoveRaids(){this.helperReplaceNotifButton("https://forum.kinkoid.com/index.php?/topic/31207-vademecum-rerum-gestarum-ex-haremverse-a-guide-to-the-events/#comment-316577")}helperReplaceNotifButton(e){S.doWhenSelectorAvailable(".button-notification-action.notif_button_s",()=>{$(".button-notification-action.notif_button_s").attr("tooltip","Several QoL: More Info on this event").off("click").on("click",t=>{GM.openInTab(e,{active:!0})})})}},F=class{static run(){let e=GM_info.script.version,t=T.getStoredScriptVersion();if(t!==e){if("0.0.0"===t){let e=GM_listValues(),t=["StoredGirls","EnumGirlsOrderedByClass_","PoPLastSortOfGirls"];e.forEach(e=>{t.some(t=>e.includes(t))&&GM_deleteValue(e)})}T.setStoredScriptVersion(e)}}};new class{constructor(){this.allModules=[new I,new x,new L,new E,new y,new O,new H,new M,new B,new W,new Q],void 0!==unsafeWindow.hhPlusPlusConfig?(this.runWithBDSM(),this.run()):Promise.race([new Promise(e=>{$(document).one("hh++-bdsm:loaded",()=>e("hh++-bdsm:loaded"))}),new Promise(e=>setTimeout(()=>e("timeout"),50))]).then(e=>{"hh++-bdsm:loaded"===e?this.runWithBDSM():this.runWithoutBdsm()})}runWithBDSM(){unsafeWindow.hhPlusPlusConfig.registerGroup({key:"severalQoL",name:"<span tooltip='By infarctus'>Several QoL</span>"}),location.pathname.includes("/home.html")?this.allModules.forEach(e=>{unsafeWindow.hhPlusPlusConfig.registerModule(e)}):this.allModules.forEach(e=>{e.shouldRun()&&unsafeWindow.hhPlusPlusConfig.registerModule(e)}),unsafeWindow.hhPlusPlusConfig.loadConfig(),unsafeWindow.hhPlusPlusConfig.runModules()}runWithoutBdsm(){this.allModules.forEach(e=>{try{let t=e.configSchema;if(e.shouldRun())if(t.subSettings){let o=t.subSettings.reduce((e,t)=>(e[t.key]=!0,e),{});e.run(o)}else e.run(void 0)}catch(t){console.error("Error running module",e,t)}})}run(){F.run()}}})();