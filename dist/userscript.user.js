// ==UserScript==
// @name         Several QoL
// @namespace    http://tampermonkey.net/
// @version      1.2.1
// @description  A userscript for QoL for the Haremverse
// @author       infarcactus
// @license      GPLv3
// @match        https://*.haremheroes.com/*
// @match        https://*.hentaiheroes.com/*
// @match        https://*.gayharem.com/*
// @match        https://*.comixharem.com/*
// @match        https://*.hornyheroes.com/*
// @match        https://*.pornstarharem.com/*
// @match        https://*.transpornstarharem.com/*
// @match        https://*.gaypornstarharem.com/*
// @match        https://www.mangarpg.com/*
// @updateURL    https://github.com/infarcactus-HH/HH-Several_QoL/raw/refs/heads/main/dist/userscript.user.js
// @downloadURL  https://github.com/infarcactus-HH/HH-Several_QoL/raw/refs/heads/main/dist/userscript.user.js
// @grant        GM.addStyle
// @grant        GM.openInTab
// @grant        unsafeWindow
// @run-at       document-end
// ==/UserScript==

"use strict";(()=>{var i=class{constructor(e){this.hasRun=!1;this.group="severalQoL",this.configSchema=e}};var w={baseKey:"popupPlusPlus",label:"<span tooltip='Stacking popups,click on popups to make it disappear'>Popup++</span>",default:!0},u=class extends i{constructor(){super(w)}shouldRun(){return!0}run(){if(this.hasRun||!this.shouldRun())return;this.hasRun=!0,GM.addStyle("#toast-popups {display:inherit!important;}");let e={},t=null;delete shared.general.objectivePopup.show,shared.general.objectivePopup.show=function(s){if(this.LastPoints==null&&(this.LastPoints={}),!(!s.objective_points||s.battle_result)){if(!s.objective_points){let a=s.objective_points;if(Object.keys(this.pointsBox).length)for(let r in a)this.pointsBox[r]?this.pointsBox[r].name===a[r].name&&(this.pointsBox[r].points_gained+=a[r].points_gained):this.pointsBox[r]=a[r];else this.pointsBox=s.objective_points;s?.end?.rewards?.hasOwnProperty("lose")}o(this,s.objective_points)}};function o(s,a){let r=new Set;Object.keys(a).map((l=>{let p=a[l];if(!e[l])e[l]=p,p.points_gained>0&&r.add(l);else{let v=p.points_gained;v>0&&r.add(l),e[l].points_gained+=v}}));let _=$(`<div class="popup_wrapper"><div id="objective_popup" class="popup"><div class="noti_box"><div class="points">${Object.keys(e).map((l=>{let p=e[l];return`<div class="row animate" style="transition: all 20ms;"><div class="contest_name">${p.title}:</div><div class="contest_points"><div class="points_name" style="animation:none;">${p.name}: </div><div class="points_num" style="animation:none;"><div class="points_i" style="animation:none;">+${number_format_lang(p.points_gained)}</div></div></div></div>`})).join("")}</div></div></div></div></div>`);$("#toast-popups .popup_wrapper").remove(),$("#toast-popups").css("display","unset"),$("#toast-popups"),$("#toast-popups").append(_),$("#toast-popups").css("display","unset"),t&&(clearTimeout(t),t=null),t=setTimeout(()=>{_.remove(),t=null,e={}},5e3),_.on("click.removePopup",function(){_.remove(),t=null,e={}})}}};var S={baseKey:"girlsToWiki",label:"Girls to Wiki (HH)",default:!1,subSettings:[{key:"infoBubbleNameToWiki",default:!0,label:"Info bubble name clickable to wiki"},{key:"portraitToWiki",default:!1,label:"Make portrait clickable to wiki"}]},c=class extends i{constructor(){super(S)}shouldRun(){return location.host.includes("heroes")}run(e){this.hasRun||!this.shouldRun()||(this.hasRun=!0,e?.infoBubbleNameToWiki&&setInterval(()=>{P()},500),e?.portraitToWiki&&setInterval(()=>{H()},500))}};function P(){$(".new_girl_info .girl_name_wrap > h5[style!='cursor: pointer;']").each(function(){let n=$(this);n.css("cursor","pointer"),n.on("click.InfoBubbleToWiki",function(){let e=n.attr("hh_title");if(!e)return;let t=e.replace(/ /g,"-");GM.openInTab(`https://harem-battle.club/wiki/Harem-Heroes/HH:${t}`,{active:!0})})})}function H(){$(".slot_girl_shards > [data-new-girl-tooltip][style!='cursor: pointer;']").each(function(){let n=$(this),e=n.attr("data-new-girl-tooltip");if(!e)return;let t=e.match(/"name":"(.+)","rarity/);t&&t[1]&&(n.css("cursor","pointer"),n.on("click.ImgToWiki",function(o){o.stopPropagation();let s=t[1].replace(/ /g,"-");GM.openInTab(`https://harem-battle.club/wiki/Harem-Heroes/HH:${s}`,{active:!0})}))})}var d=class extends i{constructor(){let e={baseKey:"entirePaid",label:"Removes only $ options",default:!1};super(e)}shouldRun(){return!0}run(){this.hasRun||!this.shouldRun()||(this.hasRun=!0,GM.addStyle(".pass_reward.reward_wrapper{display:none!important;}"),GM.addStyle("#gsp_btn_holder{display:none!important;}"),GM.addStyle(".rewards_seasons_row .rewards_pair .tier_number{top:100%!important;}"),GM.addStyle("#get_mega_pass_shop_btn{display:none!important;}"),GM.addStyle("#bundles_tab{display:none!important;}"),GM.addStyle(".purchase-shop{display:none!important;}"))}};var x={baseKey:"tighterPoPs",label:"Tighter PoPs (requires css tweaks for PoP)",default:!0},m=class extends i{constructor(){super(x)}shouldRun(){return location.pathname.includes("/activities.html")}run(){this.hasRun||!this.shouldRun()||(this.hasRun=!0,GM.addStyle("#pop .pop_list .pop-action-btn {margin-bottom: 0.4rem!important;margin-top: 0rem!important;}#pop .pop_list .pop_list_scrolling_area .pop_thumb img {height: 90px!important;}.activities-container #pop .pop_list .pop_list_scrolling_area .pop_thumb_container .pop_thumb_expanded {height: 89px!important;background: linear-gradient(0deg, #00000087, transparent)!important;}.activities-container #pop .pop_list .pop_list_scrolling_area .pop_thumb_container, .activities-container #pop .pop_list .pop_list_scrolling_area .pop_thumb_container .pop_thumb_active {min-height: 89px!important;height: 89px!important;margin-bottom: 5px!important;}.activities-container #pop .pop_list .pop_list_scrolling_area .pop_thumb>.pop_thumb_level {top: -93px!important;}.activities-container #pop .pop_list .pop_list_scrolling_area .pop_thumb.pop_thumb_active[status=pending_reward]>.pop_thumb_space {top: -126px!important;}.activities-container #pop .pop_list .pop_list_scrolling_area .collect_notif {margin-top: -91px!important;margin-left: 121px!important;}.activities-container .pop_thumb_progress_bar {margin-top: 21px!important;}"))}};var h=class{static doWhenSelectorAvailable(e,t){if($(e).length)t();else{let o=new MutationObserver(()=>{$(e).length&&(o.disconnect(),t())});o.observe(document.documentElement,{childList:!0,subtree:!0})}}};var T={baseKey:"labyTeamPreset",label:"<span tooltip='Add a button to register laby team presets, and to apply it'>Laby Team Preset</span>",default:!0},f=class extends i{constructor(){super(T);this.savedTeamPresetKey="SeveralQoL_LabyTeamPreset"}shouldRun(){return location.pathname.includes("/edit-labyrinth-team.html")}run(){if(this.hasRun||!this.shouldRun())return;this.hasRun=!0;let t=$(".boss-bang-panel"),o=$('<button class="green_button_L" tooltip="Save preset for later runs">Save Preset</button>');o.on("click",()=>{this.saveCurrentPreset(),s.removeAttr("disabled")}),t.append(o);let s=$(`<button class="green_button_L" tooltip="Use previously saved preset & leave page" ${localStorage.getItem(this.savedTeamPresetKey)?"":"disabled"}>Fill Preset</button>`);s.on("click",()=>{this.loadSavedPreset()}),h.doWhenSelectorAvailable(".change-team-panel .player-team .average-lvl",()=>{$(".change-team-panel .player-team .average-lvl").replaceWith(s)})}saveCurrentPreset(){let t=[];$(".team-hexagon .team-member-container").each(function(){let o=$(this).attr("data-team-member-position"),s=$(this).attr("data-girl-id");$(this).is("[data-girl-id]")&&o&&s&&(t[o]=s)}),console.log("Saving preset: ",t),localStorage.setItem(this.savedTeamPresetKey,JSON.stringify(t))}loadSavedPreset(){let t=localStorage.getItem(this.savedTeamPresetKey);if(!t){console.warn("No saved preset found");return}try{let o=JSON.parse(t);console.log("Loading preset: ",o);let s={class:"Hero",action:"edit_team",girls:o,battle_type:"labyrinth",id_team:unsafeWindow.teamId};console.log("AJAX settings: ",s),shared.general.hh_ajax(s,a=>{shared.general.navigate(unsafeWindow.redirectUrl)})}catch(o){console.error("Failed to load preset:",o)}}};var g=class extends i{constructor(){let e={baseKey:"noAnnoyingPopups",label:"Removes annoying popup appearing automaticly for shops, paths, news",default:!1};super(e)}shouldRun(){return!0}run(){this.hasRun||!this.shouldRun()||(this.hasRun=!0,document.cookie="disabledPopups=PassReminder,Bundles,News; path=/")}};var k={baseKey:"whaleBossTournament",label:"Renames WBT to Whale Boss Tournament",default:!1},b=class extends i{constructor(){super(k)}shouldRun(){return location.pathname.includes("/home.html")}run(){this.hasRun||!this.shouldRun()||(this.hasRun=!0,h.doWhenSelectorAvailable(".world-boss .title",()=>{$(".world-boss .title").text("Whale Boss Tournament")}))}};var y=class{constructor(){if(unsafeWindow.hhPlusPlusConfig===void 0){Promise.race([new Promise(e=>{$(document).one("hh++-bdsm:loaded",()=>e("hh++-bdsm:loaded"))}),new Promise(e=>setTimeout(()=>e("timeout"),50))]).then(e=>{e==="hh++-bdsm:loaded"?this.run():this.runWithoutBdsm()});return}this.run()}run(){let e=[new u,new f,new g,new d,new c,new m,new b];unsafeWindow.hhPlusPlusConfig.registerGroup({key:"severalQoL",name:"<span tooltip='by infarctus'>Several QoL</span>"}),e.forEach(t=>{unsafeWindow.hhPlusPlusConfig.registerModule(t)}),unsafeWindow.hhPlusPlusConfig.loadConfig(),unsafeWindow.hhPlusPlusConfig.runModules()}runWithoutBdsm(){[new u,new f,new g,new d,new c,new m,new b].forEach(t=>{try{let o=t.configSchema;if(t.shouldRun())if(o.subSettings){let s=o.subSettings.reduce((a,r)=>(a[r.key]=!0,a),{});t.run(s)}else t.run(void 0)}catch(o){console.error("Error running module",t,o)}})}};new y;})();
