// ==UserScript==
// @name         Several QoL
// @namespace    http://tampermonkey.net/
// @version      1.27.0
// @description  A userscript for QoL for the Haremverse
// @author       infarcactus
// @license      GPLv3
// @match        https://nutaku.haremheroes.com/*
// @match        https://*.hentaiheroes.com/*
// @match        https://*.gayharem.com/*
// @match        https://*.comixharem.com/*
// @match        https://*.hornyheroes.com/*
// @match        https://*.pornstarharem.com/*
// @match        https://*.transpornstarharem.com/*
// @match        https://*.gaypornstarharem.com/*
// @match        https://*.mangarpg.com/*
// @updateURL    https://github.com/infarcactus-HH/HH-Several_QoL/raw/refs/heads/main/dist/userscript.user.js
// @downloadURL  https://github.com/infarcactus-HH/HH-Several_QoL/raw/refs/heads/main/dist/userscript.user.js
// @grant        GM_addStyle
// @grant        GM_openInTab
// @grant        GM_getValue
// @grant        GM_setValue
// @grant        GM_deleteValue
// @grant        GM_info
// @grant        GM_listValues
// @grant        GM_cookie
// @grant        unsafeWindow
// @run-at       document-end
// ==/UserScript==

"use strict";(()=>{var e=class{constructor(){this.hasRun=!1}},t=class{constructor(){this.group="severalQoL",this.hasRun=!1}},a=class e extends t{constructor(){super(...arguments),this.configSchema={baseKey:"popupPlusPlus",label:"<span tooltip='Stacking point popups, click on the popup to make it disappear'>Popup++</span>",default:!0}}static shouldRun(){return!0}run(){if(this.hasRun||!e.shouldRun())return;this.hasRun=!0,GM_addStyle("#toast-popups {display:inherit!important;}");let t={},a=null;delete shared.general.objectivePopup.show,shared.general.objectivePopup.show=function(e){if(null==this.LastPoints&&(this.LastPoints={}),e.objective_points&&!e.battle_result){if(!e.objective_points){let t=e.objective_points;if(Object.keys(this.pointsBox).length)for(let e in t)this.pointsBox[e]?this.pointsBox[e].name===t[e].name&&(this.pointsBox[e].points_gained+=t[e].points_gained):this.pointsBox[e]=t[e];else this.pointsBox=e.objective_points;e?.end?.rewards?.hasOwnProperty("lose")}!function(e,i){Object.keys(i).map(e=>{let a=i[e];t[a.title]||(t[a.title]={}),t[a.title][a.name]?t[a.title][a.name]+=a.points_gained:t[a.title][a.name]=a.points_gained});let r=$(`<div class="popup_wrapper"><div id="objective_popup" class="popup"><div class="noti_box"><div class="points">${Object.keys(t).map(e=>{let a=t[e],i=`<div class="row animate" style="transition: all 20ms;" style="animation: slide_left 200ms ease-out;"><div class="contest_name">${e}:</div>`;for(let e in a){let t=a[e];i+=`<div class="contest_points"><div class="points_name" style="animation:none;">${e}: </div><div class="points_num" style="animation:none;"><div class="points_i" style="animation:none;">+${number_format_lang(t)}</div></div></div>`}return i+="</div>",i}).join("")}</div></div></div></div>`);$("#toast-popups .popup_wrapper").remove(),$("#toast-popups").css("display","unset"),$("#toast-popups"),$("#toast-popups").append(r),$("#toast-popups").css("display","unset"),a&&(clearTimeout(a),a=null),a=setTimeout(()=>{r.remove(),a=null,t={}},5e3),r.on("click.removePopup",function(){r.remove(),a=null,t={}})}(0,e.objective_points)}}}},i=class{static createPopup(e,t,a,i){if("common"!==e)throw`type ${e} not implemented yet`;this.createCommonPopup(t,(e,t)=>{let r=e.$dom_element.find(".container-special-bg");i&&r.append(`<div class="title">${i}</div>`),r.append(a)})}static createCommonPopup(e,t){let a={init:function(e){$("#common-popups").prepend(this.$dom_element),t(this,e)},popup_name:"several_qol_common_popup",type:"common",$dom_element:$(` <div class="popup_wrapper"> <div class="popup_background clickable"></div> <div class="popup several-qol-popup" id="popup-${e}"> <div class="container-special-bg" id="container-${e}"></div> <close class="closable"></close> </div> </div> `),close_on_esc:!0,addEventListeners:function(){this.$dom_element.find("close, .popup_background").on("click",()=>{this.destroy()})},removeEventListeners(){},onOpen(){$("#common-popups").append(this.$dom_element)},onClose(){},destroy:function(){shared.PopupQueueManager.close({type:this.type})}};return shared.PopupQueueManager.add({popup:a}),a}static getWikiPageForCurrentGame(e){let t=e.replace(/ /g,"-");return location.host.includes("heroes.com")?`https://harem-battle.club/wiki/Harem-Heroes/HH:${t}`:location.host.includes("gayharem")?`https://harem-battle.club/wiki/Gay-Harem/GH:${t}`:location.host.includes("gaypornstarharem")?`https://harem-battle.club/wiki/Gay-Pornstar-Harem/GPSH:${t}`:void 0}static getGameKey(){let e=window.location.host;return e.includes(".gayharem.com")?"GH":e.includes(".comixharem.com")?"CxH":e.includes(".pornstarharem.com")?"PSH":e.includes(".gaypornstarharem.com")?"GPSH":e.includes(".transpornstarharem.com")?"TPSH":"HH"}static convertShownMoneyToNumber(e){let t=e.trim();if(!t)return 0;let a=t.match(/([kKmMgGtTpPeEzZyY])$/),i=a?.[1]?.toLowerCase(),r=i?{k:1e3,m:1e6,g:1e9,t:1e12,p:1e15,e:1e18,z:1e21,y:1e24}[i]??1:1,o=(e=>{let t=e.replace(/\s/g,""),a=t.lastIndexOf("."),i=t.lastIndexOf(","),r="";a>i?r=".":i>a&&(r=",");let o=t;return"."===r?o=o.replace(/,/g,""):","===r&&(o=o.replace(/\./g,""),o=o.replace(/,/g,".")),Number.parseFloat(o||"0")})(i?t.slice(0,-1):t);return Number.isFinite(o)?o*r:0}},r=class e extends t{constructor(){super(...arguments),this.configSchema={baseKey:"peopleToWiki",label:"People to Wiki(HH,GH,GPSH)",default:!1,subSettings:[{key:"infoBubbleNameToWiki",default:!0,label:"Info bubble name clickable to wiki"},{key:"portraitToWiki",default:!1,label:"Make portrait clickable to wiki"}]}}static shouldRun(){return location.host.includes("heroes")||location.host.includes("gayharem")||location.host.includes("gaypornstarharem")}run(t){this.hasRun||!e.shouldRun()||(this.hasRun=!0,t.infoBubbleNameToWiki&&(GM_addStyle(".new_girl_info .girl_name_wrap > h5 { cursor: pointer; }"),$(document).on("click.InfoBubbleToWiki",".new_girl_info .girl_name_wrap > h5",e=>{let t=e.currentTarget.getAttribute("hh_title");if(!t)return;let a=t.replace(/ /g,"-"),r=i.getWikiPageForCurrentGame(a);r&&GM_openInTab(r,{active:!0})})),t.portraitToWiki&&(GM_addStyle(".slot_girl_shards > [data-new-girl-tooltip] { cursor: pointer; }"),$(document).on("click.PortraitToWiki",".slot_girl_shards > [data-new-girl-tooltip]",e=>{let t=e.currentTarget.getAttribute("data-new-girl-tooltip");if(!t)return;let a=t.match(/"name":"(.+)","rarity/);if(a&&a[1]){let e=a[1].replace(/ /g,"-"),t=i.getWikiPageForCurrentGame(e);if(!t)return;GM_openInTab(t,{active:!0})}})))}},o=".popup_wrapper>#popup-event_info{width:1020px;height:32rem;top:3rem;left:.62rem}#popup-event_info>#container-event_info.container-special-bg{display:flex;flex-direction:column;height:100%}#popup-event_info close{width:2.4rem;height:2.2rem;background-image:url(/images/clubs/ic_xCross.png);opacity:1}#container-event_info{width:100%;height:100%;box-shadow:none;border:2px solid #f90;align-content:center}#container-event_info>.banner{width:100%;height:3rem;font-size:1.8rem;font-weight:700;color:#ffb827;text-align:center;line-height:3rem;border-bottom:2px solid #f90;flex-shrink:0}#container-event_info>.event-content{flex:1 1 auto;padding:1rem;overflow:auto;text-align:left}#container-event_info strong{color:#ffb827}.severalQoL-event-shop-timer{width:4rem;display:block;position:absolute;left:-3px;bottom:-3px}.severalQoL-event-shop-timer>span{font-size:12px}",n=class{static doWhenSelectorAvailable(e,t){let a=$(e);if(a.length)t(a);else{let a=new MutationObserver(()=>{let i=$(e);i.length&&(a.disconnect(),t(i))});a.observe(document.documentElement,{childList:!0,subtree:!0})}}static conditionalDoWhenSelectorAvailable(e,t,a){let i=$(t);if(e(i))a(i);else{let i=new MutationObserver(()=>{let r=$(t);e(r)&&(i.disconnect(),a(r))});i.observe(document.documentElement,{childList:!0,subtree:!0})}}},s=class{static setStoredScriptVersion(e){GM_setValue("StoredScriptVersion",e)}static getStoredScriptVersion(){return GM_getValue("StoredScriptVersion","0.0.0")}static setShowUpdatePopup(e){GM_setValue("ShowUpdatePopup",e)}static getShowUpdatePopup(){return GM_getValue("ShowUpdatePopup",!0)}},l=class{static setPlayerLeagueRank(e){GM_setValue(HH_UNIVERSE+"PlayerLeagueRank",e)}static getPlayerLeagueRank(){return GM_getValue(HH_UNIVERSE+"PlayerLeagueRank",{league:1,rank:-1})}static setPlayerSeasonInfo(e){GM_setValue(HH_UNIVERSE+"PlayerSeasonInfo",e)}static getPlayerSeasonInfo(){return GM_getValue(HH_UNIVERSE+"PlayerSeasonInfo",null)}static setPlayerGemsPrestigeBonus(e){GM_setValue(HH_UNIVERSE+"PlayerGemsPrestigeBonus",e)}static getPlayerGemsPrestigeBonus(){return GM_getValue(HH_UNIVERSE+"PlayerGemsPrestigeBonus",0)}static setPlayerPentaDrillInfo(e){GM_setValue(HH_UNIVERSE+"PlayerPentaDrillInfo",e)}static getPlayerPentaDrillInfo(){return GM_getValue(HH_UNIVERSE+"PlayerPentaDrillInfo",null)}static setPlayerClubmatesIds(e){GM_setValue(HH_UNIVERSE+"PlayerClubmatesIds",e)}static getPlayerClubmatesIds(){return GM_getValue(HH_UNIVERSE+"PlayerClubmatesIds",[])}},d=class{static setLeaguePLayerRecord(e){GM_setValue(HH_UNIVERSE+"LeaguePlayerRecord",e)}static getLeaguePlayerRecord(){return GM_getValue(HH_UNIVERSE+"LeaguePlayerRecord",{})}},p=class{static setSMShopRefreshTimeComparedToServerTS(e){GM_setValue(HH_UNIVERSE+"SMShopRefreshTime",e)}static getSMShopRefreshTimeComparedToServerTS(){return GM_getValue(HH_UNIVERSE+"SMShopRefreshTime",0)}static setPoVEndTimeComparedToServerTS(e){GM_setValue(HH_UNIVERSE+"PoVEndTime",e)}static getPoVEndTimeComparedToServerTS(){return GM_getValue(HH_UNIVERSE+"PoVEndTime",0)}static setPoGEndTimeComparedToServerTS(e){GM_setValue(HH_UNIVERSE+"PoGEndTime",e)}static getPoGEndTimeComparedToServerTS(){return GM_getValue(HH_UNIVERSE+"PoGEndTime",0)}},c=class{static setTeamPreset(e){GM_setValue(HH_UNIVERSE+"LabyTeamPreset",e)}static getTeamPreset(){return GM_getValue(HH_UNIVERSE+"LabyTeamPreset",void 0)}},u=class{static setTeamPreset(e){GM_setValue(HH_UNIVERSE+"WBTTeamPreset",e)}static getTeamPreset(){return GM_getValue(HH_UNIVERSE+"WBTTeamPreset",void 0)}static setWBTId(e){GM_setValue(HH_UNIVERSE+"WBTId",e)}static getWBTId(){return GM_getValue(HH_UNIVERSE+"WBTId",-1)}},h=class{static addPentaDrillTeam(e){let t=this.getPentaDrillTeams();t.push(e),GM_setValue(HH_UNIVERSE+"PentaDrillTeams",t)}static getPentaDrillTeams(){return GM_getValue(HH_UNIVERSE+"PentaDrillTeams",[])}static deletePentaDrillTeam(e){let t=this.getPentaDrillTeams();e>=0&&e<t.length&&(t.splice(e,1),GM_setValue(HH_UNIVERSE+"PentaDrillTeams",t))}},g=class{static setReducedLoveRaids(e){GM_setValue(HH_UNIVERSE+"ReducedLoveRaids",e)}static getReducedLoveRaids(){return GM_getValue(HH_UNIVERSE+"ReducedLoveRaids",[])}static setLoveRaidNotifications(e){GM_setValue(HH_UNIVERSE+"LoveRaidNotifications",e)}static getLoveRaidNotifications(){return GM_getValue(HH_UNIVERSE+"LoveRaidNotifications",[])}static setShouldHideCompletedRaids(e){GM_setValue("HideCompletedLoveRaids",e)}static getShouldHideCompletedRaids(){return GM_getValue("HideCompletedLoveRaids",!0)}static setHideHiddenRaids(e){GM_setValue(HH_UNIVERSE+"HideHiddenLoveRaids",e)}static getHideHiddenRaids(){return GM_getValue(HH_UNIVERSE+"HideHiddenLoveRaids",!1)}},m=class{static setSessID(e){GM_setValue(location.hostname+"SessID",e)}static getSessID(){return GM_getValue(location.hostname+"SessID","")}static clearSessID(){GM_deleteValue(location.hostname+"SessID")}},f=class{static setCurrentTrackingState(e,t=[]){GM_setValue(HH_UNIVERSE+"VillainShardTrackerTrackingState",{trollID:e,girlIds:t})}static getCurrentTrackingState(){return GM_getValue(HH_UNIVERSE+"VillainShardTrackerTrackingState",{trollID:-1,girlIds:[]})}static getTrackedGirls(){return null===this.currentStoredRecords&&(this.currentStoredRecords=GM_getValue(HH_UNIVERSE+"VillainShardTrackerTrackedGirls",{})),this.currentStoredRecords}static setTrackedGirls(e){this.currentStoredRecords=e,GM_setValue(HH_UNIVERSE+"VillainShardTrackerTrackedGirls",this.currentStoredRecords)}static getTrackedGirl(e){return this.getTrackedGirls()[e]}static upsertTrackedGirl(e,t){let a=this.getTrackedGirls();this.setTrackedGirls({...a,[e]:t})}static removeTrackedGirl(e){let t=this.getTrackedGirls();if(t[e]){let{[e]:a,...i}=t;this.setTrackedGirls(i)}}};f.currentStoredRecords=null;var _=class e extends t{constructor(){super(...arguments),this.configSchema={baseKey:"labyTeamPreset",label:"<span tooltip='Add a button to register laby team presets, and to apply it (also for WBT)'>Laby Team Preset</span>",default:!0},this.StorageHandlerTeam="/edit-labyrinth-team.html"===location.pathname?c:u}static shouldRun(){return"/edit-labyrinth-team.html"===location.pathname||"/edit-world-boss-team.html"===location.pathname||"/world-boss-pre-battle.html"===location.pathname||"/edit-penta-drill-team"===location.pathname}run(){this.hasRun||!e.shouldRun()||(this.hasRun=!0,this.migrateLocalStorageIfNeeded(),"/world-boss-pre-battle.html"===location.pathname?this.WBTPreBattlePageRun():"/edit-penta-drill-team"===location.pathname?this.PentaDrillTeamPageRun():this.editTeamPageRun())}PentaDrillTeamPageRun(){let e=$(".boss-bang-panel");!async function(){GM_addStyle(".boss-bang-panel>.manage-presets{margin-bottom:10px}.popup_wrapper>#popup-laby_team_preset_manager{width:26rem;height:500px;top:5rem;left:19.5rem}#container-laby_team_preset_manager,#popup-laby_team_preset_manager>#container-laby_team_preset_manager.container-special-bg{display:flex;flex-direction:column;height:100%}#popup-laby_team_preset_manager close{width:2rem;height:2rem;top:0;right:.5rem;background-image:url(/images/clubs/ic_xCross.png);opacity:1}#container-laby_team_preset_manager{width:100%;box-shadow:none;border:2px solid #f90}#container-laby_team_preset_manager>.title{position:absolute;width:100%;height:2rem;top:-1rem;left:0;font-size:18px;font-weight:400;letter-spacing:.22px;color:#ffb827;text-shadow:-1px -1px 0#000,1px -1px 0#000,-1px 1px 0#000,1px 1px 0#000,-2px -2px 5px rgba(255,159,0,.4),2px -2px 5px rgba(255,159,0,.4),-2px 2px 5px rgba(255,159,0,.4),2px 2px 5px rgba(255,159,0,.4),0 0 10px rgba(255,159,0,.4);text-align:center}.penta-drill-content-area{flex:1;overflow-y:auto;padding:2rem 1rem 1rem}#preset-list,.penta-drill-content-area{display:flex;flex-direction:column;gap:.5rem}.penta-drill-registerer-area{padding:1rem;border-top:1px solid #f90;display:flex;gap:.5rem;flex-shrink:0}.penta-drill-team-name-input{flex:1;padding:.5rem;background-color:#1a1a1a;color:#ffb827;border:1px solid #f90;border-radius:3px;font-family:Arial,sans-serif;font-size:14px}.penta-drill-team-name-input::placeholder{color:#888}.penta-drill-register-btn{flex:0 0 auto;white-space:nowrap}.penta-drill-empty-state{text-align:center;color:#ffb827;padding:1rem}.penta-drill-preset-item{display:flex;gap:.5rem;align-items:center;padding:.5rem;background-color:rgba(255,159,0,.1);border:1px solid #f90;border-radius:3px}.penta-drill-delete-btn{flex:0 0 2rem;height:2rem;background-image:url(/images/clubs/ic_xCross.png);background-size:cover;background-repeat:no-repeat;background-position:center;background-color:transparent;padding:0;border:0;color:transparent;cursor:pointer}.penta-drill-preset-name{flex:1;color:#ffb827;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;padding:0 .5rem}.penta-drill-apply-btn{flex:0 0 auto;white-space:nowrap}")}();let t=$('<button class="green_button_L manage-presets">Manage presets</button>');t.on("click",()=>{i.createCommonPopup("laby_team_preset_manager",(e,t)=>{let a=e.$dom_element.find(".container-special-bg");a.append('<div class="title">Penta Drill Team Preset Manager</div>');let i=$(' <div class="hh-scroll penta-drill-content-area"> <div id="preset-list"></div> </div> '),r=$(' <div class="penta-drill-registerer-area"> <input id="team-name-input" placeholder="Team name" class="penta-drill-team-name-input"> <button class="green_button_L penta-drill-register-btn" id="register-team-btn"> Register </button> </div> ');a.append(i,r),this.renderPentaDrillPresets(i.find("#preset-list")),r.find("#register-team-btn").on("click",()=>{let e=r.find("#team-name-input").val()||"Unnamed Team";this.registerCurrentPentaDrillTeam(e),r.find("#team-name-input").val(""),this.renderPentaDrillPresets(i.find("#preset-list"))})})}),e.prepend(t)}renderPentaDrillPresets(e){e.empty();let t=h.getPentaDrillTeams();0!==t.length?t.forEach((t,a)=>{let i=$(` <div class="penta-drill-preset-item"> <button class="penta-drill-delete-btn delete-preset-btn" data-preset-index="${a}"></button> <div class="penta-drill-preset-name">${t.name||"Unnamed Team"}</div> <button class="blue_button_L penta-drill-apply-btn apply-preset-btn" data-preset-index="${a}"> Apply </button> </div> `);i.find(".delete-preset-btn").on("click",()=>{this.deletePentaDrillPreset(a),this.renderPentaDrillPresets(e)}),i.find(".apply-preset-btn").on("click",()=>{this.applyPentaDrillPreset(a)}),e.append(i)}):e.append('<div class="penta-drill-empty-state">No presets saved yet</div>')}registerCurrentPentaDrillTeam(e){let t={};unsafeWindow.all_teams.forEach((e,a)=>{t[a]=e.girls_ids}),h.addPentaDrillTeam({teams:t,name:e})}applyPentaDrillPreset(e){let t=h.getPentaDrillTeams()[e];t?this.sendApplyPentaDrillPresetRequest(t.teams):console.warn("Preset not found at index",e)}deletePentaDrillPreset(e){let t=h.getPentaDrillTeams();e>=0&&e<t.length&&h.deletePentaDrillTeam(e)}sendApplyPentaDrillPresetRequest(e){let t={},a={};Object.values(e).forEach((e,i)=>{let r=unsafeWindow.all_teams[i];t[r.id_team]=e,a[r.id_team]=r.slot_index});let i={action:"edit_multiple_teams",teams_list:t,team_slots:a,battle_type:"penta_drill"};0!==unsafeWindow.teamId&&(i.id_team=unsafeWindow.teamId),shared.general.hh_ajax(i,e=>{shared.general.navigate(unsafeWindow.redirectUrl)})}WBTPreBattlePageRun(){let e=unsafeWindow.event_data?.id_world_boss_event;e&&e!==u.getWBTId()&&(n.doWhenSelectorAvailable("#perform_opponent.blue_button_L",()=>{$("#perform_opponent.blue_button_L").removeClass("blue_button_L").addClass("red_button_L").attr("tooltip","Set your WBT Team before continuing").text("Perform without saved team ?")}),u.setWBTId(e))}editTeamPageRun(){let e=$(".boss-bang-panel"),t=$('<button class="green_button_L" tooltip="Save preset for later runs"> Save Preset </button>');t.on("click",()=>{this.saveCurrentPreset(),a.removeAttr("disabled")}),e.append(t);let a=$(` <button class="green_button_L" tooltip="Use previously saved preset & leave page" ${this.StorageHandlerTeam.getTeamPreset()?"":"disabled"}> Fill Preset </button> `);a.on("click",()=>{this.loadSavedPreset()}),n.doWhenSelectorAvailable(".change-team-panel .player-team .average-lvl",()=>{$(".change-team-panel .player-team .average-lvl").replaceWith(a)})}migrateLocalStorageIfNeeded(){let e="SeveralQoL_LabyTeamPreset",t=localStorage.getItem(e);t&&(c.setTeamPreset(JSON.parse(t)),localStorage.removeItem(e))}saveCurrentPreset(){let e={};$(".team-hexagon .team-member-container").each(function(){let t=$(this).attr("data-team-member-position"),a=$(this).attr("data-girl-id");$(this).is("[data-girl-id]")&&t&&a&&(e[t]=a)}),this.StorageHandlerTeam.setTeamPreset(e)}loadSavedPreset(){let e=this.StorageHandlerTeam.getTeamPreset();if(e)try{let t={class:"Hero",action:"edit_team",girls:e,battle_type:"/edit-labyrinth-team.html"===location.pathname?"labyrinth":"world_boss",id_team:unsafeWindow.teamId};shared.general.hh_ajax(t,e=>{shared.general.navigate(unsafeWindow.redirectUrl)})}catch(e){console.error("Failed to load preset:",e)}else console.warn("No saved preset found")}},b=class e extends t{constructor(){super(...arguments),this.configSchema={baseKey:"whaleBossTournament",label:"Renames WBT to Whale Boss Tournament",default:!1}}static shouldRun(){return location.pathname.includes("/home.html")}run(){this.hasRun||!e.shouldRun()||(this.hasRun=!0,n.doWhenSelectorAvailable(".world-boss .title",e=>{e.each((e,t)=>{let a=$(t);"world-boss-co-op"===a.parent().attr("rel")?a.text("Whale Boss Co-Op"):a.text("Whale Boss Tournament")})}))}},v=class e extends t{constructor(){super(...arguments),this.configSchema={baseKey:"placesOfPowerPlusPlus",label:"<span tooltip='Global overhaul of PoPs especially for claiming & filling manually'>Places of Power++</span>",default:!0,subSettings:[{key:"rewardPopup",default:!0,label:"Show reward popup on PoP claim"}]},this.sortedGirlsCache={1:[],2:[],3:[]},this.isLoadingGirls=!1,this.currentPoPGirls={},this.minPercentToStartPoP=.05,this.hasPopupEnabled=!1,this.criteriaToClassMap={carac_1:1,carac_2:2,carac_3:3},this.idealPoPOrder=["1","2","3","13","14","15","7","8","9","4","5","6","16","17","18","22","23","24","19","20","21","10","11","12"]}static shouldRun(){return location.pathname.includes("/activities.html")&&!location.search.includes("?tab=pop&index=")&&void 0!==unsafeWindow.pop_data}run(t){if(this.hasRun||!e.shouldRun())return;this.hasPopupEnabled=t?.rewardPopup??!0,this.hasRun=!0;let a=$(".switch-tab[data-tab='pop']");a.contents()[0].nodeValue="Places of Power++",a.attr("tooltip","By infarctus"),a.on("click",()=>{this.isLoadingGirls?(shared.animations.loadingAnimation.start(),$(document).on("HH_SQoL_PoP_GirlsLoaded",()=>{shared.animations.loadingAnimation.stop(),this.buildCustomPopInfo()})):this.buildCustomPopInfo()}),this.injectCustomStyles(),this.girlsHandler()}updateSuckless(){unsafeWindow.suckless&&unsafeWindow.suckless.parsePopData&&unsafeWindow.suckless.parsePopData(pop_data)}updateOtherScriptsPoPTrackedTime(){this.updateSuckless();let e="HHPlusPlusTrackedTimes";if(!localStorage.getItem(e))return;let t=JSON.parse(localStorage.getItem(e)||"{}");if(null==t.pop||null==t.popDuration)return;let a=Object.values(pop_data).map(({remaining_time:e,time_to_finish:t})=>({endAt:e,duration:t})).filter(({endAt:e})=>e).sort((e,t)=>e.endAt>t.endAt?1:-1)[0]||{endAt:0,duration:0},i=Math.floor(Date.now()/1e3);t.pop=i+a.endAt,t.popDuration=a.duration,localStorage.setItem(e,JSON.stringify(t))}createOrUpdateKobanButtons(){let e=!1,t=!1;for(let a of Object.values(pop_data))if("pending_reward"===a.status&&(e=!0),"can_start"===a.status&&(t=!0),e&&t)break;$(".pop-koban-buttons-container").length&&$(".pop-koban-buttons-container").remove();let a=$('<div class="pop-koban-buttons-container"></div>'),i=$(` <btn class="pop-koban-button pop-claim-all orange_button_L" price="${hh_prices_auto_claim}" ${e?"":"disabled"}> <div class="action-label">Claim All</div> <div class="action-cost"> <div class="hc-cost"><span class="hard_currency_icn"></span>${hh_prices_auto_claim}</div> </div> </btn> `),r=this;i.on("click",function(){let e=$(this);if(void 0!==e.attr("disabled"))return;let t=e.attr("price");shared.general.hc_confirm(t,()=>{shared.animations.loadingAnimation.start(),e.prop("disabled",!0),shared.general.hh_ajax({action:"pop_claim_all"},e=>{for(let e of Object.values(pop_data))"pending_reward"===e.status&&(delete r.currentPoPGirls[e.id_places_of_power],e.status="can_start");r.hasPopupEnabled&&shared.reward_popup.Reward.handlePopup(e.rewards),$(".pop-record .collect_notif").remove(),r.buildPopDetails("1"),$("pop-record").first().trigger("click"),shared.animations.loadingAnimation.stop()})})}),a.append(i);let o=$(` <btn class="pop-koban-button pop-fill-all orange_button_L" price="${hh_prices_auto_start}" ${t?"":"disabled"}> <div class="action-label">Fill All</div> <div class="action-cost"> <div class="hc-cost"><span class="hard_currency_icn"></span>${hh_prices_auto_start}</div> </div> </btn> `);o.on("click",function(){let e=$(this);if(void 0!==e.attr("disabled"))return;let t=e.attr("price");shared.general.hc_confirm(t,()=>{e.prop("disabled",!0),shared.general.hh_ajax({action:"pop_auto_start_all"},function(){e.prop("disabled",!1),location.reload()})})}),a.append(o),$("#pop_info").append(a)}convertCriteriaKey(e){return e.replace("_","")}assignGirlsToPoP(e){let t=Object.values(pop_data).find(t=>t.id_places_of_power===e);if(!t)return;let a=t.criteria,i=t.max_team_power;return this.selectOptimalGirls(e,i,a)}selectOptimalGirls(e,t,a){let i=this.convertCriteriaKey(a),r=this.criteriaToClassMap[a],o=this.sortedGirlsCache[r];if(0===o.length)return console.error(`[PoP ${e}] No girls available in storage!`),[];let n=new Set;for(let[t,a]of Object.entries(this.currentPoPGirls))parseInt(t)!==e&&a.forEach(e=>n.add(e));let s=[],l=t;for(let e of o){if(n.has(e))continue;let t=pop_hero_girls[e];if(!t)continue;let a=t[i];if(a<=l){if(l-=a,s.push(e),0===l)break}else if(0===s.length||l>0){let t=e;for(let a=o.indexOf(e)+1;a<o.length;a++){let e=o[a];if(n.has(e))continue;let r=pop_hero_girls[e];if(!r)continue;let s=r[i];if(s<=l){s===l&&(t=e);break}t=e}s.push(t);break}}return s}readdGirlsFromCurrentPoP(e){let t=parseInt(e);delete this.currentPoPGirls[t]}selectNextPoPFromFill(e){if(0===e.length)return;let t=e.nextAll().filter(function(){let e=$(this).data("pop-id"),t=pop_data[e];return!t.locked&&t&&"in_progress"!==t.status}).first();if(t.length)t.trigger("click");else if(t=$(".pop-record").filter(function(){let e=$(this).data("pop-id"),t=pop_data[e];return!t.locked&&t&&"in_progress"!==t.status}).first(),t.length)t.trigger("click");else{for(let e of Object.values(pop_data))if(!e.locked&&"in_progress"!==e.status)return void $(`[data-pop-id='${e.id_places_of_power}']`).trigger("click");$(".pop-record").first().trigger("click")}}selectNextPoPFromClaim(){let e=$(".pop-record.selected");if(0!==e.nextAll().find(".collect_notif").length)return void e.nextAll().find(".collect_notif").first().parent().trigger("click");let t=$(".pop-record").find(".collect_notif").first();if(t.length)t.parent().trigger("click");else{for(let e of Object.values(pop_data))if(!e.locked&&"can_start"===e.status)return void $(`[data-pop-id='${e.id_places_of_power}']`).trigger("click");$(".pop-record").first().trigger("click")}}sendClaimRequest(e){shared.animations.loadingAnimation.start();let t=parseInt(e);this.readdGirlsFromCurrentPoP(e);let a=pop_data[t];if($(".claimPoPButton").prop("disabled",!0),null===a.ends_in||0!==a.ends_in)$(".claimPoPButton").css("display","none"),$(".startPoPButton").css("display",""),a.status="can_start",a.ends_in=null,a.time_to_finish=0,$(".pop-record.selected .collect_notif").remove();else{let e=$(".pop-record.selected");this.selectNextPoPFromFill(e),delete pop_data[t],e.remove()}let i={namespace:"h\\PlacesOfPower",class:"standard"===a.type?"PlaceOfPower":"TempPlaceOfPower",action:"claim",id_place_of_power:a.id_places_of_power};delete this.currentPoPGirls[a.id_places_of_power],shared.general.hh_ajax(i,e=>{this.hasPopupEnabled&&shared.reward_popup.Reward.handlePopup(e.rewards),this.selectNextPoPFromClaim(),this.updateSuckless(),shared.animations.loadingAnimation.stop()})}calculateTimeToFinishSeconds(e,t){let a=this.convertCriteriaKey(e.criteria),i=0;for(let e of t){let t=pop_hero_girls[e];t&&(i+=t[a])}if(i>=e.max_team_power)return 21600;let r=e.level_power/i;return Math.floor(60*r)}sendFillRequest(e){shared.animations.loadingAnimation.start();let t=parseInt(e),a=pop_data[t];if("can_start"!==a.status)return;let i=a.id_places_of_power,r=this.assignGirlsToPoP(i)||[];if(this.currentPoPGirls[i]=r,0===r.length)return alert(`No ${GT.design.Girls} were assigned to this PoP. This might happen if all your ${GT.design.Girls} are already assigned to other PoPs.`),delete this.currentPoPGirls[i],void shared.animations.loadingAnimation.stop();let o=this.convertCriteriaKey(a.criteria),n=0;for(let e of r){let t=pop_hero_girls[e];t&&(n+=t[o])}if(n/a.max_team_power<this.minPercentToStartPoP)return alert("Not enough power to start this PoP."),delete this.currentPoPGirls[i],void shared.animations.loadingAnimation.stop();let s=this.calculateTimeToFinishSeconds(a,r);if(n<a.max_team_power&&!confirm(`Warning: This PoP is not fully maxed!\n\nCurrent Power: ${Math.floor(n)}\nMax Power: ${a.max_team_power}\n\nThis will take ${(s/60/60).toFixed(2)} hours to complete.\nDo you want to continue?`))return delete this.currentPoPGirls[i],$(".startPoPButton").css("display",""),$(".claimPoPButton").css("display","none"),void shared.animations.loadingAnimation.stop();$(".startPoPButton").css("display","none"),$(".claimPoPButton").css("display","");let l={namespace:"h\\PlacesOfPower",class:"standard"===a.type?"PlaceOfPower":"TempPlaceOfPower",action:"start",id_place_of_power:i,selected_girls:r},d=$('<div class="pop-timer"></div>'),p=shared.timer.buildTimer(s,"","pop-active-timer",!1);d.append(p),$(".pop-record.selected").append(d),pop_data[t].status="in_progress",pop_data[t].time_to_finish=s,pop_data[t].remaining_time=s,pop_data[t].end_ts=s+Math.floor(Date.now()/1e3),shared.general.hh_ajax(l,e=>{shared.timer.activateTimers("pop-record.selected .pop-active-timer",()=>{}),this.selectNextPoPFromFill($(".pop-record.selected")),this.updateOtherScriptsPoPTrackedTime(),shared.animations.loadingAnimation.stop()})}buildPopDetails(e){let t=$(".pop-details-container");if(!t.length)return;let a=pop_data[parseInt(e)];if(!a)return;t.empty();let i=$('<div class="pop-details-left"></div>');t.append(i);let r=$("<img></img>");r.attr("src",a.girl?a.girl.avatar:IMAGES_URL+"/pictures/girls/1/avb0-1200x.webp?a=1"),i.append(r);let o=$('<div class="pop-navigation-buttons-original blue_button_L">Visit Original</div>');o.on("click",()=>{shared.general.navigate("/activities.html?tab=pop&index=")}),i.append(o);let n=$("<div class='pop-details-right'></div>");t.prepend(n);let s=$(` <a tooltip="Visit this PoP original page" class="pop-title" href="${shared.general.getDocumentHref("/activities.html?tab=pop&index="+a.id_places_of_power)}">${a.title}</a> `);n.append(s);let l=$('<div class="pop-rewards-container"></div>');for(let[e,t]of Object.entries(a.rewards))if(t.loot){let e=shared.reward.newReward.multipleSlot(t);l.append(e);break}n.append(l);let d=$(` <button class="purple_button_L claimPoPButton" ${"pending_reward"!=a.status?"disabled":""}> Claim </button> `);n.append(d),d.on("click",()=>{this.sendClaimRequest(e)});let p=$('<button class="blue_button_L startPoPButton">Fill & Start</button>');p.on("click",()=>{this.sendFillRequest(e)}),n.append(p),"can_start"!==a.status?p.css("display","none"):d.css("display","none"),this.createOrUpdateKobanButtons()}buildCustomPopInfo(){let e=$("#pop_info");if(!e.length)return;e.empty();let t=$('<div class="pop-details-container"></div>');e.append(t);let a=$('<div class="pop-records-container"></div>');Object.entries(pop_data).sort(([e,t],[a,i])=>{let r=String(t.id_places_of_power??e),o=String(i.id_places_of_power??a),n=this.idealPoPOrder.indexOf(r),s=this.idealPoPOrder.indexOf(o);return-1!==n||-1!==s?-1===n?1:-1===s?-1:n-s:Number(r)-Number(o)}).forEach(([e,t])=>{let i=t.locked||0,r=$(`<div class="${i?"pop-record-locked":"pop-record"}"></div>`);r.attr("data-pop-id",e);let o=`<img src="${t.image}" class="pop-record-bg">`;if(r.append(o),!i){r.on("click",()=>{$(".pop-record").removeClass("selected"),r.addClass("selected"),this.buildPopDetails(e)});let a=`<img src="https://hh.hh-content.com/pictures/misc/items_icons/${t.class}.png" class="pop-icon">`;r.append(a);let i=$(`<div class="pop-lvl">Lv. ${t.level}</div>`);if(r.append(i),"in_progress"===t.status){let e=$('<div class="pop-timer"></div>'),a=shared.timer.buildTimer(t.remaining_time,"","pop-active-timer",!1);e.append(a),r.append(e)}if("pending_reward"===t.status){let e=$('<div class="collect_notif"></div>');r.append(e)}}a.append(r),r.attr("tooltip",t.title)}),e.append(a),0!==$(".pop-record").find(".collect_notif").length?$(".pop-record").find(".collect_notif").first().parent().trigger("click"):$(".pop-record").first().trigger("click"),shared.timer.activateTimers("pop-active-timer",e=>{let t=e.$dom_element.parent().parent().parent();t.hasClass("selected")&&$(".claimPoPButton").prop("disabled",!1);let a=t.data("pop-id");pop_data[a].status="pending_reward",pop_data[a].remaining_time=0,t.append('<div class="collect_notif"></div>'),e.$dom_element.parent().parent().remove()})}async injectCustomStyles(){GM_addStyle(".pop-details-container{position:absolute;top:60px;left:10px;width:685px;float:left;min-height:200px}.pop-details-left{position:absolute;width:300px;height:-webkit-fill-available}.pop-details-left img{height:800px;mask-image:linear-gradient(to top,transparent 45%,#000 60%);-webkit-mask-image:linear-gradient(to top,transparent 45%,#000 60%);overflow:clip;display:block}.pop-navigation-buttons-original{top:0!important;position:absolute!important;padding:2px 4px!important;font-size:10px!important}.pop-details-right{position:absolute;max-width:320px;width:320px;bottom:0;z-index:1}.pop-title{font-size:18px;font-weight:700;margin-bottom:5px;color:#ffb827;text-shadow:1px 1px 0#000,-1px 1px 0#000,-1px -1px 0#000,1px -1px 0#000;overflow:clip;white-space:nowrap;max-width:fit-content;display:block;text-overflow:ellipsis}.pop-rewards-container{display:flex;justify-content:space-between;max-width:320px}.claimPoPButton,.startPoPButton{margin-top:5px;width:320px}#pop_info>.pop-records-container{display:grid;grid-template-columns:repeat(3,1fr);gap:15px;justify-content:end;width:640px;margin-bottom:10px;position:absolute;top:60px;right:15px}.pop-records-container>.pop-record{cursor:pointer}.pop-record-locked,.pop-records-container>.pop-record{position:relative;padding:6px;border-radius:3px;box-shadow:0 1px 3px rgba(0,0,0,.3);height:-webkit-fill-available;width:auto;max-height:100px;overflow:hidden}.pop-record-bg{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;z-index:0}.pop-record-locked{filter:grayscale(1);cursor:not-allowed}.pop-record.selected{outline:2px solid #fc0!important;box-shadow:0 0 10px rgba(255,204,0,.5)!important}.pop-icon{position:absolute;top:5px;left:5px;width:20px;height:20px;z-index:1;filter:drop-shadow(0 0 1px rgba(0,0,0,.6)) drop-shadow(1px 1px 1px rgba(0,0,0,.6)) drop-shadow(-1px -1px 1px rgba(0,0,0,.6)) drop-shadow(1px -1px 1px rgba(0,0,0,.6)) drop-shadow(-1px 1px 1px rgba(0,0,0,.6))}.pop-lvl{top:5px;right:5px;background:rgba(0,0,0,.6);font-size:14px;color:#ffb827;padding:0 3px}.collect_notif,.pop-lvl,.pop-timer{position:absolute;z-index:1}.pop-timer{bottom:5px;background:rgba(0,0,0,.8);color:#fff;padding:1px 3px;border-radius:1px;font-size:10px}.collect_notif{bottom:3px;right:3px}#pop_info>.pop-koban-buttons-container{position:absolute;width:320px;display:flex;flex-direction:row;align-items:center;gap:10px;flex-wrap:nowrap;height:auto;top:8px;right:70px}.pop-koban-buttons-container>.pop-koban-button{display:flex;flex-direction:row;align-items:center;gap:20px;width:160px;padding:0 10px;margin-top:0}.pop-koban-button>.action-cost{display:flex;align-items:end;margin-left:auto}")}async girlsHandler(){this.isLoadingGirls=!0;let e={1:[],2:[],3:[]};for(let t of Object.values(pop_hero_girls))!t||null==t.id_girl||(e[1].push({id:t.id_girl,carac:t.carac1}),e[2].push({id:t.id_girl,carac:t.carac2}),e[3].push({id:t.id_girl,carac:t.carac3}),null!=t.id_places_of_power&&(this.currentPoPGirls[t.id_places_of_power]||(this.currentPoPGirls[t.id_places_of_power]=[]),this.currentPoPGirls[t.id_places_of_power].push(t.id_girl)));this.sortedGirlsCache[1]=e[1].sort((e,t)=>t.carac-e.carac).map(e=>e.id),this.sortedGirlsCache[2]=e[2].sort((e,t)=>t.carac-e.carac).map(e=>e.id),this.sortedGirlsCache[3]=e[3].sort((e,t)=>t.carac-e.carac).map(e=>e.id),this.isLoadingGirls=!1,$(document).trigger("HH_SQoL_PoP_GirlsLoaded")}},x=class e extends t{constructor(){super(...arguments),this.configSchema={baseKey:"noReloadFromClaimingDailyChests",label:"Activities : No reload from claiming daily chests",default:!0,subSettings:[{key:"popupEnabled",default:!0,label:"Show reward popup on claiming"}]}}static shouldRun(){return!0}run(t){if(this.hasRun||!e.shouldRun())return location.pathname.includes("/activities.html");this.hasRun=!0,$(".switch-tab[data-tab='daily_goals']").on("click",()=>{n.doWhenSelectorAvailable(".progress-bar-claim-reward",()=>{this.applyNoReloadFix(t.popupEnabled)})})}applyNoReloadFix(e){let t=this;$(".progress-bar-claim-reward").off("click").on("click",function(a){a.stopPropagation(),a.preventDefault(),$(this).prop("disabled",!0);let i=$(this).attr("tier");if(!i)return;let r={action:"claim_daily_goal_tier_reward",tier:i};daily_goals_member_progression.taken_rewards_array.push(i),shared.animations.loadingAnimation.start(),shared.general.hh_ajax(r,a=>{if(e){let e=a.rewards;shared.reward_popup.Reward.handlePopup(e)}else shared.Hero.updates(a.rewards.heroChangesUpdate,!1);t.checkIfAllChestsClaimed(),shared.animations.loadingAnimation.stop()})}),$(".progress-bar-claim-reward").attr("tooltip","Several QoL: Claim without reload"+(e?"":" & without popup"))}checkIfAllChestsClaimed(){daily_goals_member_progression.taken_rewards_array.length>=Math.min(Math.floor(daily_goals_member_progression.potions_amount/20),5)&&$('[data-tab="daily_goals"] > .collect_notif').remove()}},y=class e extends t{constructor(){super(...arguments),this.configSchema={baseKey:"meRankingInfo",label:"ME : Adds info about rankings in seasonal event",default:!0},this.heroData=null,this.leaderboardData=null}static shouldRun(){return location.pathname.includes("seasonal.html")}run(){this.hasRun||!e.shouldRun()||(this.hasRun=!0,this.injectCSS(),this.hookAjaxRequest())}async injectCSS(){GM_addStyle(".me-ranking-tooltip td,.me-ranking-tooltip th{border:1px solid #ccc;padding:5px;text-align:center}.me-leaderboard-info{position:absolute;right:13rem;width:20px}")}hookAjaxRequest(){$(document).ajaxComplete((e,t,a)=>{"action=leaderboard&feature=seasonal_event_top"===a?.data&&(this.heroData=t.responseJSON?.hero_data,this.leaderboardData=t.responseJSON?.leaderboard,this.hookSpecialHeroRow())})}hookSpecialHeroRow(){n.doWhenSelectorAvailable("#leaderboard_holder > #outer-hero-row",()=>{let e=this.createTooltipTableRankingContent(),t=$('<img class="me-leaderboard-info" src="https://hh.hh-content.com/leagues/ic_rankup.png" tooltip></img>');t.attr("hh_title",e),$("#leaderboard_holder > #outer-hero-row").append(t)})}createTooltipTableRankingContent(){if(!this.heroData||!this.leaderboardData)return"";let e=this.heroData.rank,t=this.heroData.potions,a='<div class="me-ranking-tooltip"><table style="border-collapse: collapse; width: 100%;"><thead><tr><th>Rank</th><th>Resource</th><th>Difference</th></tr></thead><tbody>',i=this.leaderboardData.find(t=>t.rank===e);return[10,50,100,250,500,1e3].forEach(e=>{let r=this.leaderboardData.find(t=>t.rank===e),o=r?.potions??"?",n="?",s="black";if(r){let e=t-r.potions;if(0===e){let e=i?i.id_member:1/0,t=r.id_member;e<t?(n="+0 (above)",s="green"):e>t?(n="+0 (below)",s="red"):(n="= (tie)",s="orange")}else n=e>0?`+${e}`:`${e}`,s=e>0?"green":"red"}a+=`<tr><td>${e}</td><td>${o}</td><td style="color: ${s}; font-weight: bold;">${n}</td></tr>`}),a+="</tbody></table></div>",a}},k=class{constructor(){this.EventInfoLinks={dp_event:"https://forum.kinkoid.com/index.php?/topic/31207-vademecum-rerum-gestarum-ex-haremverse-a-guide-to-the-events/#comment-304655",sm_event:"https://forum.kinkoid.com/index.php?/topic/31207-vademecum-rerum-gestarum-ex-haremverse-a-guide-to-the-events/#comment-309998",cumback_contest:"https://forum.kinkoid.com/index.php?/topic/31207-vademecum-rerum-gestarum-ex-haremverse-a-guide-to-the-events/#comment-304660",org_days:"https://forum.kinkoid.com/index.php?/topic/31207-vademecum-rerum-gestarum-ex-haremverse-a-guide-to-the-events/#comment-304653",legendary_contest:"https://forum.kinkoid.com/index.php?/topic/31207-vademecum-rerum-gestarum-ex-haremverse-a-guide-to-the-events/#comment-304657",mythic_event:"https://forum.kinkoid.com/index.php?/topic/23259-everything-about-mythic-days-revival/",path_event:"https://forum.kinkoid.com/index.php?/topic/31207-vademecum-rerum-gestarum-ex-haremverse-a-guide-to-the-events/#comment-304650",crazy_cumback_contest:"https://forum.kinkoid.com/index.php?/topic/31207-vademecum-rerum-gestarum-ex-haremverse-a-guide-to-the-events/#comment-304661",classic_event:"https://forum.kinkoid.com/index.php?/topic/31207-vademecum-rerum-gestarum-ex-haremverse-a-guide-to-the-events/#comment-304648",lively_scene_event:"https://forum.kinkoid.com/index.php?/topic/31207-vademecum-rerum-gestarum-ex-haremverse-a-guide-to-the-events/#comment-304656",dpg_event:"https://forum.kinkoid.com/index.php?/topic/31207-vademecum-rerum-gestarum-ex-haremverse-a-guide-to-the-events/#comment-309997"}}run(){let e=new URLSearchParams(location.search).get("tab")?.replace(/_\d+$/,"");this.injectCSS(),this.whichEventToCall(e)}async injectCSS(){GM_addStyle(o)}helperCreateNotifButton(e){let t=$('<div class="button-notification-action notif_button_s sm-event-info-button" tooltip="Several QoL: More Info on this event"></div>');return n.doWhenSelectorAvailable(".nc-panel-header .nc-pull-right",()=>{$(".nc-panel-header .nc-pull-right").prepend(t)}),t.off("click").on("click",()=>{GM_openInTab(this.EventInfoLinks[e],{active:!0})}),t}helperReplaceNotifButton(e,t=!1){n.doWhenSelectorAvailable(".nc-pull-right > .button-notification-action",()=>{$(".nc-pull-right > .button-notification-action").attr("tooltip","Several QoL: More Info on this event").off("click").on("click",a=>{t&&(a.preventDefault(),a.stopPropagation(),a.stopImmediatePropagation()),GM_openInTab(this.EventInfoLinks[e],{active:!0})})})}whichEventToCall(e){if(e)switch(e){case"cumback_contest":case"legendary_contest":case"path_event":case"crazy_cumback_contest":case"lively_scene_event":case"dpg_event":return void this.helperCreateNotifButton(e);case"mythic_event":return void this.mythic_eventRun();case"dp_event":return void this.dp_eventRun();case"sm_event":return void this.sm_eventRun();case"event":this.event_Run();default:return}}event_Run(){unsafeWindow.event_data&&"classic"===unsafeWindow.event_data.subtype?this.helperCreateNotifButton("classic_event"):this.helperCreateNotifButton("org_days")}mythic_eventRun(){n.doWhenSelectorAvailable(".nc-pull-right > .button-notification-action",()=>{$(".nc-pull-right > .button-notification-action").removeClass("js-mythic-help-open-button"),this.helperReplaceNotifButton("mythic_event")})}dp_eventRun(){n.doWhenSelectorAvailable(".button-notification-action.notif_button_s",()=>{$(".button-notification-action.notif_button_s").attr("tooltip","Several QoL: More Info on this event").off("click").on("click",e=>{e.preventDefault(),e.stopPropagation(),i.createCommonPopup("event_info",(e,t)=>{e.$dom_element.find(".container-special-bg").append(`<div class="banner">Several QoL - Event Info - DP</div><div class="event-content dp_event"><span>Before going\n into more details read <a target="_blank" href="${this.EventInfoLinks.dp_event}"><strong>this</strong></a> guide made by bolitho<br><br>There are important things to note for this event:<br>First there are some missions that are not in the daily missions list that can appear on easy & hard side :<br>- Claim chest nÂ°X on daily missions (you cannot land on a chest you already claimed)<br>- Claim X number of PoP<br>- Gain PoV potions<br>- Get shards<br>- Score points in contests<br><br>There's one that's <strong>really annoying</strong> that can only appear on the hard side:<br>- Restock the Market<br><br>One info not given is that a challenge cannot be the same on both easy & hard side as such try to lock an annoying mission on the hard side before you get stuck with "Restock the Market"</span></div>`)})})})}sm_eventRun(){this.helperReplaceNotifButton("sm_event");let e=unsafeWindow.sm_event_data,t=shared.timer.buildTimer(e.seconds_until_event_end,GT.design.event_ends_in,"event-timer nc-expiration-label",!1);$(".nc-pull-right").append(t),shared.timer.activateTimers("event-timer.nc-expiration-label"),$("#sultry-mysteries-tabs > #shop_tab").on("click.SeveralQoLEventInfo",function(){$(this).off("click.SeveralQoLEventInfo"),n.doWhenSelectorAvailable(".shop-timer.timer",()=>{let e=$(".shop-timer.timer").attr("data-time-stamp");if(!e||isNaN(Number(e)))return;let t=Number(e)+Math.floor(Date.now()/1e3);p.setSMShopRefreshTimeComparedToServerTS(t)})});let a=p.getSMShopRefreshTimeComparedToServerTS();if(a>server_now_ts){let e=shared.timer.buildTimer(a-server_now_ts,"","severalQoL-event-shop-timer nc-expiration-label",!1);$("#sultry-mysteries-tabs > #shop_tab").append(e),shared.timer.activateTimers("severalQoL-event-shop-timer.nc-expiration-label")}}},w=class{run(){this.injectCSS(),n.doWhenSelectorAvailable("[rel='path-of-valor']",()=>{this.PoVPoGHandler()}),this.SMEventHandler()}async injectCSS(){GM_addStyle(".timer-box .severalQoL-event-timer.expired{color:#f5252a}[rel=sm_event] .severalQoL-event-timer{padding-bottom:0!important}.severalQoL-PoVPoG-timer{position:absolute;left:6px}.potions-paths-buttons .severalQoL-PoVPoG-timer{bottom:-2px;left:8px}.severalQoL-PoVPoG-timer>p{font-size:12px;color:#8ec3ff}.potions-paths-buttons .severalQoL-PoVPoG-timer>p{font-size:10px;color:#8ec3ff}")}SMEventHandler(){let e=p.getSMShopRefreshTimeComparedToServerTS(),t=$("[rel='sm_event'][href!='#']").find(".timer-box");if(0==e||t)if(e>server_now_ts){let a=shared.timer.buildTimer(e-server_now_ts,GT.design.market_new_stock,"severalQoL-event-timer nc-expiration-label",!1);t.prepend(a),shared.timer.activateTimers("severalQoL-event-timer.nc-expiration-label")}else t.prepend(`<div class="severalQoL-event-timer expired">${GT.design.sm_event_restock_now}</div>`);else p.setSMShopRefreshTimeComparedToServerTS(0)}PoVPoGHandler(){let e=p.getPoVEndTimeComparedToServerTS(),t=p.getPoGEndTimeComparedToServerTS();function a(e,t,a){for(;e<server_now_ts;)e+=a;let i=shared.timer.buildTimer(e-server_now_ts,GT.design.event_ends_in,"severalQoL-PoVPoG-timer nc-expiration-label",!1);t.find(".white_text").append(i)}0!==e&&a(e,$("[rel='path-of-valor']"),1209600),0!==t&&a(t,$("[rel='path-of-glory']"),3024e3),shared.timer.activateTimers("severalQoL-PoVPoG-timer.nc-expiration-label",()=>{})}},P=class{run(){this.injectCSS();let e=+unsafeWindow.time_remaining;"/path-of-valor.html"===window.location.pathname?(p.setPoVEndTimeComparedToServerTS(server_now_ts+e),this.replacePoVNotifButton()):"/path-of-glory.html"===window.location.pathname&&(p.setPoGEndTimeComparedToServerTS(server_now_ts+e),this.replacePoGNotifButton())}async injectCSS(){GM_addStyle(o)}replacePoVNotifButton(){n.doWhenSelectorAvailable(".button-notification-action.notif_button_s",()=>{$(".button-notification-action.notif_button_s").attr("tooltip","Several QoL: More Info on this event").off("click").on("click",e=>{e.preventDefault(),e.stopImmediatePropagation(),GM_openInTab("https://forum.kinkoid.com/index.php?/topic/31207-vademecum-rerum-gestarum-ex-haremverse-a-guide-to-the-events/#comment-310477",{active:!0})})})}replacePoGNotifButton(){n.doWhenSelectorAvailable(".button-notification-action.notif_button_s",()=>{$(".button-notification-action.notif_button_s").attr("tooltip","Several QoL: More Info on this event").off("click").on("click",e=>{e.preventDefault(),e.stopImmediatePropagation(),GM_openInTab("https://forum.kinkoid.com/index.php?/topic/31207-vademecum-rerum-gestarum-ex-haremverse-a-guide-to-the-events/#comment-310673",{active:!0})})})}},S=class{constructor(){this.EventInfoSeasonalLinks=["https://forum.kinkoid.com/index.php?/topic/31207-vademecum-rerum-gestarum-ex-haremverse-a-guide-to-the-events/#comment-310475","https://forum.kinkoid.com/index.php?/topic/31207-vademecum-rerum-gestarum-ex-haremverse-a-guide-to-the-events/#comment-310068","https://forum.kinkoid.com/index.php?/topic/31207-vademecum-rerum-gestarum-ex-haremverse-a-guide-to-the-events/#comment-310473"]}run(){let e=unsafeWindow.event_functionalities?.id_seasonal_event_type;e&&this.EventInfoSeasonalLinks[e-1]&&this.replaceSeasonalNotifButton(this.EventInfoSeasonalLinks[e-1])}replaceSeasonalNotifButton(e){e&&n.doWhenSelectorAvailable(".button-notification-action.notif_button_s",()=>{$(".button-notification-action.notif_button_s").attr("tooltip","Several QoL: More Info on this event").off("click").on("click",t=>{t.preventDefault(),t.stopImmediatePropagation(),GM_openInTab(e,{active:!0})})})}},T=class e extends t{constructor(){super(...arguments),this.configSchema={baseKey:"eventInfo",label:"<span tooltip='Click on the Information top right of events'>Event Info : Show guides, tips, tricks & more info on events</span>",default:!0}}static shouldRun(){return"/event.html"===location.pathname||"/home.html"===location.pathname||"/path-of-glory.html"===location.pathname||"/path-of-valor.html"===location.pathname||"/seasonal.html"===location.pathname||"/world-boss-event"===location.pathname||"/season.html"===location.pathname||"/love-raids.html"===location.pathname}run(){if(!this.hasRun&&e.shouldRun())switch(this.hasRun=!0,location.pathname){case"/home.html":this.runHome();break;case"/event.html":this.runEvent();break;case"/path-of-glory.html":case"/path-of-valor.html":this.runPathes();break;case"/seasonal.html":this.runSeasonal();break;case"/season.html":this.runSeason();break;case"/love-raids.html":this.runLoveRaids()}}runHome(){(new w).run()}runEvent(){(new k).run()}runPathes(){(new P).run()}runSeasonal(){(new S).run()}runSeason(){this.helperReplaceNotifButton("https://forum.kinkoid.com/index.php?/topic/31207-vademecum-rerum-gestarum-ex-haremverse-a-guide-to-the-events/#comment-310674")}runLoveRaids(){this.helperReplaceNotifButton("https://forum.kinkoid.com/index.php?/topic/31207-vademecum-rerum-gestarum-ex-haremverse-a-guide-to-the-events/#comment-316577")}helperReplaceNotifButton(e){n.doWhenSelectorAvailable(".button-notification-action.notif_button_s",()=>{$(".button-notification-action.notif_button_s").attr("tooltip","Several QoL: More Info on this event").off("click").on("click",()=>{GM_openInTab(e,{active:!0})})})}},R=class e{static run(){let t=GM_info.script.version,a=s.getStoredScriptVersion();if(e.addOptionToHHPlusPlusConfig(),a===t)return;let[r,o,n]=a.split(".").map(Number);if(21===o&&n<5&&GM_listValues().filter(e=>e.includes("VillainShardTrackerTrackedGirls")).forEach(e=>{let t=GM_getValue(e,{});Object.values(t).forEach(e=>{e.skins&&e.skins.forEach(e=>{null===e.dropped_shards&&(e.dropped_shards=0,e.number_fight=0)})}),GM_setValue(e,t)}),21===o&&n<5&&GM_listValues().filter(e=>e.includes("LeagueCurrentRank")).forEach(e=>{GM_deleteValue(e)}),21===o&&n<5){let e={50249610:3,92792577:3,118563600:3,125597344:6,143960742:6,199686770:6,219651566:3,225777755:6,230575971:6,237137080:6,270574600:6,309097753:6,323149196:3,328223265:6,330911919:6,344662796:6,372106614:6,376374790:6,413198545:3,423714615:3,423864623:6,434436290:3,445743639:6,451625351:6,452255257:1,455833593:6,474799411:6,507945521:6,538753178:3,550842002:6,577768127:3,580295730:3,617303855:6,690645314:6,772982297:3,804990761:6,850285776:5,861690823:6,886658459:6,899533146:3,935005622:6,948443498:6,954976932:3,967164534:6,973183986:5,981990704:6,994926972:5},t={104175263:3,114069819:6,116128230:3,140136826:3,141953071:1,144579731:6,147618406:6,215363542:6,239681148:3,279206945:3,283904101:3,379189043:3,444883622:3,460118458:3,470677385:3,479313467:5,480186209:6,480202265:5,527749796:3,573898614:6,581319811:6,677988426:3,758023727:3,821038259:5,839967399:3,923039656:6,927113807:3,934147842:6,938478655:5,961765788:6,966982384:6,973778141:3,999151109:3},a={118563600:3,125597344:6,143960742:6,199686770:6,206065449:3,213233570:1,225777755:6,230575971:6,237137080:6,247281495:3,270574600:6,279051760:3,309097753:6,323149196:3,328223265:6,330911919:6,344662796:6,372106614:6,376374790:6,413198545:3,423714615:3,423864623:6,434436290:3,445743639:6,451625351:6,455833593:6,474799411:6,507945521:6,530721638:3,550842002:6,577768127:3,580295730:3,617303855:6,690645314:6,712589405:6,772982297:3,780551182:3,804990761:6,850285776:5,861690823:6,886658459:6,899533146:3,935005622:6,948443498:6,954976932:3,960631959:6,967164534:6,981990704:6},i={101153047:3,114336439:3,146695697:5,183212158:3,230973002:3,231724666:3,257517207:3,264101012:3,295382943:3,296537297:3,297170634:6,314510458:3,396472004:3,437221289:6,483424352:5,508254527:5,518489705:3,653504776:6,656281921:5,674185624:3,686233571:5,686486032:3,709879124:3,775558965:3,840914604:6,866805363:6,869508297:5,945604178:5,986766165:3},r={132402253:3,172105527:3,279481228:3,319875013:3,339061440:3},o={1:3,121144525:3,122484257:3,129394075:3,132762958:3,165792295:3,171883542:3,218118569:3,219589262:3,229180984:3,269567651:3,270927503:3,279733880:3,284864117:3,303777744:3,304482219:3,313362316:3,318747451:3,323873919:3,326134747:3,338699357:3,341704891:3,348879045:3,360319370:3,368469209:3,378503948:3,393195592:3,393928303:3,423240108:5,465699978:3,484962893:3,488275225:3,500141122:3,514825887:3,540573241:3,541021806:3,566307486:3,587994605:3,601454529:3,619131345:3,625889131:3,651345338:3,661298782:3,688910029:3,699471796:3,704722252:3,761012504:3,771348244:3,811833436:3,812521921:3,812699711:5,815875270:3,830814672:3,834210785:3,837317838:5,862585404:3,865845259:3,879068134:3,879574564:3,890429878:3,910924260:3,917101548:3,936618900:3,961792252:3,962247749:3,973412147:3};GM_listValues().filter(e=>e.includes("VillainShardTrackerTrackedGirls")).forEach(n=>{let s=GM_getValue(n,{}),l=(()=>{switch(n){case"nutakuVillainShardTrackerTrackedGirls":case"hentaiVillainShardTrackerTrackedGirls":return e;case"nutaku_cVillainShardTrackerTrackedGirls":case"comix_cVillainShardTrackerTrackedGirls":return t;case"gh_nutakuVillainShardTrackerTrackedGirls":case"gayVillainShardTrackerTrackedGirls":return a;case"nutaku_tVillainShardTrackerTrackedGirls":case"star_tVillainShardTrackerTrackedGirls":return i;case"nutaku_stargayVillainShardTrackerTrackedGirls":case"dotcom_stargayVillainShardTrackerTrackedGirls":return r;case"nutaku_startransVillainShardTrackerTrackedGirls":case"dotcom_startransVillainShardTrackerTrackedGirls":return o;default:return console.warn(`unknown key: ${n}`),{}}})();Object.entries(s).forEach(([e,t])=>{t.grade=l[+e]??t.grade}),GM_setValue(n,s)})}o<27&&s.getShowUpdatePopup()&&(e.injectCSS(),i.createCommonPopup("update-several-qol",(e,a)=>{let i=e.$dom_element.find(".container-special-bg");i.append(`<div class="banner">Several QoL - Update to ${t}</div>`),i.append(` <div class="changelog-content hh-scroll"> <h2>New Feature: In Game Badges</h2> <p> For people that have contributed significantly or for people that support me on <a href="https://patreon.com/infarcactusHH" target="_blank" style="color:green">patreon</a> </p> <h3>Small Feature : Compact League Style Tweak</h3> <p> This style tweak is not meant to be for everyone, mostly people in highest league already </p> <h3>Small Feature: No confirm when buying League Energy (under leagues QoL)</h3> <h3> Fix: Shard Tracker having horizontal scrollbar when reaching a certain amount of tracked ${GT.design.Girls} </h3> </div> `);let r=$(' <div class="footer"> <span>Thank you for using Several QoL! </span> <span style="margin-left:10px" tooltip="Won\'t be show often only on new features"> Show this popup:</span> </div> '),o=$('<input name=\'severalQoL-show-update-popup\' type="checkbox" tooltip="Won\'t be shown often only on new features" checked>');o.on("change",()=>{let e=o.prop("checked");s.setShowUpdatePopup(e)}),r.append(o),i.append(r)})),s.setStoredScriptVersion(t)}static async injectCSS(){GM_addStyle(".popup_wrapper>#popup-update-several-qol{width:1020px;height:32rem;top:3rem;left:.62rem}#popup-update-several-qol>#container-update-several-qol.container-special-bg{display:flex;flex-direction:column;height:100%}#popup-update-several-qol close{width:2.4rem;height:2.2rem;background-image:url(/images/clubs/ic_xCross.png);opacity:1}#container-update-several-qol{width:100%;height:100%;box-shadow:none;border:2px solid #f90;align-content:center}#container-update-several-qol>.banner{width:100%;height:3rem;font-size:1.8rem;font-weight:700;color:#ffb827;text-align:center;line-height:3rem;border-bottom:2px solid #f90;flex-shrink:0}#container-update-several-qol>.changelog-content{flex:1 1 auto;padding:0 1rem 1rem;overflow:auto;text-align:left}#container-update-several-qol>.footer{width:100%;height:3rem;font-size:1.4rem;font-weight:700;color:#ffb827;text-align:center;line-height:3rem;border-top:2px solid #f90;flex-shrink:0;display:flex;align-items:center;justify-content:center}#container-update-several-qol>.footer input[type=checkbox]{vertical-align:middle;margin-left:.5rem;height:-webkit-fill-available}#container-update-several-qol>.changelog-content h2{font-size:25px;color:#f5252a;margin-top:1rem;margin-bottom:0}#container-update-several-qol>.changelog-content h3{font-size:20px;color:#ff6f61;margin-top:1rem;margin-bottom:0}#container-update-several-qol>.changelog-content p{margin-top:0}")}static addOptionToHHPlusPlusConfig(){let e=s.getShowUpdatePopup();n.doWhenSelectorAvailable(".hh-plus-plus-config-button"+(unsafeWindow.hhPlusPlusConfig?.BoobStrapped?".boob-strapped":":not(.boob-strapped)"),t=>{t.on("click.severalQoLAddConfig",()=>{t.off("click.severalQoLAddConfig"),n.doWhenSelectorAvailable(".group-panel[rel='severalQoL']",t=>{let a=$(`<div class="config-setting ${e?"enabled":""}"> <label class="base-setting"> <span tooltip="It will only appear for important update, or new features">Show update Popup</span> </label> </div>`),i=$(`<input type="checkbox" ${e?'checked="checked"':""}>`);a.find("label").append(i),i.on("change",()=>{e=!e,s.setShowUpdatePopup(e),e?a.addClass("enabled"):a.removeClass("enabled")}),t.children().first().append(a)})})})}},G=class e extends t{constructor(){super(...arguments),this.configSchema={baseKey:"loveRaids",label:"<span tooltip='Show mysterious raids, CSS tweaks, Hide completed raids ...'>Additional Love Raids tweaks</span>",default:!0,subSettings:[{key:"hideRaidCardsUntillStart",default:!1,label:'<span tooltip="Hides raids (on season, champion etc) until they start (5min before starting they\'ll appear)">Hide raids cards until they start</span>'}]}}static shouldRun(){return location.pathname.includes("/home.html")||void 0!==unsafeWindow.love_raids&&love_raids?.length}run(t){if(!this.hasRun&&e.shouldRun())switch(this.hasRun=!0,location.pathname){case"/home.html":this.homePageModifications();break;case"/love-raids.html":this.loveRaidsPageModifications();break;default:n.doWhenSelectorAvailable("a.love-raid-container.raid",()=>{this.handleRaidCards(t.hideRaidCardsUntillStart)})}}handleRaidCards(e){if(void 0===love_raids)return;let t=g.getReducedLoveRaids();$("a.love-raid-container.raid").each(function(a,i){let r=i.href.match(/[?&]raid=(\d+)/)?.[1];if(!r)return;let o=+r;!function(t,a,i){a.all_is_owned||"upcoming"===a.status&&e&&a.seconds_until_event_start>300?i.remove():t?.hidden&&(i.style.filter="opacity(40%) grayscale(100%)",i.setAttribute("tooltip","This raid is marked as hidden"))}(t.find(e=>e.id_raid===o),love_raids.find(e=>e.id_raid===o),i)})}loveRaidsPageModifications(){if(void 0===love_raids)return;!async function(){GM_addStyle(`.notify-toggle {background-image: url(${IMAGES_URL}/ic_new.png);`),GM_addStyle("#love-raids .raid-card:not(.expanded) .raid-content .info-box{padding-top:0;top:4.8em}#love-raids .raid-card:not(.expanded).multiple-girl .raid-content .info-box .classic-girl:nth-of-type(2) div.shards-container{top:0}.notify-toggle{position:relative;display:inline-block;height:25px;width:25px;background-size:contain;background-repeat:no-repeat;background-position:center;opacity:.5;filter:grayscale(1);margin-left:5px}.raid-name[data-notify=true] .notify-toggle{opacity:1;filter:grayscale(0)}.love-raids-hide-completed-btn>img{margin-left:10px;height:2rem;width:50px;vertical-align:middle;cursor:pointer}.raid-visibility-toggle{margin-left:5px;cursor:pointer}")}();let e,t=function(){let e=g.getLoveRaidNotifications(),t=g.getReducedLoveRaids(),a=new Map(t.map(e=>[e.id_raid,!!e.hidden])),i=e.filter(e=>love_raids.some(t=>t.id_raid===e));g.setLoveRaidNotifications(i);let r=love_raids.map(e=>{let t,i,{id_raid:r,all_is_owned:o}=e;if("ongoing"===e.status){let{seconds_until_event_end:a}=e;t=0,i=server_now_ts+a}else{let{event_duration_seconds:a,seconds_until_event_start:r}=e;t=server_now_ts+r,i=t+a}return{all_is_owned:o,id_raid:r,start:t,end:i,hidden:a.get(r)??!1}});return g.setReducedLoveRaids(r),{reducedLoveRaids:r,loveRaidNotifs:e}}(),a=t.loveRaidNotifs,r=new Set(t.reducedLoveRaids.filter(e=>e.hidden).map(e=>e.id_raid)),o=g.getHideHiddenRaids(),s=()=>{if(e?.remove(),o&&r.size>0){let t=[...r].map(e=>`[data-raid-id="${e}"]`).join(",");e=GM_addStyle(`${t}{display:none!important;}`)}};function l(e){e&&!$(e).find(".redirect_button").length&&$(e).find(".shards-container").append('<a class="redirect_button blue_button_L" disabled>Go</a>')}s(),n.doWhenSelectorAvailable(".raid-card",()=>{(function(){let e,t=g.getShouldHideCompletedRaids();t&&(e=GM_addStyle(".raid-card.grey-overlay{display:none!important;}")),n.doWhenSelectorAvailable(".head-section > a",a=>{let i=$(` <div class="eye btn-control love-raids-hide-completed-btn" tooltip="Toggle hiding completed raids"> <img src="${IMAGES_URL}/quest/${t?"ic_eyeopen":"ic_eyeclosed"}.svg"> </div> `);a.after(i),i.on("click",()=>{t=!t,g.setShouldHideCompletedRaids(t),i.find("img").attr("src",`${IMAGES_URL}/quest/${t?"ic_eyeopen":"ic_eyeclosed"}.svg`),t?e=GM_addStyle(".raid-card.grey-overlay{display:none!important;}"):e?.remove()});let r=$(' <div class="btn-control love-raids-visibility-toggle" tooltip="Show/hide raids marked as ð" style="margin-left:10px;cursor:pointer;font-size:1.5rem;line-height:1"></div> '),n=()=>{r.text(o?"ð":"ðµ")};n(),i.after(r),r.on("click",()=>{o=!o,n(),s(),g.setHideHiddenRaids(o)})})})(),n.doWhenSelectorAvailable(".raid-content > .eye.btn-control",e=>{e.remove()}),n.doWhenSelectorAvailable(".raid-card",()=>{void 0!==love_raids&&$(".raid-card").each((e,t)=>{let i=love_raids[e];if(void 0===i)return void console.warn("love_raids data is undefined for index ",e);let o=$(t);return o.attr("data-raid-id",i.id_raid.toString()),i.all_is_owned?void 0:(function(e,t){if("full"!==e.announcement_type_name&&"ongoing"!==e.status){let a=t.find(".girl-img.avatar");a.attr("src",`${IMAGES_URL}/pictures/girls/${e.id_girl}/ava0.png`),"hidden"===a.css("visibility")&&a.css("visibility","visible")}}(i,o),void n.doWhenSelectorAvailable(".raid-name > .type_icon",()=>{!function(e,t){let i=t.find(".raid-name");a.includes(e.id_raid)&&i.attr("data-notify","true");let o=$('<span tooltip="Toggle favorite (shows an indicator on home page when raid is ongoing)" class="notify-toggle"></span>');o.on("click",t=>{t.stopPropagation(),a.includes(e.id_raid)?(a=a.filter(t=>t!==e.id_raid),i.attr("data-notify","false")):(a.push(e.id_raid),i.attr("data-notify","true")),g.setLoveRaidNotifications(a)}),i.append(o);let n=r.has(e.id_raid),l=$(`<span tooltip="Toggle raid visibility" class="raid-visibility-toggle">${n?"ð":"ðµ"}</span>`);l.on("click",t=>{t.stopPropagation();let a=!r.has(e.id_raid);(function(e,t){let a=g.getReducedLoveRaids().map(a=>a.id_raid===e?{...a,hidden:t}:a);g.setReducedLoveRaids(a),t?r.add(e):r.delete(e),s()})(e.id_raid,a),l.text(a?"ð":"ðµ")}),i.append(l)}(i,o)}))})}),unsafeWindow.HHPlusPlus?.Helpers?.getGirlDictionary().then(e=>{!function(e){if(void 0===love_raids)return;let t=love_raids.map(t=>e.get(t.id_girl.toString()));$(".raid-card").each((e,a)=>{if(!t[e])return;let r=$(a),{name:o,shards:s,skins:d}=t[e],{id_girl:p,girl_data:{grade_skins:c}}=love_raids[e],u=shared.general.getDocumentHref(`/characters/${p}`),h=i.getWikiPageForCurrentGame(o);if(c.length&&!a.classList.contains("multiple-girl")&&d){let e=d.filter(e=>33!==e.shards_count)[0],t=$(a.querySelector(".girl-img.left"));a.classList.add("multiple-girl"),a.classList.remove("single-girl"),r.find("div.raid-content").append($(` <div class="right-girl-container"> <img class="girl-img right" src="${IMAGES_URL}/pictures/girls/${p}/grade_skins/grade_skin${e.num_order}.png" alt="Right" style="margin-top:${t.css("marginTop")}"> </div> `)),r.find(".info-box .info-container .classic-girl").after($(` <div class="classic-girl"> <div class="shards-container"> <div class="progress-container"> <div class="shards_bar_wrapper"> <div class="shards"> <span class="skins_shard_icn"></span> <p><span>${e.shards_count}/33</span></p> </div> <div class="shards_bar skins-shards"> <div class="bar basic-progress-bar-fill pink" style="width:${e.shards_count/33*100}%"></div> </div> </div> </div> <a href="" class="redirect_button blue_button_L" disabled>Go</a> </div> <div class="border-bottom"></div> </div> `))}let g=a.querySelectorAll(".classic-girl"),m=g[0],f=g[1];n.doWhenSelectorAvailable(".raid-name span span",()=>{r.find(".raid-name > span > span").first().text(`${o} ${GT.design.love_raid}`),h&&r.find(".girl-name").html(`<a href="${h}" target="_blank">${o}</a>`)}),l(m),l(f);let _=a.querySelectorAll(".redirect_button");if(100===s&&(m&&(m.querySelector(".objective").innerText=GT.design.girl_town_event_owned_v2,_[0].removeAttribute("disabled"),_[0].href=u),f)){let e=f.querySelector(".shards_bar .bar")?.style?.width;e&&100===parseFloat(e)&&(_[1].removeAttribute("disabled"),_[1].href=u)}})}(e)})})}homePageModifications(){let e=g.getReducedLoveRaids(),t=g.getLoveRaidNotifications();n.doWhenSelectorAvailable(".raids",()=>{0!==e.length&&0!==t.length&&e.reduce((e,a)=>!!(a.start<server_now_ts&&a.end>server_now_ts&&t.includes(a.id_raid)&&!a.all_is_owned&&!a.hidden&&a.end>server_now_ts)||e,!1)&&$(".raids").append(`<img class="new_notif" src="${IMAGES_URL}/ic_new.png" style="position:relative" alt="!">`),0!==e.length&&function(){let{ongoing_love_raids_count:t,upcoming_love_raids_count:a}=unsafeWindow,i=0,r=0,o=0;e.forEach(e=>{e.end<server_now_ts?i+=1:e.all_is_owned||e.hidden||(e.start<server_now_ts?r+=1:o+=1)});let n=e.length-i<t+a,s=$(".raids .raids-amount");s.first().html(`<span ${n?'style="color:pink"':""}>${r}</span> ${GT.design.love_raid}`),s.last().html(`<span ${n?'style="color:pink"':""}>${o}</span> ${GT.design.upcoming_love_raids}`)}()})}},C=class e extends t{constructor(){super(...arguments),this.configSchema={baseKey:"fixSessID",label:"<span tooltip='For example when viewing some scenes'>Fix session in URLs</span>",default:location.hostname.startsWith("nutaku")}}static shouldRun(){return location.hostname.startsWith("nutaku")}run(){this.hasRun||!e.shouldRun()||(this.hasRun=!0,"/home.html"===location.pathname&&$(document).on("click.severalQoL_toggleFixSessID",'input[name="severalQoL_fixSessID"]',()=>{m.clearSessID()}),unsafeWindow.PLATFORM_SESS&&unsafeWindow.PLATFORM_COOKIELESS&&(m.setSessID(unsafeWindow.PLATFORM_SESS),$(document).on("click","#girl_preview_btn",()=>{n.doWhenSelectorAvailable(".scene-preview_wrapper.unlocked",e=>{e.each((e,t)=>{let a=$(t).find("img.scene-preview");0!==a.length&&a.attr("src",function(e,t){return t.includes("sess=")?t:t+`?sess=${unsafeWindow.PLATFORM_SESS}`})})})})))}},M=class e extends t{constructor(){super(...arguments),this.configSchema={baseKey:"villainShardTracker",label:"<span tooltip='Display is still a WIP'>Tracks your Legendary & Mythic drops from Villains</span>",default:!0},this.shouldTrackShards=!1,this.trackedRarities=["mythic","legendary"]}static shouldRun(){return location.pathname.includes("/troll-pre-battle.html")||location.pathname.includes("/troll-battle.html")}async injectCSS(){GM_addStyle(".popup_wrapper>#popup-drop-log-several-qol{width:1020px;height:550px;top:.62rem;left:.62rem}#popup-drop-log-several-qol>#container-drop-log-several-qol.container-special-bg{display:flex;flex-direction:column;height:100%}#popup-drop-log-several-qol close{width:2rem;height:2rem;top:.5rem;right:.5rem;background-image:url(/images/clubs/ic_xCross.png);opacity:1}#container-drop-log-several-qol{width:100%;height:100%;box-shadow:none;border:2px solid #f90;align-content:center}#container-drop-log-several-qol>.title{position:absolute;width:1020px;height:2rem;top:-1rem;left:0;font-size:18px;font-weight:400;letter-spacing:.22px;color:#ffb827;text-shadow:-1px -1px 0#000,1px -1px 0#000,-1px 1px 0#000,1px 1px 0#000,-2px -2px 5px rgba(255,159,0,.4),2px -2px 5px rgba(255,159,0,.4),-2px 2px 5px rgba(255,159,0,.4),2px 2px 5px rgba(255,159,0,.4),0 0 10px rgba(255,159,0,.4);text-align:center}#container-drop-log-several-qol>.changelog-content{flex:1 1 auto;padding:0 1rem 1rem;overflow:auto;text-align:left}#show-drop-log-several-qol img{position:absolute;right:0;top:15px}#container-drop-log-several-qol div.drop-log{margin:10px 0;overflow:hidden;display:flex;flex-direction:row}#container-drop-log-several-qol div.girl-grid{display:grid;grid-template-columns:repeat(3,1fr);grid-auto-rows:max-content;gap:8px;height:525px;overflow-y:auto;padding:0 18.7px;border-radius:0 0 4px 4px}#container-drop-log-several-qol div[girl]{width:100%;height:100%;padding:7px 5px;margin-top:1px;border-radius:4px;display:flex;align-content:flex-start;align-items:flex-start;align-self:flex-start;cursor:pointer}#container-drop-log-several-qol div[girl].opened,#container-drop-log-several-qol div[girl]:hover{background-color:#ec5d6b;background-image:linear-gradient(to right,#ffc37c 0,#c41b53 100%)}#container-drop-log-several-qol div[girl]>.left{box-shadow:0 0 5px 1px rgba(52,0,15,.75),inset 0 0 8px rgba(55,30,103,.4);height:4rem;width:4rem;position:relative;z-index:3;margin-left:3px;background-color:#ccd7dd;background-image:linear-gradient(to bottom,#034,#ccd7dd);border-radius:4px;border:2px solid #fff!important}#container-drop-log-several-qol div[girl]>.left>img{width:100%;height:100%;position:absolute;left:0;top:0}#container-drop-log-several-qol div[girl]>.left .mythic{background:radial-gradient(closest-side at 50% 50%,#f5a866 0,#ec0039 51%,#9e0e27 100%)0 0 no-repeat padding-box}#container-drop-log-several-qol div[girl]>.left .legendary{background-image:url(/images/legendary.png);background-size:contain}#container-drop-log-several-qol div[girl]>.left .epic{background:#ffb244}#container-drop-log-several-qol div[girl]>.left .rare{background:#23b56b}#container-drop-log-several-qol div[girl]>.left .common,#container-drop-log-several-qol div[girl]>.left .starting{background:#8d8e9f}#container-drop-log-several-qol div[girl]>.right{padding:0 8px;width:136px;height:50px;position:relative}#container-drop-log-several-qol div[girl]>.right h4{position:relative;text-align:left;font-size:14px;font-weight:400;letter-spacing:.22px;color:#fff;margin:3px 0-3px;height:20px;text-overflow:ellipsis;overflow:hidden;white-space:nowrap;max-width:206px}#container-drop-log-several-qol div[girl]>.right .g_infos{font-size:11px;font-weight:400;letter-spacing:.22px;color:#fff;text-shadow:1px 1px 0#000,-1px 1px 0#000,-1px -1px 0#000,1px -1px 0#000;display:flex;flex-direction:row;flex-wrap:nowrap;justify-content:flex-start;align-content:center;align-items:center;align-self:center}#container-drop-log-several-qol div[girl]>.right .g_infos>div>g{display:inline-block;width:16px;height:16px;background:url(/images/design_v2/affstar_S.png)center no-repeat;background-size:contain;margin:0-1px 1px -2px}#container-drop-log-several-qol div[girl]>.right .drop-display{margin-top:-6px;height:35px;display:flex;flex-direction:row;column-gap:5px;justify-content:flex-start;align-items:center;font-size:14px}#container-drop-log-several-qol div[girl]>.right .drop-display span.label,#container-drop-log-several-qol div[girl]>.right h4{text-shadow:1px 1px 0#4d2f17,-1px 1px 0#4d2f17,-1px -1px 0#4d2f17,1px -1px 0#4d2f17}#container-drop-log-several-qol div[girl]>.right .drop-display span.icon{display:inline-block;width:20px;height:20px;background-size:contain;background-position:center;background-repeat:no-repeat;padding:0}#container-drop-log-several-qol div[girl]>.right .drop-display span.icon.fights{width:17px;height:17px}#container-drop-log-several-qol div[girl]>.right .drop-display span.icon.shards{margin-left:-8px}#container-drop-log-several-qol div[girl]>.right .drop-display>div.drop-rate{display:none}#container-drop-log-several-qol div[girl]>.right .drop-display span.shards{background-image:url(/images/pictures/design/shards.png)}#container-drop-log-several-qol div[girl]>.right .drop-display span.fights{background-image:url(/images/pictures/design/ic_topbar_energy_fight.png)}#container-drop-log-several-qol div[girl]>.right .drop-display span.icon{margin:0 0 0-5px}#container-drop-log-several-qol .girl-detail .detail-stats .drop-display>div,#container-drop-log-several-qol div[girl]>.right .drop-display>div{display:flex;align-items:center;gap:6px}#container-drop-log-several-qol .drop-log>.girl-detail{width:320px;min-width:320px;height:525px;overflow-y:auto;padding:0 10px}#container-drop-log-several-qol .girl-detail .graded-detail>g{display:inline-block;width:25px;height:25px;background:url(/images/design_v2/affstar_S.png)center no-repeat;background-size:contain}#container-drop-log-several-qol .girl-detail .detail-stats .drop-display span.icon,#container-drop-log-several-qol .girl-detail .skin-entry .drop-display span.icon,#container-drop-log-several-qol div[girl]>.right .drop-display span.icon{vertical-align:middle;display:inline-flex;align-items:center;justify-content:center}#container-drop-log-several-qol .girl-detail .event-source-section{margin-top:10px;padding:3px 10px;background:rgba(0,0,0,.3);border-radius:4px}#container-drop-log-several-qol .girl-detail .detail-stats h3,#container-drop-log-several-qol .girl-detail .event-source-section h3,#container-drop-log-several-qol .girl-detail .skins-section h3{font-size:14px;color:#ffb827;margin:0;text-shadow:1px 1px 0#000}#container-drop-log-several-qol .girl-detail .event-picker{width:100%;padding:6px 10px;margin:5px 0;border:1px solid #f90;border-radius:4px;background:linear-gradient(to bottom,#2a1a0a,#1a0a00);color:#ffb827;font-size:13px;cursor:pointer;outline:0;appearance:none;-webkit-appearance:none;-moz-appearance:none}#container-drop-log-several-qol .girl-detail .event-picker:hover{border-color:#ffb827}#container-drop-log-several-qol .girl-detail .event-picker:focus{border-color:#fc0;box-shadow:0 0 5px rgba(255,153,0,.5)}#container-drop-log-several-qol .girl-detail .event-picker option{background:#1a0a00;color:#ffb827;font-size:15px}#container-drop-log-several-qol .girl-detail .detail-stats,#container-drop-log-several-qol .girl-detail .skins-section{margin-top:10px;padding:3px 10px;background:rgba(0,0,0,.3);border-radius:4px}#container-drop-log-several-qol .girl-detail .detail-stats .drop-display{justify-content:center}#container-drop-log-several-qol .girl-detail .detail-stats .drop-display span.label,#container-drop-log-several-qol .girl-detail-content>h2{text-shadow:1px 1px 0#4d2f17,-1px 1px 0#4d2f17,-1px -1px 0#4d2f17,1px -1px 0#4d2f17}#container-drop-log-several-qol .girl-detail .detail-stats .drop-display span.icon{display:inline-block;width:24px;height:24px;background-size:contain;background-position:center;background-repeat:no-repeat;margin-left:-5px}#container-drop-log-several-qol .girl-detail .detail-stats .drop-display span.shards{background-image:url(/images/pictures/design/shards.png)}#container-drop-log-several-qol .girl-detail .detail-stats .drop-display span.fights{background-image:url(/images/pictures/design/ic_topbar_energy_fight.png)}#container-drop-log-several-qol .girl-detail .skins-list{display:flex;flex-direction:column;gap:5px;padding-bottom:3px}#container-drop-log-several-qol .girl-detail .skin-entry{display:flex;align-items:center;gap:10px;padding:3px;background:rgba(255,255,255,.05);border-radius:4px}#container-drop-log-several-qol .girl-detail .skin-ico{width:40px;height:40px;border-radius:4px;overflow:hidden;border:1px solid #fff;flex-shrink:0}#container-drop-log-several-qol .girl-detail .skin-ico img{width:100%;height:100%;object-fit:cover}#container-drop-log-several-qol .girl-detail .detail-stats .drop-display,#container-drop-log-several-qol .girl-detail .skin-entry .drop-display{display:flex;flex-direction:row;align-items:center;gap:7px;margin:0;height:auto}#container-drop-log-several-qol .girl-detail .skin-entry .drop-display span.label{text-shadow:1px 1px 0#4d2f17,-1px 1px 0#4d2f17,-1px -1px 0#4d2f17,1px -1px 0#4d2f17;vertical-align:middle}#container-drop-log-several-qol .girl-detail .skin-entry .drop-display span.icon{display:inline-block;width:25px;height:22px;background-size:contain;background-position:center;background-repeat:no-repeat;margin-left:-3px}#container-drop-log-several-qol .girl-detail .skin-entry .drop-display span.shards{background-image:url(/images/skins_shards.png);margin-bottom:3px}#container-drop-log-several-qol .girl-detail .skin-entry .drop-display span.fights{background-image:url(/images/pictures/design/ic_topbar_energy_fight.png);margin-top:3px}#container-drop-log-several-qol .girl-detail .detail-actions{margin-top:10px;text-align:center}#container-drop-log-several-qol .girl-detail .delete-girl-btn{padding:8px 16px;background:linear-gradient(to bottom,#f44,#c00);border:1px solid #a00;border-radius:4px;color:#fff;font-size:12px;cursor:pointer;text-shadow:1px 1px 0#000}#container-drop-log-several-qol .girl-detail .delete-girl-btn:hover{background:linear-gradient(to bottom,#f66,#e00)}#container-drop-log-several-qol .girl-detail .delete-girl-btn:active{background:linear-gradient(to bottom,#c00,#a00)}#container-drop-log-several-qol .girl-detail-container{position:relative;height:525px;overflow:hidden}#container-drop-log-several-qol .background-pose{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);height:100%;width:100%;object-fit:contain;object-position:center;z-index:1;opacity:.7}#container-drop-log-several-qol .girl-detail-content{position:relative;z-index:2;height:100%;padding:10px;overflow-y:auto;background:rgb(0,0,0,10%);display:flex;flex-direction:column;justify-content:flex-end}#container-drop-log-several-qol .girl-detail-content>h2{font-size:30px}")}run(){this.hasRun||!e.shouldRun()||(this.hasRun=!0,"/troll-pre-battle.html"===location.pathname?(this.handlePreBattlePage(),this.injectCSS(),this.makeLogPopup()):this.handleBattlePage(),!this.shouldTrackShards)||!f.getCurrentTrackingState().girlIds.length||this.hookTrollAjaxComplete()}hookTrollAjaxComplete(){$(document).ajaxComplete((e,t,a)=>{if(this.shouldTrackShards&&"string"==typeof a?.data&&a.data.includes("action=do_battles_trolls")){let e=t.responseJSON;if(!e||!e.rewards)return;"/troll-pre-battle.html"===location.pathname&&$("button.battle-action-button").prop("disabled",!0);let i=a.data.match(/number_of_battles=(\d+)/),r=i?parseInt(i[1],10):1,o=(e.rewards.data.shards??[]).filter(e=>this.trackedRarities.includes(e.rarity)),n=new Map(o.map(e=>[e.id_girl,e])),s=f.getCurrentTrackingState();if(!s.girlIds.length)return void(this.shouldTrackShards=!1);let l=[];if(s.girlIds.forEach(t=>{let a=f.getTrackedGirl(t);if(!a)return;a.last_fight_time=Date.now();let i,o=n.get(t);if(o)if(o.previous_value>100)console.warn("unusable shard drop info:",o);else if(100===o.value&&a.skins){if(e.rewards?.data.girls?.find(e=>e.id_girl===t))i=function(e,t,a){let i=function(e,t){return void 0!==e.last_shards_count&&e.last_shards_count>=t.previous_value?e.last_shards_count:t.previous_value}(e,t),r=t.value-t.previous_value,o=1===a?r:100-i,n=r-o;e.dropped_shards+=o,e.last_shards_count=100;let s=1===a?1:Math.round(a*o/r);if(e.number_fight+=s,a>1){let t=s;for(;n>0;){let i=e.skins.findIndex(e=>!e.is_owned),o=i===e.skins.length,s=e.skins[i],l=o?n:Math.min(33,n);n-=l,s.dropped_shards+=l;let d=o?a-t:a-Math.round(a*l/r);s.number_fight+=d,t+=d}}return f.upsertTrackedGirl(t.id_girl,e),e}(a,o,r);else if(e.rewards?.data.grade_skins?.filter(e=>e.id_girl===t)){let n=e.rewards.data.grade_skins.filter(e=>e.id_girl===t);i=function(e,t,a,i){let r=t.value-t.previous_value,o=r;i.forEach(t=>{let i=e.skins.find(e=>e.ico_path===t.ico_path),n=t.shards_added-t.previous_skin_shards,s=Math.round(a*(n/o));if(r-=n,!i){alert("ShardTracker: encountered a skin drop that is not tracked, this should not happen.");let a={ico_path:t.ico_path,number_fight:s,is_owned:t.is_owned,dropped_shards:n};return void e.skins.push(a)}i.number_fight+=s,i.dropped_shards+=n}),r>33&&alert("ShardTracker: encountered more skin shards dropped than possible, this should not happen.");let n=e.skins.find(e=>!e.is_owned);if(r>0&&n){let e=Math.min(33-(n.dropped_shards??0),r);n.dropped_shards+=e;let t=Math.round(a*(e/o));n.number_fight+=t,r-=e}return f.upsertTrackedGirl(t.id_girl,e),e}(a,o,r,n)}else i=function(e,t,a){let i=e.skins.find(e=>!e.is_owned);if(i)return i.number_fight+=a,i.dropped_shards+=t.value-t.previous_value,f.upsertTrackedGirl(t.id_girl,e),e}(a,o,r);i&&100===i.last_shards_count&&(!i.skins||i.skins.every(e=>e.is_owned))&&l.push(t)}else!function(e,t,a){e.last_shards_count=Math.min(t.value,100),e.number_fight+=a;let i=t.value-t.previous_value;e.dropped_shards+=i,f.upsertTrackedGirl(t.id_girl,e)}(a,o,r);else!function(e,t,a){if(100===e.last_shards_count){if(!e.skins||e.skins.every(e=>e.is_owned))return;e.skins.find(e=>!e.is_owned).number_fight+=t}else e.number_fight+=t;f.upsertTrackedGirl(a,e)}(a,r,t)}),l.length){let e=f.getCurrentTrackingState(),t=e.girlIds.filter(e=>!l.includes(e));0===t.length?(this.shouldTrackShards=!1,f.setCurrentTrackingState(-1)):f.setCurrentTrackingState(e.trollID,t)}}})}handlePreBattlePage(){let e=unsafeWindow.opponent_fighter;if(!e||!e.rewards.girls_plain)return;let t=e.rewards.girls_plain.filter(e=>this.trackedRarities.includes(e.rarity)&&(!e.is_girl_owned||e.grade_skins?.some(e=>!e.is_owned)));if(!t||0===t.length)return f.setCurrentTrackingState(-1),void(this.shouldTrackShards=!1);this.shouldTrackShards=!0;let a=[];t.forEach(t=>{a.push(t.id_girl);let i=e.rewards.data.shards?.find(e=>e.id_girl===t.id_girl);if(!i)return;let r=f.getTrackedGirl(t.id_girl);if(r)return void this.updateExistingTrackedGirl(r,t);let o=this.createTrackedGirlRecord(i,t);f.upsertTrackedGirl(t.id_girl,o)}),f.setCurrentTrackingState(e.player.id_fighter,a)}createTrackedGirlRecord(e,t){let a={name:e.name,ico:e.ico,rarity:e.rarity,number_fight:0,dropped_shards:0,grade:e.graded2.match(/<g/g).length,last_fight_time:0};if(e.is_girl_owned&&(a.last_shards_count=100),t.grade_skins){let e=t.grade_skins.filter(e=>!e.is_owned);e.length&&(a.skins=e.map(e=>({ico_path:e.ico_path,number_fight:0,is_owned:e.is_owned,dropped_shards:0})))}return a}updateExistingTrackedGirl(e,t){let a=!1;if(100!==e.last_shards_count&&t.is_girl_owned&&(e.last_shards_count=100,a=!0),t.grade_skins){let i=[];t.grade_skins.forEach(t=>{let r=e.skins&&e.skins.find(e=>e.ico_path===t.ico_path);r||!1!==t.is_owned?r&&(r.is_owned!==t.is_owned&&(r.is_owned=t.is_owned,a=!0),i.push(e.skins.find(e=>e.ico_path===t.ico_path))):i.push({ico_path:t.ico_path,number_fight:0,is_owned:t.is_owned,dropped_shards:0})}),a&&i.length&&(e.skins=i)}a&&f.upsertTrackedGirl(t.id_girl,e)}handleBattlePage(){let e=f.getCurrentTrackingState();location.search.includes(`id_opponent=${e.trollID}`)&&0!==e.girlIds.length&&(this.shouldTrackShards=!0)}createGirlEntry(e,t){let a=t.dropped_shards+(t.skins??[]).reduce((e,t)=>e+(t.dropped_shards??0),0),i=t.number_fight+(t.skins??[]).reduce((e,t)=>e+t.number_fight,0),r=$(` <div id_girl="${e}"> <div girl="${e}" class="harem-girl"> <div class="left"> <img class="${t.rarity}" src="${t.ico}" alt=""> </div> <div class="right"> <h4>${t.name}</h4> <div class="g_infos"> <div class="graded">${"<g></g>".repeat(t.grade)}</div> </div> ${this.generateDropDisplay(a,i)} </div> </div> </div> `);return r.on("click",()=>{this.generateGirlDetail(e,t)}),r}generateGirlDetail(e,t){let a=$("#popup-drop-log-several-qol > .container-special-bg > .drop-log > .girl-detail").empty(),i=t.dropped_shards,r=t.number_fight,o="";t.skins&&t.skins.length>0&&(o=`<div class="skins-section">\n        <h3>Skins</h3>\n        <div class="skins-list">\n          ${t.skins.map((e,t)=>`<div class="skin-entry">\n              <div class="skin-ico"><img src="${e.ico_path}" alt="Skin ${t+1}" /></div>\n              ${this.generateDropDisplay(e.dropped_shards??0,e.number_fight)}\n            </div>`).join("")}\n        </div>\n      </div>`);let n=` <div class="girl-detail-container"> <img src="${IMAGES_URL+"/pictures/girls/"+e+"/ava0.png"}" class="background-pose" alt="${t.name}"> <div class="girl-detail-content"> <h2>${t.name}</h2> <div class="graded-detail">${"<g></g>".repeat(t.grade)}</div> <div class="detail-stats"> <h3>Girl Stats</h3> ${this.generateDropDisplay(i,r)} </div> ${o} <div class="event-source-section" tooltip="This Will be useful for data crunching later"> <h3>Assign Event</h3> ${this.generateEventPicker(t.event_source)} </div> <div class="detail-actions"> <button class="delete-girl-btn" type="button">Delete Tracked Data</button> </div> </div> </div> `;a.append(n),a.find(".event-picker").on("change",a=>{let i=$(a.target).val();t.event_source=i||void 0,f.upsertTrackedGirl(e,t)}),$("#container-drop-log-several-qol div[girl]").removeClass("opened"),$(`#container-drop-log-several-qol div[girl="${e}"]`).addClass("opened"),a.find(".delete-girl-btn").on("click",()=>{confirm(`Are you sure you want to delete all tracked data for ${t.name}? This action cannot be undone.`)&&(f.removeTrackedGirl(e),a.empty(),$(`#container-drop-log-several-qol div[id_girl="${e}"]`).remove())})}generateDropDisplay(e,t){return` <div class="drop-display"> <div class="total-shards"> <span class="label">${e}</span> <span class="icon shards"></span> </div> <div class="total-fights"> <span class="label">${t}</span> <span class="icon fights"></span> </div> <div class="drop-rate"> <span class="label">${(0==t?0:100*e/t).toFixed(2)+"%"}</span> </div> </div> `}generateEventPicker(t){let a=e.EVENT_OPTIONS.map(e=>`<option value="${e}" ${t===e?"selected":""}>${e}</option>`).join("");return` <select class="event-picker"> <option value="" ${t?"":"selected"}>-- Select Event --</option> ${a} </select> `}createGirlList(){let e=$('<div class="girl-grid hh-scroll"></div>');return Object.entries(f.getTrackedGirls()).filter(([e,t])=>t.number_fight+(t.skins??[]).reduce((e,t)=>e+t.number_fight,0)>0).sort(([e,t],[a,i])=>i.last_fight_time-t.last_fight_time).map(([e,t])=>this.createGirlEntry(+e,t)).forEach(t=>{e.append(t)}),e}makeLogPopup(){let e=$('<div class="drop-log"></div>');e.append(this.createGirlList()),e.append('<div class="girl-detail hh-scroll"></div>'),n.doWhenSelectorAvailable("#pre-battle .opponent .personal_info",t=>{let a=$(' <span id="show-drop-log-several-qol"> <img tooltip hh_title="show drop log" src="https://hh.hh-content.com/design/ic_books_gray.svg" alt="show log"> </span> ');t.append(a),a.on("click",function(){i.createPopup("common","drop-log-several-qol",e,"Shard Drop Log"),$("#popup-drop-log-several-qol > .container-special-bg > .drop-log > .girl-grid").children().first().trigger("click")})})}calculateNumberOfFightsThatDroppedShards(e,t){if(!e.rewards)return 0;let a=e.rewards.data;if(1===t)return a.shards||a.girls||a.grade_skins?1:0;if(!a.rewards)return t;let r=0,o=unsafeWindow.opponent_fighter;for(let t of a.rewards)if("gems"===t.type){let e=t.value,a=o.rewards.data.rewards.find(e=>"gem_type"in e&&e.gem_type===t.gem_type),i=l.getPlayerGemsPrestigeBonus();r+=Math.round(e/(1+i)/a.value)}else if("soft_currency"===t.type){let t=e.rewards.heroChangesUpdate.currency.soft_currency-shared.Hero.currencies.soft_currency,a=i.convertShownMoneyToNumber(o.rewards.data.rewards.find(e=>"soft_currency"===e.type).value);r+=Math.round(t/a)}else if("lively_scene"===t.type)r+=1;else if("item"===t.type)r+=t.value.quantity;else if("energy_quest"===t.type){let e=o.rewards.data.rewards.find(e=>"energy_quest"===e.type);r+=Math.round(Number(t.value)/Number(e.value))}else"number"==typeof t.value?r+=t.value:"string"!=typeof t.value||isNaN(Number(t.value))?(console.warn("Unknown reward type encountered in shard tracker:",t),t.value&&!isNaN(Number(t.value))&&(r+=Number(t.value))):r+=Number(t.value);return t-r}};M.EVENT_OPTIONS=["Mythic Days (Revival)","Legendary Days","Classic Event","Orgy Days","Love Raids","Villain Girl"];var L=M,E=class e extends t{constructor(){super(...arguments),this.configSchema={baseKey:"popupMinusMinus",label:"Popup--",default:!1,subSettings:[{key:"noAnnoyingReminders",default:!0,label:"<span tooltip hh_title='Does not work inside nutaku frame if you have violentmonkey<br>Removes annoying popup appearing automatically for shops, paths, news'>No Annoying Reminders/Popups</span>"},{key:"noMissionPopup",default:!0,label:"No Mission Popup"},{key:"noLevelUpPopup",default:!1,label:"No Level Up Popup"},{key:"noPoVPoGClaimPopup",default:!1,label:"<span tooltip='Does not remove girl obtained popup'>No PoV/PoG claim Popup</span>"},{key:"noMEClaimPopup",default:!1,label:"<span tooltip='Does not remove girl obtained popup'>No ME Claim Popup</span>"},{key:"noPDClaimPopup",default:!1,label:"<span tooltip='Does not remove girl obtained popup'>No PD Claim Popup</span>"}]},this.popupQueueManagerAddOverrides=[],this.reward_popupRewardHandlePopupOverrides=[]}static shouldRun(){return!0}run(t){this.hasRun||!e.shouldRun()||(this.hasRun=!0,this.overridePopups(),t.noLevelUpPopup&&this.noLevelUpPopup(),t.noMissionPopup&&"/activities.html"===location.pathname&&this.noMissionPopup(),t.noAnnoyingReminders&&this.noAnnoyingReminders(),t.noPoVPoGClaimPopup&&["/path-of-glory.html","/path-of-valor.html"].includes(location.pathname)&&this.noPoVPoGClaimPopup(),t.noMEClaimPopup&&"/seasonal.html"===location.pathname&&this.noMEClaimPopup(),t.noPDClaimPopup&&"/penta-drill.html"===location.pathname&&this.noPoVPoGClaimPopup())}overridePopups(){let e=this,t=shared.PopupQueueManager.add;shared.PopupQueueManager.add=function({popup:a}){for(let t=e.popupQueueManagerAddOverrides.length-1;t>=0;t--){let i=e.popupQueueManagerAddOverrides[t];if(i.fn(a))return void(i.permanent||e.popupQueueManagerAddOverrides.splice(t,1))}return t.call(this,{popup:a})};let a=shared.reward_popup.Reward.handlePopup;shared.reward_popup.Reward.handlePopup=function(t){for(let a=e.reward_popupRewardHandlePopupOverrides.length-1;a>=0;a--){let i=e.reward_popupRewardHandlePopupOverrides[a];if(i.fn(t))return void(i.permanent||e.reward_popupRewardHandlePopupOverrides.splice(a,1))}return a.call(this,t)}}noAnnoyingReminders(){function e(){try{GM_cookie.set({name:"disabledPopups",value:"PassReminder,Bundles,News",domain:location.hostname.split(".").slice(-2).join("."),secure:!0,path:"/",sameSite:"no_restriction",expirationDate:Math.floor(Date.now()/1e3)+2592e3})}catch{document.cookie="disabledPopups=PassReminder,Bundles,News; path=/; max-age=2592000"}}e(),"/home.html"===location.pathname&&(function(){if(!$("[rel='clubs']").attr("href")?.includes("javascript:void(0)"))return;let e=$("#club-cooldown"),t=0;if(e.length&&(t=Math.round(parseInt(e.attr("timer"),10)),t>0)){let e=shared.timer.buildTimer(t,"","home-button-timer",!1);$("#club-cooldown").append(e),shared.timer.activateTimers("home-button-timer")}let a=$(".messenger-reply-timer.timer-box");if(a.length){let e=parseInt(a.data("time-remaining")),t=`+${parseInt(a.data("amount-energy-replies"))} ${GT.design.messenger_in}`,i=shared.timer.buildTimer(e,t,"energy-replies-refill-timer",!1);a.append(i),shared.timer.activateTimers("energy-replies-refill-timer")}$('#homepage [rel="clubs"]').off("click").on("click",e=>{e.preventDefault(),t<=0?(shared.animations.loadingAnimation.start(),shared.general.navigate($(e.currentTarget).data("href"))):alert(GT.design.club_cooldown_error)})}(),$(document).on("change","input[name='severalQoL_popupMinusMinus_noAnnoyingReminders']",function(t){if(t.target.checked)e();else try{GM_cookie.delete({name:"disabledPopups"},function(e){e&&console.error("Error deleting cookie:",e)})}catch{document.cookie="disabledPopups=; path=/; max-age=0"}}))}noMissionPopup(){this.reward_popupRewardHandlePopupOverrides.push({fn:e=>"handleMissionPopup"===e.callback&&(shared.Hero.updates(e.heroChangesUpdate,!1),$(".missions_wrap > .mission_object").length||(e.callbackArgs.isGiftClaimed?(e.callbackArgs.displayAfterGift(),$(".end_gift").hide()):(e.callbackArgs.displayGift(),$("#missions_counter").hide())),$('#missions button[rel="claim"]').addClass("button_glow").prop("disabled",!1),!0),permanent:!0})}noLevelUpPopup(){this.popupQueueManagerAddOverrides.push({fn:e=>"common"===e.type&&1===e.$dom_element.children().filter("#level_up.hero_leveling").length,permanent:!0})}noPoVPoGClaimPopup(){n.doWhenSelectorAvailable("button[rel='claim']",e=>{e.on("click.noPovPoGPopup",()=>{this.popupQueueManagerAddOverrides.push({fn:e=>"common"===e.type&&"rewards"===e.popup_name&&(e.onClose(),!0),permanent:!1})})})}noMEClaimPopup(){n.doWhenSelectorAvailable("button[rel='claim'].mega-claim-reward",e=>{e.on("click.noPovPoGPopup",()=>{this.popupQueueManagerAddOverrides.push({fn:e=>"common"===e.type&&"rewards"===e.popup_name&&(e.onClose(),!0),permanent:!1})})})}},H=class extends e{static shouldRun(){return"/home.html"===location.pathname}run(){"/home.html"===location.pathname&&GM_addStyle(`h4.severalQoL.selected::after{content: 'v${GM_info.script.version}';display: block;position: absolute;top: -10px;right: -15px;font-size: 10px;}`)}},I=class t extends e{static shouldRun(){return"/leagues.html"===location.pathname}run(){this.hasRun||!t.shouldRun()||(this.hasRun=!0,this.syncPlayerLeagueRank())}syncPlayerLeagueRank(){let e=unsafeWindow.current_tier_number;if(void 0===e)return;let t=unsafeWindow.opponents_list;if(!t)return;let a=t.find(e=>e.player.id_fighter===shared.Hero.infos.id);a&&l.setPlayerLeagueRank({league:e,rank:a.place})}},q=class t extends e{static shouldRun(){return"/season.html"===location.pathname||"/season-arena.html"===location.pathname}run(){this.hasRun||!t.shouldRun()||(this.hasRun=!0,this.syncPlayerSeasonInfo())}syncPlayerSeasonInfo(){let e=unsafeWindow.season_mojo_s;if(void 0===e)return;let t=unsafeWindow.season_tiers;if(!t)return;let a=unsafeWindow.season_tier;if(void 0===a)return;let i=t.find(e=>Number(e.tier)===a+1),r=t.find(e=>Number(e.tier)===a),o=Number(r.mojo_required),n=i?Number(i.mojo_required):void 0,s=l.getPlayerSeasonInfo()?.name;l.setPlayerSeasonInfo({previousTierThreshold:o,nextTierThreshold:n,mojo:e,name:$("#seasons_tab_title").contents()[0]?.textContent?.trim()||s,tier:a,endsAt:unsafeWindow.season_sec_untill_event_end+server_now_ts||void 0})}},A=class{run(){this.addLogoutOption()}addLogoutOption(){n.doWhenSelectorAvailable("#contains_all > nav > [rel='content'] > div",e=>{let t=`<a href="${shared.general.getDocumentHref("/logout.html")}" tooltip="Can solve unique issues, like buggy contests or stuff like that" logout> <div> <ic class="logout"></ic> <span>Logout</span> </div> </a>`;e.append(t)})}},V=class{run(){this.injectCSS(),this.addCalendarOption()}async injectCSS(){GM_addStyle(".popup_wrapper>#popup-calendar-qol{width:1020px;height:550px;top:.62rem;left:.62rem}#container-calendar-qol,#popup-calendar-qol>#container-calendar-qol.container-special-bg{height:100%;align-content:center}#popup-calendar-qol close{width:2rem;height:2rem;top:.5rem;right:.5rem;background-image:url(/images/clubs/ic_xCross.png);opacity:1}#container-calendar-qol{width:100%;box-shadow:none;border:2px solid #f90}#container-calendar-qol>.title{position:absolute;width:1020px;height:2rem;top:-1rem;left:0;font-size:18px;font-weight:400;letter-spacing:.22px;color:#ffb827;text-shadow:-1px -1px 0#000,1px -1px 0#000,-1px 1px 0#000,1px 1px 0#000,-2px -2px 5px rgba(255,159,0,.4),2px -2px 5px rgba(255,159,0,.4),-2px 2px 5px rgba(255,159,0,.4),2px 2px 5px rgba(255,159,0,.4),0 0 10px rgba(255,159,0,.4);text-align:center}#container-calendar-qol>img{height:90%}#contains_all>nav a:has(ic.calendar){cursor:pointer}#contains_all>nav ic.calendar{background-image:url(https://raw.githubusercontent.com/infarcactus-HH/HH-Several_QoL/refs/heads/main/images/calendar/calendar_icon.svg)}")}addCalendarOption(){n.doWhenSelectorAvailable("#contains_all > nav > [rel='content'] > div",e=>{let t=`https://raw.githubusercontent.com/infarcactus-HH/HH-Several_QoL/refs/heads/main/images/calendar/${i.getGameKey()}.jpg`,a=$('<a> <div><ic class="calendar"></ic><span>Calendar</span></div> </a>');e.prepend(a);let r=$(`<img src="${t}" alt="calendar">`);a.on("click",function(){i.createPopup("common","calendar-qol",r,"Calendar")})})}},W=class e extends t{constructor(){super(...arguments),this.configSchema=(()=>{let e={baseKey:"menuExtensions",label:"<span tooltip='Menu in top right corner'>Menu Extensions:</span>",default:!0,subSettings:[{key:"calendar",label:"Calendar",default:!0}]};return location.hostname.startsWith("nutaku")&&e.subSettings.push({key:"logout",label:"Logout",default:!0}),e})()}static shouldRun(){return!0}run(t){this.hasRun||!e.shouldRun()||(this.hasRun=!0,t.calendar&&(new V).run(),location.hostname.startsWith("nutaku")&&t.logout&&(new A).run())}},N=class{run(){n.doWhenSelectorAvailable('.data-row.body-row .data-column[column="nickname"]',()=>{$("body").off("click",'.data-row.body-row .data-column[column="nickname"]')})}},D=class{constructor(){this.updatedPlayerRecordsThisSession=new Set}run(){this.injectCSS(),this.leaguePlayerRecord=d.getLeaguePlayerRecord(),n.doWhenSelectorAvailable(".league_table > .data-list",e=>{this.applyRankingsToOpponentLists(),this.startObserverClickOnTable(),this.applyRankingsToTable(),new MutationObserver(()=>{this.startObserverClickOnTable(),this.applyRankingsToTable()}).observe(e[0],{childList:!0})})}async injectCSS(){GM_addStyle(".several-qol-bestrank-timesreached{margin-left:5px;display:flex;width:100%;align-items:center;text-shadow:1px 0 0#000,0 1px 0#000,-1px 0 0#000,0-1px 0#000,1px 1px 0#000,-1px -1px 0#000,1px -1px 0#000,-1px 1px 0#000}.several-qol-bestrank-timesreached.old{filter:contrast(.5)}.several-qol-bestrank-timesreached>.new-in-league{font-size:10px;color:#23b56b;font-weight:700}.several-qol-bestrank-timesreached>.rank-container{background-size:cover;text-align:center;min-width:16px;max-width:32px;width:auto;height:16px;font-size:10px}.several-qol-bestrank-timesreached>.times-reached{margin-left:3px}.several-qol-top1{background:radial-gradient(closest-side at 50% 50%,#f5a866 0,#ec0039 51%,#9e0e27 100%)0 0 no-repeat padding-box}.several-qol-top4{background-image:url(/images/legendary.png)}.several-qol-top15{background:#ffb244}.several-qol-top30{background:#23b56b}.several-qol-top30plus{background:#8d8e9f}")}applyRankingsToOpponentLists(){void 0!==this.leaguePlayerRecord&&opponents_list.forEach(e=>{let t=e.player.id_fighter,a=this.leaguePlayerRecord[t];a&&(e.Several_QoL={checkExpiresAt:a.checkExpiresAt,bestPlace:a.bestPlace,timesReached:a.timesReached})})}startObserverClickOnTable(){let e=this;$(".league_table > .data-list > .body-row").on("click.SeveralQoL",function(){let t=parseInt($(this).children("[column='place']").text().trim()),a=opponents_list.find(e=>e.place===t);a?a.Several_QoL&&a.Several_QoL.checkExpiresAt>server_now_ts||!e.updatedPlayerRecordsThisSession.has(a.player.id_fighter)&&e.sendRequestAndAnalyzeOpponent(a.player.id_fighter,$(this)):console.warn("Could not find opponent for place ",t)})}sendRequestAndAnalyzeOpponent(e,t){let a={action:"fetch_hero",id:"profile",preview:!1,player_id:e},i=Object.keys(league_rewards).length,r=new RegExp(`<img src="https:\\/\\/.*?\\/pictures\\/design\\/leagues\\/${i}\\.png">\\n\\s*?<div class=\\"tier-stats\\">\\n\\s*?<div>Best place:\\s*<span>(\\d+)<sup>[^<]+<\\/sup><\\/span><\\/div>[\\s\\S]*?<div>Times reached: <span>(\\d+)<\\/span><\\/div>`,"g");shared.general.hh_ajax(a,a=>{let i=r.exec(a.html),o=i?parseInt(i[1]):-1,n=i?parseInt(i[2]):-1;this.updatedPlayerRecordsThisSession.add(e);let s=this.updateOpponentRecord(e,o,n);t.children("[column='nickname']").find(".several-qol-bestrank-timesreached").remove(),t.children("[column='nickname']").append(this.generateRankHtml(s))})}updateOpponentRecord(e,t,a){return this.leaguePlayerRecord[e]={bestPlace:t,timesReached:a,checkExpiresAt:server_now_ts+season_end_at+10},d.setLeaguePLayerRecord(this.leaguePlayerRecord),this.leaguePlayerRecord[e]}applyRankingsToTable(){let e=$(".data-row.body-row");void 0!==this.leaguePlayerRecord&&e.each((e,t)=>{let a=parseInt($(t).children("[column='place']").text().trim());if(!a)return;let i=opponents_list.find(e=>e.place===a);if(!i)return;let r=i.player.id_fighter,o=this.leaguePlayerRecord[r];o&&!$(t).children("[column='nickname']").find(".several-qol-bestrank-timesreached").length&&$(t).children("[column='nickname']").append(this.generateRankHtml(o))})}generateRankHtml(e){let t=e.checkExpiresAt<server_now_ts,a=$(`<div class="several-qol-bestrank-timesreached ${t?"old":""}" ${t?"tooltip='Old record, click To refresh'":""}></div>`);if(-1===e.bestPlace||-1===e.timesReached)return a.append('<span class="new-in-league">NEW</span>'),a;let i=`<span class="rank-container ${this.generateRankClass(e.bestPlace)}">${e.bestPlace}</span>`,r=`<span class="times-reached">x${e.timesReached}</span>`;return a.prepend(i),a.append(r),a}generateRankClass(e){return 1==e?"several-qol-top1":e<=4?"several-qol-top4":e<=15?"several-qol-top15":e<=30?"several-qol-top30":"several-qol-top30plus"}},j=class{run(){shared.Hero.infos.hc_confirm=!0}},B=class e extends t{constructor(){super(...arguments),this.configSchema={baseKey:"leaguesQoL",label:"Leagues QoL :",default:!1,subSettings:[{key:"leagueOpponentHistory",label:"<span tooltip='click on the row to refresh, only looks for highest league'>Show history of opponents</span>",default:!1},{key:"leagueNoPlayerProfileOnNameClick",label:"Disable opening player profile when clicking on their name",default:!1},{key:"noRefillEnergyConfirm",label:"Disable koban spending confirmation when refilling energy in leagues",default:!1}]}}static shouldRun(){return location.pathname.includes("/leagues.html")}run(t){this.hasRun||!e.shouldRun()||(this.hasRun=!0,t.leagueOpponentHistory&&(new D).run(),t.leagueNoPlayerProfileOnNameClick&&(new N).run(),t.noRefillEnergyConfirm&&(new j).run())}},O=class t extends e{static shouldRun(){return"/home.html"===location.pathname}run(){this.hasRun||!t.shouldRun()||(this.hasRun=!0,this.hookOrHandlePrestige())}hookOrHandlePrestige(){if(shared.popup_payment?.payment_products_data?.prestige){let e=(shared.popup_payment?.payment_products_data?.prestige.tiers).find(e=>e.is_current).id_prestige_tier,t=this.handleGemsGainedFromPrestige(e);l.setPlayerGemsPrestigeBonus(t)}else $(document).ajaxComplete((e,t,a)=>{if("string"==typeof a?.data&&"action=load_payment_methods"===a.data){let e=t.responseJSON;if(!e||!e.success)return;let a=e.data.products_data.prestige.tiers.find(e=>e.is_current).id_prestige_tier,i=this.handleGemsGainedFromPrestige(a);l.setPlayerGemsPrestigeBonus(i)}})}handleGemsGainedFromPrestige(e){if(e<9)return 0;switch(e){case 9:return 4;case 10:return 4.5;case 11:return 5;case 12:return 5.5;case 13:return 6;case 14:return 7;case 15:return 8;case 16:return 9;case 17:return 10;case 18:return 11;case 19:return 12;case 20:return 13;case 21:return 14;case 22:return 15;case 23:return 16;case 24:return 18;case 25:return 20;default:return 0}}},U=class e extends t{constructor(){super(...arguments),this.configSchema={baseKey:"championFightsFromMap",label:'<span tooltip="Don\'t click on the button directly to access champ page">Champion Fights From Map</span>',default:!1}}static shouldRun(){return"/champions-map.html"===location.pathname}run(){this.hasRun||!e.shouldRun()||(this.hasRun=!0,$("a[champions_id]").each(function(){let e=$(this),t=e.attr("champions_id"),a=`timer${t}`,i=shared.general.getDocumentHref(this.href);if(0===e.find(".champion-rest-timer").length){let r=$(` <div class="champion-rest-timer"> <div class="rest-timer timer"> <span id="${a}">${GT.design.pantheon_perform}</span> </div> </div> `);e.find(".map-label-link").append(r);let o=0;e.find(".map-label-link").on("click",function(a){o>0||(a.preventDefault(),shared.animations.loadingAnimation.start(),$.ajax({url:i,success:function(a){let i=JSON.parse(/{"champion"[\w\W]+?};/.exec(a)[0].slice(0,-1)).team.map(e=>e.id_girl),r={class:"TeamBattle",battle_type:"champion",battles_amount:1,defender_id:t,attacker:{team:i}};shared.general.hh_ajax(r,function(a){shared.animations.loadingAnimation.stop(),delete a.end.rewards.redirectUrl,shared.reward_popup.Reward.handlePopup(a.end.rewards),shared.Hero.updates(a.end.rewards.heroChangesUpdate),a.objective_points&&shared.general.objectivePopup.show(a.objective_points),o="champion"===a.final.winner.type?900:86400;let i=shared.timer.buildTimer(o,"",`rest-timer id-${t}`,!1);e.find(".rest-timer").replaceWith(i),shared.timer.activateTimers(`rest-timer.id-${t}`,()=>{})})}}))})}}))}},Q=class{async run(){GM_addStyle("#leagues>.league_content>.league_tiers #toggle_columns,#leagues>.league_content>.league_tiers .league_tier_progress,#leagues>.page-title,.head-column[column=player_league_points] .downArrow_mix_icn,.head-column[column=player_league_points] .upArrow_mix_icn,.head-column[column=player_league_points] .upDownArrows_mix_icn{display:none}#leagues>.league_content>.league_tiers #league_filter{position:absolute;z-index:3;right:250px;top:2px;box-shadow:0 3px 0 transparent,inset 0 3px 0#6df0ff}.leagues-container>#leagues>.league_content>.league_tiers .league_filter_box{top:2.2rem}.leagues-container>#leagues>.league_content{padding:5px 6px 0 0}.leagues-container #leagues .league_content .league_table .data-list .data-row.player-row.pinned{top:30rem;width:48.5rem}.leagues-container #leagues .league_content .league_table.player-row-pinned{margin-bottom:2.35rem}.leagues-container #leagues .league_content .league_buttons{padding-left:10px;padding-right:5px}@media (min-width:1025px){.leagues-container #leagues .league_content .league_table .data-list .head-row{width:774px;position:fixed;top:70px}}@media (max-width:1025px){.leagues-container #leagues .league_content .league_table .data-list .head-row{width:774px;position:fixed;top:99px}}.leagues-container #leagues .league_content .league_table .data-list{padding-top:31px}.leagues-container #leagues .league_content .league_table .data-list .data-row.player-row{top:0}.data-column[column=change]{display:none!important}.data-list .data-row .data-column[column=place]{width:6.7rem;margin-left:.4rem;text-align:center}")}},z=class{constructor(){this.blinkTimeThreshold=84600,this.rgbEasterEggChance=1e3}getTimeoutWarningClass(){return 0===Math.floor(Math.random()*this.rgbEasterEggChance)?"several-qol-rgb-mode":"several-qol-blink"}run(){this.isInTutoLustArena()||(this.injectCSS(),n.doWhenSelectorAvailable('.main-container [rel="pvp-arena"]',e=>{let t=$('.left-side-container [rel="map"] > .notif-position > span'),a=t.css("background-color"),i=t.children().css("color");GM_addStyle(`:root {--lust-arena-left-side-bg-color: ${a};--lust-arena-left-side-color: ${i};}`);let r=$('<div class="lust-arena-style-tweak-wrapper"></div>');e.replaceWith(r);let o=l.getPlayerLeagueRank(),n=$(`<a href="${shared.general.getDocumentHref("/leagues.html")}" rel="leagues"> <img src="${IMAGES_URL}/pictures/design/leagues/${o.league}.png" alt="Leagues Icon"> <p>#${o.rank}</p> </a>`);r.append(n);let s=$('<div class="lust-arena-right-section"></div>'),d=l.getPlayerSeasonInfo(),p=(d?.endsAt||server_now_ts+this.blinkTimeThreshold+1)-server_now_ts<this.blinkTimeThreshold,c=$(`<a href="${shared.general.getDocumentHref("/season.html")}" rel="season" class="${p?this.getTimeoutWarningClass():""}"> <p>${GT.design.Season}</p> </a>`);d&&c.attr("tooltip",this.generateProgressBarTooltip(d.tier,d.mojo,d.previousTierThreshold,d.name??GT.design.Season,d.nextTierThreshold,IMAGES_URL+"/mojo_logo.svg")),s.append(c);let u=l.getPlayerPentaDrillInfo(),h=(u?.endsAt||server_now_ts+this.blinkTimeThreshold+1)-server_now_ts<this.blinkTimeThreshold,g=$(`<a href="${shared.general.getDocumentHref("/penta-drill.html")}" rel="penta-drill" class="${h?this.getTimeoutWarningClass():""}"> <p>${GT.design.penta_drill}</p> </a>`);u&&g.attr("tooltip",this.generateProgressBarTooltip(u.tier,u.potions,u.previousTierThreshold,GT.design.penta_drill,u.nextTierThreshold,"https://raw.githubusercontent.com/infarcactus-HH/HH-Several_QoL/refs/heads/main/images/PDPoints.png",13)),s.append(g),r.append(s);let m=c.width()??0,f=GT.design.Season.length;c.find("p").css("font-size",`clamp(11px, calc(${m}px / ${f} * 1.75), 14px)`);let _=g.width()??0,b=GT.design.penta_drill.length;g.find("p").css({"font-size":`clamp(9px, calc(${_}px / ${b} * 1.6), 14px)`})}))}async injectCSS(){GM_addStyle("@keyframes several-qol-blink-anim{0%,to{opacity:1}50%{opacity:.6}}@keyframes several-qol-rgb-anim{0%{filter:hue-rotate(0deg) saturate(2) brightness(1.2)}to{filter:hue-rotate(360deg) saturate(2) brightness(1.2)}}@keyframes several-qol-rgb-text-anim{0%,to{color:red;text-shadow:0 0 10px red,0 0 20px red,0 0 30px red,1px 1px 0#000,-1px 1px 0#000,-1px -1px 0#000,1px -1px 0#000}16.67%{color:#ff0;text-shadow:0 0 10px #ff0,0 0 20px #ff0,0 0 30px #ff0,1px 1px 0#000,-1px 1px 0#000,-1px -1px 0#000,1px -1px 0#000}33.33%{color:#0f0;text-shadow:0 0 10px #0f0,0 0 20px #0f0,0 0 30px #0f0,1px 1px 0#000,-1px 1px 0#000,-1px -1px 0#000,1px -1px 0#000}50%{color:#0ff;text-shadow:0 0 10px #0ff,0 0 20px #0ff,0 0 30px #0ff,1px 1px 0#000,-1px 1px 0#000,-1px -1px 0#000,1px -1px 0#000}66.67%{color:#00f;text-shadow:0 0 10px #00f,0 0 20px #00f,0 0 30px #00f,1px 1px 0#000,-1px 1px 0#000,-1px -1px 0#000,1px -1px 0#000}83.33%{color:#f0f;text-shadow:0 0 10px #f0f,0 0 20px #f0f,0 0 30px #f0f,1px 1px 0#000,-1px 1px 0#000,-1px -1px 0#000,1px -1px 0#000}}@keyframes several-qol-rgb-border-anim{0%,to{border-color:red;box-shadow:0 0 8px red,inset 0 0 4px rgba(255,0,0,.3)}16.67%{border-color:#ff0;box-shadow:0 0 8px #ff0,inset 0 0 4px rgba(255,255,0,.3)}33.33%{border-color:#0f0;box-shadow:0 0 8px #0f0,inset 0 0 4px rgba(0,255,0,.3)}50%{border-color:#0ff;box-shadow:0 0 8px #0ff,inset 0 0 4px rgba(0,255,255,.3)}66.67%{border-color:#00f;box-shadow:0 0 8px #00f,inset 0 0 4px rgba(0,0,255,.3)}83.33%{border-color:#f0f;box-shadow:0 0 8px #f0f,inset 0 0 4px rgba(255,0,255,.3)}}.lust-arena-style-tweak-wrapper{width:100%;height:54px;display:flex;align-items:stretch;z-index:1}.lust-arena-style-tweak-wrapper>[rel=leagues]{background-color:var(--lust-arena-left-side-bg-color);color:var(--lust-arena-left-side-color);border:1px solid var(--lust-arena-left-side-color);z-index:1;border-radius:3px;text-decoration:none}.lust-arena-style-tweak-wrapper>[rel]{position:relative;text-decoration:none}.lust-arena-style-tweak-wrapper>[rel=leagues]{flex:0 0 40%;display:flex;justify-content:center;align-items:center}.lust-arena-right-section{flex:0 0 60%;display:flex;flex-direction:column;gap:5px;padding-left:5px}.lust-arena-right-section>[rel=penta-drill],.lust-arena-right-section>[rel=season]{flex:1;display:flex;justify-content:center;align-items:center;text-decoration:none}.lust-arena-style-tweak-wrapper>[rel] img{aspect-ratio:1;z-index:0}.lust-arena-style-tweak-wrapper>[rel=leagues] img{max-width:85%;max-height:85%}.lust-arena-style-tweak-wrapper>[rel=leagues] p,.lust-arena-style-tweak-wrapper>[rel=season] p{position:absolute;z-index:1;width:100%;height:100%;display:flex;align-items:center;justify-content:center;margin:0;background-color:transparent;border:0;text-shadow:1px 1px 0#000,-1px 1px 0#000,-1px -1px 0#000,1px -1px 0#000}.lust-arena-right-section>[rel=penta-drill] p,.lust-arena-right-section>[rel=season] p{position:relative;z-index:1;margin:0;text-decoration:none;background-color:var(--lust-arena-left-side-bg-color);color:var(--lust-arena-left-side-color);border:1px solid var(--lust-arena-left-side-color);border-radius:3px;text-align:center;width:100%;height:100%;display:flex;align-items:center;justify-content:center}.lust-arena-right-section>[rel=penta-drill] p{line-height:1.1}.hh_tooltip_new:has(.progressbar-tooltip){background-color:var(--lust-arena-left-side-bg-color);color:var(--lust-arena-left-side-color)}.progressbar-tooltip{display:flex;flex-direction:column;align-items:center;gap:4px;min-width:170px;background-color:var(--lust-arena-left-side-bg-color);color:var(--lust-arena-left-side-color)}.progressbar-tooltip-name{font-size:16px;text-align:center;min-height:1em;width:100%;margin:0 10px}.progressbar-tooltip-tier-row{display:flex;justify-content:space-between;align-items:center;width:100%;font-size:11px}.progressbar-tooltip-tier{text-align:left}.progressbar-tooltip-mojo{display:flex;align-items:center;gap:2px;text-align:right;color:#fff}.progressbar-tooltip-mojo-icon{height:14px}.progressbar-tooltip-bar-container{width:100%;height:8px;background-color:rgba(0,0,0,.4);border-radius:1px;overflow:hidden;border:1px solid #000}.progressbar-tooltip-bar-fill{height:100%;border-radius:1px;transition:width .3s ease}.several-qol-blink{animation:several-qol-blink-anim 5s ease-in-out infinite;will-change:opacity}.several-qol-rgb-mode p{animation:several-qol-rgb-text-anim 2s linear infinite,several-qol-rgb-border-anim 2s linear infinite;will-change:color,text-shadow,border-color,box-shadow}")}generateProgressBarTooltip(e,t,a,i,r,o,n){let s,l=this.getColors();if(void 0===r)s=100;else{let e=r-a,i=t-a;s=Math.min(100,Math.max(0,i/e*100))}let d=void 0!==r?`${t} / ${r}`:`${t} (Max)`,p=o?`${d}<img src="${o}" alt="mojo" class="progressbar-tooltip-mojo-icon" style="${n?`height: ${n}px; width: auto;`:""}"/>`:d;return`<div class="progressbar-tooltip"> <div class="progressbar-tooltip-name">${i}</div> <div class="progressbar-tooltip-tier-row"> <span class="progressbar-tooltip-tier" style="color:${l.tier}"> ${GT.design.tier} ${e} </span> <span class="progressbar-tooltip-mojo">${p}</span> </div> <div class="progressbar-tooltip-bar-container"> <div class="progressbar-tooltip-bar-fill" style="width:${s}%;background-image:${l.barGradient}"> </div> </div>`}getColors(){let e=$('<div class="progress-section"> <div class="general-progress-bar"> <div class="progress-bar-fill"> </div> </div>');e.appendTo("#contains_all");let t=e.find(".progress-bar-fill").css("background-image");e.remove();let a=$('<div class="tabs-switcher"> <div class="switch-tab"> </div>');a.appendTo("#contains_all");let i=a.find(".switch-tab").css("color");return a.remove(),{barGradient:t,tier:i}}isInTutoLustArena(){return!!(tutoFeatures.season&&!tutoData.home4_1||tutoFeatures.leagues&&!tutoData.home6_1)}},F=class{run(){let e=unsafeWindow.time_remaining;void 0!==e&&e>84600&&this.injectCSS()}async injectCSS(){GM_addStyle(".potions-paths-tier>#claim-all{display:none}.potions-paths-tier.claim-all-rewards{width:19.5rem}")}},K=class{run(){let e=unsafeWindow.opponent_fighter;e&&(e.rewards.data.rewards.find(e=>"scrolls_common"===e.type)&&n.doWhenSelectorAvailable(".slot.size_small[class*='slot_scrolls_']",e=>{e.first().replaceWith('<div class="slot slot_scrolls_mythic size_small" tooltip="1 bulb of a random rarity"> <span class="scrolls_multicolor_icn"></span> <div class="amount">1</div> </div>'),e.slice(1).remove()}),this.injectCSS())}async injectCSS(){GM_addStyle(".scrolls_multicolor_icn{background-image:url(https://raw.githubusercontent.com/infarcactus-HH/HH-Several_QoL/refs/heads/main/images/MulticolorBulb.png);background-size:contain;background-position:center;background-repeat:no-repeat;padding:0}")}},J=class e extends t{constructor(){super(...arguments),this.configSchema={baseKey:"styleTweak",label:"Style Tweak: Visual improvements",default:!0,subSettings:[{key:"villainReplaceBulbsByMulticolorBulb",label:"Villain: Replace bulbs by multicolor bulb",default:!0},{key:"lustArenaStyleTweak",label:"Lust Arena",default:!0},{key:"poVPoGHideClaimAllUntilLastDay",label:"PoV/PoG: Hide 'Claim All' until last day",default:!1},{key:"compactLeagueStyleTweak",label:"Compact League View",default:!1}]}}static shouldRun(){return!0}run(t){this.hasRun||!e.shouldRun()||(this.hasRun=!0,t.villainReplaceBulbsByMulticolorBulb&&"/troll-pre-battle.html"===location.pathname&&(new K).run(),t.lustArenaStyleTweak&&"/home.html"===location.pathname&&(new z).run(),t.poVPoGHideClaimAllUntilLastDay&&("/path-of-valor.html"===location.pathname||"/path-of-glory.html"===location.pathname)&&(new F).run(),t.compactLeagueStyleTweak&&"/leagues.html"===location.pathname&&(new Q).run())}},X=class t extends e{static shouldRun(){return"/penta-drill.html"===location.pathname}run(){if(this.hasRun||!t.shouldRun())return;this.hasRun=!0;let e=unsafeWindow.penta_drill_data;if(!e)return;let a=e.progression.tier,i=e.progression.potions,r=e.path_rewards.find(e=>e.tier===a),o=e.path_rewards.find(e=>e.tier===a+1);l.setPlayerPentaDrillInfo({tier:a,potions:i,previousTierThreshold:r.potions_required,nextTierThreshold:o?o.potions_required:void 0,endsAt:e.cycle_data.seconds_until_event_end+server_now_ts})}},Y=class t extends e{static shouldRun(){return"/clubs.html"===location.pathname}run(){if(this.hasRun||!t.shouldRun())return;this.hasRun=!0;let e=unsafeWindow.members_list;if(!e||0===e.length)return;let a=e.map(e=>e.id_member);l.setPlayerClubmatesIds(a)}},Z=class{static getBadgeConfigurations(){let e=[],t=this.getMajorContributorsForGame();return t.length>0&&e.push({type:"contributor",tooltip:"Major Script Contributor",cssClass:"S_QoL-major-contributor",userIds:t}),e}static getMajorContributorsForGame(){return"nutaku"===HH_UNIVERSE?["3239327","4443024"]:"hentai"===HH_UNIVERSE?["583627"]:[]}},ee=class t extends e{constructor(){super(...arguments),this.badgeConfigs=Z.getBadgeConfigurations()}static shouldRun(){return["/penta-drill.html","/pantheon.html","/season.html","/labyrinth.html","/path-of-valor.html","/path-of-glory.html","/activities.html","/leagues.html"].some(e=>location.pathname===e)}run(){if(!this.hasRun&&t.shouldRun()&&(this.hasRun=!0,this.injectCSS(),0!==this.badgeConfigs.length))switch(location.pathname){case"/activities.html":n.doWhenSelectorAvailable(".lead_table_view .leadTable > tr",e=>{this.addContestLeaderboardBadges(e)});break;case"/leagues.html":this.addLeagueBadges();break;default:this.hookAjaxComplete()}}addLeagueBadges(){n.doWhenSelectorAvailable(".league_table > .data-list",e=>{this.applyBadgesToLeagueRows(e),new MutationObserver(()=>this.applyBadgesToLeagueRows(e)).observe(e[0],{childList:!0})})}applyBadgesToLeagueRows(e){e.children(".body-row").each((e,t)=>{let a=t.querySelector(".nickname"),i=a?.getAttribute("id-member");i&&this.badgeConfigs.forEach(e=>{e.userIds.includes(i)&&a?.after(this.generateBadgeElement(e.tooltip,e.cssClass))})})}hookAjaxComplete(){$(document).ajaxComplete((e,t,a)=>{"string"==typeof a?.data&&(a.data.startsWith("action=labyrinth_leaderboard")?n.doWhenSelectorAvailable("#leaderboard_list > .leaderboard_row:has(.leaderboard-nickname-align)",e=>{this.addLabyrinthLeaderboardBadges(e,t.responseJSON)}):"action=leaderboard&feature=path_of_valor"===a.data?n.doWhenSelectorAvailable("#pov_leaderboard_tab_container #leaderboard_list > .leaderboard_row",e=>{this.addStandardLeaderboardBadges(e,"#pov_leaderboard_tab_container #outer-hero-row .leaderboard-nickname-align")}):"action=leaderboard&feature=path_of_glory"===a.data?n.doWhenSelectorAvailable("#pog_leaderboard_tab_container #leaderboard_list > .leaderboard_row",e=>{this.addStandardLeaderboardBadges(e,"#pog_leaderboard_tab_container #outer-hero-row .leaderboard-nickname-align")}):a.data.startsWith("action=leaderboard")&&n.doWhenSelectorAvailable("#leaderboard_holder:has(.build-at-bottom) > #leaderboard_list > .leaderboard_row",e=>{this.addStandardLeaderboardBadges(e)}))})}addLabyrinthLeaderboardBadges(e,t){let a=t.hero_data?.id_member.toString();a&&this.badgeConfigs.forEach(e=>{e.userIds.includes(a)&&n.doWhenSelectorAvailable("#outer-hero-row .leaderboard-nickname-align",t=>{t.append(this.generateBadgeElement(e.tooltip,e.cssClass))})}),e.each((e,a)=>{let i=t.leaderboard[e];if(!i)return;let r=i.id_member.toString();this.badgeConfigs.forEach(e=>{e.userIds.includes(r)&&a.querySelector(".leaderboard-nickname-align")?.appendChild(this.generateBadgeElement(e.tooltip,e.cssClass))})})}addStandardLeaderboardBadges(e,t){let a=shared.Hero.infos.id.toString();this.badgeConfigs.forEach(e=>{e.userIds.includes(a)&&document.querySelector(t??"#outer-hero-row .leaderboard-nickname-align")?.appendChild(this.generateBadgeElement(e.tooltip,e.cssClass))}),e.each((e,t)=>{let a=t.getAttribute("sorting_id");a&&this.badgeConfigs.forEach(e=>{e.userIds.includes(a)&&t.querySelector(".leaderboard-nickname-align")?.appendChild(this.generateBadgeElement(e.tooltip,e.cssClass))})})}addContestLeaderboardBadges(e){e.each((e,t)=>{let a=t.getAttribute("sorting_id");a&&this.badgeConfigs.forEach(e=>{e.userIds.includes(a)&&t.children[1].appendChild(this.generateBadgeElement(e.tooltip,e.cssClass))})})}generateBadgeElement(e,t){let a=document.createElement("span");return a.className=`S_QoL-leaderboard-badge ${t??""}`,a.setAttribute("tooltip",e),$(a).on("click",e=>{e.stopPropagation(),e.preventDefault(),e.stopImmediatePropagation(),GM_openInTab("https://www.patreon.com/infarcactusHH",{active:!0})}),a}async injectCSS(){GM_addStyle(".S_QoL-major-contributor{background-image:url(https://raw.githubusercontent.com/infarcactus-HH/HH-Several_QoL/feature/badges/images/badges/major_contributor.png);background-size:contain}.S_QoL-leaderboard-badge{display:inline-block;margin-left:4px;vertical-align:middle;width:30px;height:30px;min-width:30px;min-height:30px}.lead_table_view .S_QoL-leaderboard-badge{width:25px;height:25px;min-width:25px;min-height:25px;vertical-align:bottom;position:relative;top:2px}")}};new class{constructor(){if(this.allModules=[E,J,v,x,r,B,G,W,a,_,y,b,T,L,U],this.alwaysRunningModules=[ee,I,H,q,O,X,Y],"/integrations/"!==location.pathname){if(location.hostname.startsWith("nutaku")&&(this.applySessionFix(),this.allModules.push(C)),void 0===unsafeWindow.hhPlusPlusConfig)return void Promise.race([new Promise(e=>{$(document).one("hh++-bdsm:loaded",()=>e("hh++-bdsm:loaded"))}),new Promise(e=>setTimeout(()=>e("timeout"),50))]).then(e=>{"hh++-bdsm:loaded"===e?this.runWithBDSM():this.runWithoutBdsm()});this.runWithBDSM(),this.run()}}runWithBDSM(){unsafeWindow.hhPlusPlusConfig.registerGroup({key:"severalQoL",name:"<span tooltip='By infarctus'>Several QoL</span>"}),location.pathname.includes("/home.html")?this.allModules.forEach(e=>{unsafeWindow.hhPlusPlusConfig.registerModule(new e)}):this.allModules.forEach(e=>{e.shouldRun()&&unsafeWindow.hhPlusPlusConfig.registerModule(new e)}),unsafeWindow.hhPlusPlusConfig.loadConfig(),unsafeWindow.hhPlusPlusConfig.runModules()}runWithoutBdsm(){this.allModules.forEach(e=>{if(null===e)return;let t=new e;try{let a=t.configSchema;if(e.shouldRun()&&a.default)try{if(a.subSettings){let e=a.subSettings.reduce((e,t)=>(e[t.key]=t.default,e),{});t.run(e)}else t.run(void 0)}catch(t){console.error("Error running module with subsettings",e,t)}}catch(t){console.error("Error running module",e,t)}})}applySessionFix(){if(!location.search.includes("sess=")&&""!=m.getSessID()){let e=m.getSessID();if(!e)return;let t=location.href+(location.href.includes("?")?"&":"?")+"sess="+e;window.location.replace(t)}}run(){R.run(),this.alwaysRunningModules.forEach(async e=>{e.shouldRun()&&(new e).run()})}}})();