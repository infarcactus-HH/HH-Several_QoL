// ==UserScript==
// @name         Several QoL
// @namespace    http://tampermonkey.net/
// @version      1.7.5
// @description  A userscript for QoL for the Haremverse
// @author       infarcactus
// @license      GPLv3
// @match        https://*.haremheroes.com/*
// @match        https://*.hentaiheroes.com/*
// @match        https://*.gayharem.com/*
// @match        https://*.comixharem.com/*
// @match        https://*.hornyheroes.com/*
// @match        https://*.pornstarharem.com/*
// @match        https://*.transpornstarharem.com/*
// @match        https://*.gaypornstarharem.com/*
// @match        https://*.mangarpg.com/*
// @updateURL    https://github.com/infarcactus-HH/HH-Several_QoL/raw/refs/heads/main/dist/userscript.user.js
// @downloadURL  https://github.com/infarcactus-HH/HH-Several_QoL/raw/refs/heads/main/dist/userscript.user.js
// @grant        GM.addStyle
// @grant        GM_addStyle
// @grant        GM.openInTab
// @grant        GM_getValue
// @grant        GM_setValue
// @grant        GM_deleteValue
// @grant        unsafeWindow
// @run-at       document-end
// ==/UserScript==

"use strict";(()=>{var T=Object.defineProperty;var A=Object.getOwnPropertyDescriptor;var D=Object.getOwnPropertyNames;var K=Object.prototype.hasOwnProperty;var E=(c,s)=>()=>(c&&(s=c(c=0)),s);var W=(c,s)=>{for(var e in s)T(c,e,{get:s[e],enumerable:!0})},U=(c,s,e,t)=>{if(s&&typeof s=="object"||typeof s=="function")for(let o of D(s))!K.call(c,o)&&o!==e&&T(c,o,{get:()=>s[o],enumerable:!(t=A(s,o))||t.enumerable});return c};var j=c=>U(T({},"__esModule",{value:!0}),c);var F={};W(F,{default:()=>Y});var Y,N=E(()=>{"use strict";Y=".pop-details-container{position:absolute;top:60px;left:10px;width:685px;float:left;min-height:200px;}.pop-details-left{position:absolute;width:300px;max-height:300px;}.pop-details-left img{height:800px;mask-image:linear-gradient(to top,transparent 45%,black 60%);overflow:clip;display:block;}.pop-navigation-buttons-original{top:0px;position:absolute;padding:2px 4px;font-size:10px;}.pop-details-right{position:absolute;max-width:320px;width:320px;left:340px;}.pop-title{font-size:18px;font-weight:bold;margin-bottom:5px;color:white;overflow:clip;white-space:nowrap;max-width:fit-content;display:block;text-overflow:ellipsis;}.pop-rewards-container{display:flex;justify-content:space-between;max-width:320px;}.claimPoPButton,.startPoPButton{margin-top:5px;width:-webkit-fill-available;}.pop-claimed-rewards-container{position:absolute;bottom:10px;left:340px;max-width:320px;width:320px;margin-top:10px;}.pop-claimed-rewards-items{display:flex;flex-wrap:wrap;justify-content:flex-start;align-items:flex-start;column-gap:20px;row-gap:5px;max-width:320px;}.pop-records-container{display:grid !important;grid-template-columns:repeat(3,1fr) !important;gap:4px !important;justify-content:start;align-items:start;width:300px !important;margin-bottom:10px;position:absolute !important;top:60px !important;right:15px !important;}.pop-record{background-size:cover;background-position:center;position:relative;padding:6px;border-radius:3px;min-height:58px;width:100px;box-shadow:0 1px 3px rgba(0,0,0,0.3);cursor:pointer;}.pop-record.selected{border:2px solid #ffcc00 !important;box-shadow:0 0 10px rgba(255,204,0,0.5) !important;}.pop-icon{position:absolute;top:3px;left:3px;width:15px;height:15px;filter:drop-shadow(0 0 1px rgba(0,0,0,0.6)) drop-shadow(1px 1px 1px rgba(0,0,0,0.6)) drop-shadow(-1px -1px 1px rgba(0,0,0,0.6)) drop-shadow(1px -1px 1px rgba(0,0,0,0.6)) drop-shadow(-1px 1px 1px rgba(0,0,0,0.6));}.pop-lvl{position:absolute;top:3px;right:3px;background:rgba(0,0,0,0.6);font-size:12px;color:#ffb827;}.pop-timer{position:absolute;bottom:3px;background:rgba(0,0,0,0.8);color:white;padding:1px 3px;border-radius:1px;font-size:8px;}.collect_notif{position:absolute;bottom:3px;right:3px;}"});var V={};W(V,{default:()=>te});var te,L=E(()=>{"use strict";te=".popup_wrapper > #popup_PoVInfo{width:1020px;height:550px;top:0.62rem;left:0.62rem;}#popup_PoVInfo close{width:2.4rem;height:2.2rem;background-image:url(/images/clubs/ic_xCross.png);opacity:1;}.PoVInfo-container{width:100%;height:100%;box-shadow:none;border:2px solid #ff9900;align-content:center;}.PoVInfo-container img{height:80%;width:auto;}.PoVInfo-container .PoVInfo-title{width:100%;height:10%;font-size:1.8rem;font-weight:bold;color:#FFB827;}"});var u=class{constructor(s){this.hasRun=!1;this.group="severalQoL",this.configSchema=s}};var Q={baseKey:"popupPlusPlus",label:"<span tooltip='Stacking popups,click on popups to make it disappear'>Popup++</span>",default:!0},_=class extends u{constructor(){super(Q)}shouldRun(){return!0}run(){if(this.hasRun||!this.shouldRun())return;this.hasRun=!0,GM.addStyle("#toast-popups {display:inherit!important;}");let s={},e=null;delete shared.general.objectivePopup.show,shared.general.objectivePopup.show=function(o){if(this.LastPoints==null&&(this.LastPoints={}),!(!o.objective_points||o.battle_result)){if(!o.objective_points){let i=o.objective_points;if(Object.keys(this.pointsBox).length)for(let r in i)this.pointsBox[r]?this.pointsBox[r].name===i[r].name&&(this.pointsBox[r].points_gained+=i[r].points_gained):this.pointsBox[r]=i[r];else this.pointsBox=o.objective_points;o?.end?.rewards?.hasOwnProperty("lose")}t(this,o.objective_points)}};function t(o,i){let r=new Set;Object.keys(i).map((n=>{let d=i[n];if(!s[n])s[n]=d,d.points_gained>0&&r.add(n);else{let l=d.points_gained;l>0&&r.add(n),s[n].points_gained+=l}}));let a=$(`<div class="popup_wrapper"><div id="objective_popup" class="popup"><div class="noti_box"><div class="points">${Object.keys(s).map((n=>{let d=s[n];return`<div class="row animate" style="transition: all 20ms;"><div class="contest_name">${d.title}:</div><div class="contest_points"><div class="points_name" style="animation:none;">${d.name}: </div><div class="points_num" style="animation:none;"><div class="points_i" style="animation:none;">+${number_format_lang(d.points_gained)}</div></div></div></div>`})).join("")}</div></div></div></div></div>`);$("#toast-popups .popup_wrapper").remove(),$("#toast-popups").css("display","unset"),$("#toast-popups"),$("#toast-popups").append(a),$("#toast-popups").css("display","unset"),e&&(clearTimeout(e),e=null),e=setTimeout(()=>{a.remove(),e=null,s={}},5e3),a.on("click.removePopup",function(){a.remove(),e=null,s={}})}}};var q={baseKey:"peopleToWiki",label:"People to Wiki(HH,GH,GPSH)",default:!1,subSettings:[{key:"infoBubbleNameToWiki",default:!0,label:"Info bubble name clickable to wiki"},{key:"portraitToWiki",default:!1,label:"Make portrait clickable to wiki"}]},P=class extends u{constructor(){super(q)}shouldRun(){return location.host.includes("heroes")||location.host.includes("gayharem")||location.host.includes("gaypornstarharem")}run(s){this.hasRun||!this.shouldRun()||(this.hasRun=!0,s?.infoBubbleNameToWiki&&setInterval(()=>{this.applyInfoBubbleToWiki()},500),s?.portraitToWiki&&setInterval(()=>{this.applyImageToWiki()},500))}applyInfoBubbleToWiki(){let s=this;$(".new_girl_info .girl_name_wrap > h5[style!='cursor: pointer;']").each(function(){let e=$(this);e.css("cursor","pointer"),e.on("click.InfoBubbleToWiki",function(){let t=e.attr("hh_title");if(!t)return;let o=t.replace(/ /g,"-");GM.openInTab(s.getWikiPageForCurrentGame(o),{active:!0})})})}applyImageToWiki(){let s=this;$(".slot_girl_shards > [data-new-girl-tooltip][style!='cursor: pointer;']").each(function(){let e=$(this),t=e.attr("data-new-girl-tooltip");if(!t)return;let o=t.match(/"name":"(.+)","rarity/);o&&o[1]&&(e.css("cursor","pointer"),e.on("click.ImgToWiki",function(i){i.stopPropagation();let r=o[1].replace(/ /g,"-");GM.openInTab(s.getWikiPageForCurrentGame(r),{active:!0})}))})}getWikiPageForCurrentGame(s){if(location.host.includes("heroes.com"))return`https://harem-battle.club/wiki/Harem-Heroes/HH:${s}`;if(location.host.includes("gayharem"))return`https://harem-battle.club/wiki/Gay-Harem/GH:${s}`;if(location.host.includes("gaypornstarharem"))return`https://harem-battle.club/wiki/Gay-Pornstar-Harem/GPSH:${s}`;throw new Error("Unsupported game for wiki link")}};var v=class extends u{constructor(){let s={baseKey:"entirePaid",label:"Removes only $ options",default:!1};super(s)}shouldRun(){return!0}run(){this.hasRun||!this.shouldRun()||(this.hasRun=!0,GM.addStyle(".pass_reward.reward_wrapper{display:none!important;}"),GM.addStyle("#gsp_btn_holder{display:none!important;}"),GM.addStyle(".rewards_seasons_row .rewards_pair .tier_number{top:100%!important;}"),GM.addStyle("#get_mega_pass_shop_btn{display:none!important;}"),GM.addStyle("#bundles_tab{display:none!important;}"),GM.addStyle(".purchase-shop{display:none!important;}"))}};var z={baseKey:"tighterPoPs",label:"Tighter PoPs (requires css tweaks for PoP)",default:!0},w=class extends u{constructor(){super(z)}shouldRun(){return location.pathname.includes("/activities.html")}run(){this.hasRun||!this.shouldRun()||(this.hasRun=!0,GM.addStyle("#pop .pop_list .pop-action-btn {margin-bottom: 0.4rem!important;margin-top: 0rem!important;}#pop .pop_list .pop_list_scrolling_area .pop_thumb img {height: 90px!important;}.activities-container #pop .pop_list .pop_list_scrolling_area .pop_thumb_container .pop_thumb_expanded {height: 89px!important;background: linear-gradient(0deg, #00000087, transparent)!important;}.activities-container #pop .pop_list .pop_list_scrolling_area .pop_thumb_container, .activities-container #pop .pop_list .pop_list_scrolling_area .pop_thumb_container .pop_thumb_active {min-height: 89px!important;height: 89px!important;margin-bottom: 5px!important;}.activities-container #pop .pop_list .pop_list_scrolling_area .pop_thumb>.pop_thumb_level {top: -93px!important;}.activities-container #pop .pop_list .pop_list_scrolling_area .pop_thumb.pop_thumb_active[status=pending_reward]>.pop_thumb_space {top: -126px!important;}.activities-container #pop .pop_list .pop_list_scrolling_area .collect_notif {margin-top: -91px!important;margin-left: 121px!important;}.activities-container .pop_thumb_progress_bar {margin-top: 21px!important;}"))}};var f=class{static doWhenSelectorAvailable(s,e){if($(s).length)e();else{let t=new MutationObserver(()=>{$(s).length&&(t.disconnect(),e())});t.observe(document.documentElement,{childList:!0,subtree:!0})}}};var J={baseKey:"labyTeamPreset",label:"<span tooltip='Add a button to register laby team presets, and to apply it'>Laby Team Preset</span>",default:!0},y=class extends u{constructor(){super(J);this.savedTeamPresetKey="SeveralQoL_LabyTeamPreset"}shouldRun(){return location.pathname.includes("/edit-labyrinth-team.html")}run(){if(this.hasRun||!this.shouldRun())return;this.hasRun=!0;let e=$(".boss-bang-panel"),t=$('<button class="green_button_L" tooltip="Save preset for later runs">Save Preset</button>');t.on("click",()=>{this.saveCurrentPreset(),o.removeAttr("disabled")}),e.append(t);let o=$(`<button class="green_button_L" tooltip="Use previously saved preset & leave page" ${localStorage.getItem(this.savedTeamPresetKey)?"":"disabled"}>Fill Preset</button>`);o.on("click",()=>{this.loadSavedPreset()}),f.doWhenSelectorAvailable(".change-team-panel .player-team .average-lvl",()=>{$(".change-team-panel .player-team .average-lvl").replaceWith(o)})}saveCurrentPreset(){let e=[];$(".team-hexagon .team-member-container").each(function(){let t=$(this).attr("data-team-member-position"),o=$(this).attr("data-girl-id");$(this).is("[data-girl-id]")&&t&&o&&(e[t]=o)}),console.log("Saving preset: ",e),localStorage.setItem(this.savedTeamPresetKey,JSON.stringify(e))}loadSavedPreset(){let e=localStorage.getItem(this.savedTeamPresetKey);if(!e){console.warn("No saved preset found");return}try{let t=JSON.parse(e);console.log("Loading preset: ",t);let o={class:"Hero",action:"edit_team",girls:t,battle_type:"labyrinth",id_team:unsafeWindow.teamId};console.log("AJAX settings: ",o),shared.general.hh_ajax(o,i=>{shared.general.navigate(unsafeWindow.redirectUrl)})}catch(t){console.error("Failed to load preset:",t)}}};var x=class extends u{constructor(){let s={baseKey:"noAnnoyingPopups",label:"Removes annoying popup appearing automaticly for shops, paths, news",default:!1};super(s)}shouldRun(){return!0}run(){this.hasRun||!this.shouldRun()||(this.hasRun=!0,document.cookie="disabledPopups=PassReminder,Bundles,News; path=/")}};var X={baseKey:"whaleBossTournament",label:"Renames WBT to Whale Boss Tournament",default:!1},k=class extends u{constructor(){super(X)}shouldRun(){return location.pathname.includes("/home.html")}run(){this.hasRun||!this.shouldRun()||(this.hasRun=!0,f.doWhenSelectorAvailable(".world-boss .title",()=>{$(".world-boss .title").text("Whale Boss Tournament")}))}};var h=class{static getStoredGirlsNumber(){return GM_getValue(HH_UNIVERSE+"StoredGirls",0)}static setStoredGirlsNumber(s){GM_setValue(HH_UNIVERSE+"StoredGirls",s)}static setEnumGirlsOrderedByClass(s,e){GM_setValue(HH_UNIVERSE+"EnumGirlsOrderedByClass_"+e,s)}static getEnumGirlsOrderedByClass(s){return GM_getValue(HH_UNIVERSE+"EnumGirlsOrderedByClass_"+s,[])}};var Z={baseKey:"placesOfPowerPlusPlus",label:"Places of Power++ (Beta)",default:!1},S=class extends u{constructor(){super(Z);this.isUpdatingGirls=!1;this.currentPoPGirls={};this.criteriaToClassMap={carac_1:1,carac_2:2,carac_3:3}}convertCriteriaKey(e){return e.replace("_","")}assignGirlsToPoP(e){let t=Object.values(pop_data).find(a=>a.id_places_of_power===e);if(!t)return;let o=t.criteria,i=t.max_team_power;return this.selectOptimalGirls(e,i,o)}selectOptimalGirls(e,t,o){let i=this.convertCriteriaKey(o),r=this.criteriaToClassMap[o],a=h.getEnumGirlsOrderedByClass(r);if(a.length===0)return console.error(`[PoP ${e}] No girls available in storage!`),[];let n=new Set;for(let[p,m]of Object.entries(this.currentPoPGirls))parseInt(p)!==e&&m.forEach(g=>n.add(g));let d=[],l=t;for(let p of a){if(n.has(p))continue;let m=pop_hero_girls[p];if(!m)continue;let g=m[i];if(g<=l){if(l-=g,d.push(p),l===0)break}else if(d.length===0||l>0){let b=p,H=a.indexOf(p);for(let R=H+1;R<a.length;R++){let I=a[R];if(n.has(I))continue;let M=pop_hero_girls[I];if(!M)continue;let O=M[i];if(O<=l){O===l&&(b=I);break}b=I}d.push(b);break}}return d}readdGirlsFromCurrentPoP(e){let t=parseInt(e);delete this.currentPoPGirls[t]}selectNextPoPFromFill(e){e.length!==0&&(e.next().length!==0?e.next().trigger("click"):$(".pop-record").first().trigger("click"))}selectNextPoPFromClaim(e){e.length!==0&&($(".pop-record > .collect_notif").length!==0?$(".pop-record > .collect_notif").first().parent().trigger("click"):$(".pop-record").first().trigger("click"))}sendClaimRequest(e){shared.animations.loadingAnimation.start(),this.readdGirlsFromCurrentPoP(e);let t=pop_data[parseInt(e)];if($(".claimPoPButton").prop("disabled",!0),t.ends_in===null||t.ends_in!==0)$(".claimPoPButton").css("display","none"),$(".startPoPButton").css("display",""),pop_data[parseInt(e)].status="can_start",$(".pop-record.selected .collect_notif").remove();else{let i=$(".pop-record.selected");this.selectNextPoPFromFill(i),i.remove()}let o={namespace:"h\\PlacesOfPower",class:t.type==="standard"?"PlaceOfPower":"TempPlaceOfPower",action:"claim",id_place_of_power:t.id_places_of_power};shared.general.hh_ajax(o,i=>{let r=$(".pop-claimed-rewards-items");if(r.length){if(i.rewards.data.rewards){let a=shared.reward.newReward.multipleSlot(i.rewards.data.rewards);r.append(a)}this.selectNextPoPFromFill($(".pop-record.selected")),shared.animations.loadingAnimation.stop()}})}calculateTimeToFinish(e,t){let o=this.convertCriteriaKey(e.criteria),i=0;for(let a of t){let n=pop_hero_girls[a];n&&(i+=n[o])}if(i>=e.max_team_power)return 360*60;let r=e.level_power/i;return Math.floor(r*60)}sendFillRequest(e){shared.animations.loadingAnimation.start();let t=pop_data[parseInt(e)];if(t.status!=="can_start")return;let o=t.id_places_of_power;console.log(`[PoP ${o}] Building girl assignment for this PoP...`);let i=this.assignGirlsToPoP(o)||[];if(this.currentPoPGirls[o]=i,i.length===0){alert("No girls were assigned to this PoP. This might happen if all your girls are already assigned to other PoPs."),delete this.currentPoPGirls[o],shared.animations.loadingAnimation.stop();return}let r=this.convertCriteriaKey(t.criteria),a=0;for(let p of i){let m=pop_hero_girls[p];m&&(a+=m[r])}if(a<t.max_team_power&&!confirm(`Warning: This PoP is not fully maxed!

Current Power: ${Math.floor(a)}
Max Power: ${t.max_team_power}

This will take longer than 6 hours to complete.
Do you want to continue?`)){delete this.currentPoPGirls[o],$(".startPoPButton").css("display",""),$(".claimPoPButton").css("display","none"),shared.animations.loadingAnimation.stop();return}$(".startPoPButton").css("display","none"),$(".claimPoPButton").css("display","");let n={namespace:"h\\PlacesOfPower",class:t.type==="standard"?"PlaceOfPower":"TempPlaceOfPower",action:"start",id_place_of_power:o,selected_girls:i},d=$('<div class="pop-timer"></div>'),l=shared.timer.buildTimer(this.calculateTimeToFinish(t,i),"","pop-active-timer",!1);d.append(l),$(".pop-record.selected").append(d),pop_data[parseInt(e)].status="in_progress",shared.general.hh_ajax(n,p=>{shared.timer.activateTimers("pop-record.selected .pop-active-timer",()=>{}),this.selectNextPoPFromFill($(".pop-record.selected")),shared.animations.loadingAnimation.stop()})}buildPopDetails(e){let t=$(".pop-details-container");if(!t.length)return;t.children().not(".pop-claimed-rewards-container").remove();let o=pop_data[parseInt(e)];if(!o)return;let i=$('<div class="pop-details-left"></div>');t.append(i);let r=$("<img></img>");r.attr("src",o.girl?o.girl.avatar:IMAGES_URL+"/pictures/girls/1/avb0-1200x.webp?a=1"),i.append(r);let a=$('<div class="pop-navigation-buttons-original blue_button_L">Visit Original</div>');a.on("click",()=>{shared.general.navigate("/activities.html?tab=pop&index=")}),i.append(a);let n=$("<div class='pop-details-right'></div>");t.prepend(n);let d=$(`<a tooltip="Visit this PoP original page" class="pop-title" href="${shared.general.getDocumentHref("/activities.html?tab=pop&index="+o.id_places_of_power)}">${o.title}</div>`);n.append(d);let l=$('<div class="pop-rewards-container"></div>');for(let[g,b]of Object.entries(o.rewards))if(b.loot){let H=shared.reward.newReward.multipleSlot(b);l.append(H);break}n.append(l);let p=$(`<button class="purple_button_L claimPoPButton" ${o.status!="pending_reward"?"disabled":""}>Claim</button>`);n.append(p),p.on("click",()=>{this.sendClaimRequest(e)});let m=$('<button class="blue_button_L startPoPButton">Fill & Start</button>');if(m.on("click",()=>{this.sendFillRequest(e)}),n.append(m),o.status!=="can_start"?m.css("display","none"):p.css("display","none"),!$(".pop-claimed-rewards-container").length){let g=$("<div class='pop-claimed-rewards-container'></div>");t.append(g),g.append("<b>Claimed Rewards:</b>");let b=$("<div class='pop-claimed-rewards-items'></div>");g.append(b)}}shouldRun(){return location.pathname.includes("/activities.html")&&!location.search.includes("?tab=pop&index=")}run(){if(this.hasRun||!this.shouldRun())return;this.hasRun=!0;let e=$(".switch-tab[data-tab='pop']");e.contents()[0].nodeValue="Places of Power++",e.attr("tooltip","By infarctus"),e.on("click",async()=>{if(this.isUpdatingGirls){for(shared.animations.loadingAnimation.start();this.isUpdatingGirls;)await new Promise(t=>setTimeout(t,100));shared.animations.loadingAnimation.stop()}this.buildCustomPopInfo()}),this.injectCustomStyles(),this.girlsHandler().then(()=>{this.whichGirlsInPoP()})}buildCustomPopInfo(){let e=$("#pop_info");if(!e.length)return;e.empty();let t=$('<div class="pop-details-container"></div>');e.append(t);let o=$('<div class="pop-records-container"></div>');Object.entries(pop_data).forEach(([i,r])=>{let a=$('<div class="pop-record"></div>');a.attr("data-pop-id",i),a.css("background-image",`url(${r.image})`),a.on("click",()=>{$(".pop-record").removeClass("selected"),a.addClass("selected"),this.buildPopDetails(i)});let n=$(`<img src="https://hh.hh-content.com/pictures/misc/items_icons/${r.class}.png" class="pop-icon" />`);a.append(n);let d=$(`<div class="pop-lvl">Lv. ${r.level}</div>`);if(a.append(d),r.status==="in_progress"){let l=$('<div class="pop-timer"></div>'),p=shared.timer.buildTimer(r.remaining_time,"","pop-active-timer",!1);l.append(p),a.append(l)}if(r.status==="pending_reward"){let l=$('<div class="collect_notif"></div>');a.append(l)}o.append(a),a.attr("tooltip",r.title)}),e.append(o),$(".pop-record").first().trigger("click"),shared.timer.activateTimers("pop-active-timer",()=>{})}injectCustomStyles(){let e=(N(),j(F)).default;GM.addStyle(e)}binarySearchInsertIndex(e,t,o){let i=0,r=e.length;for(;i<r;){let a=Math.floor((i+r)/2),n=pop_hero_girls[e[a]];if(!n){i=a+1;continue}let d=n[o];t>d?r=a:i=a+1}return i}async girlsHandler(){let e=h.getStoredGirlsNumber(),t=Object.keys(pop_hero_girls).length;if(t-e<5)return;this.isUpdatingGirls=!0;let o=Object.values(pop_hero_girls);if(e<=100){console.log(`[PoP++] Performing full sort for ${t} girls`);let r=[...o].sort((p,m)=>m.carac1-p.carac1).map(p=>p.id_girl);h.setEnumGirlsOrderedByClass(r,1);let n=[...o].sort((p,m)=>m.carac2-p.carac2).map(p=>p.id_girl);h.setEnumGirlsOrderedByClass(n,2);let l=[...o].sort((p,m)=>m.carac3-p.carac3).map(p=>p.id_girl);h.setEnumGirlsOrderedByClass(l,3),h.setStoredGirlsNumber(t),console.log("[PoP++] Full sort completed")}else{let i=h.getEnumGirlsOrderedByClass(1),r=h.getEnumGirlsOrderedByClass(2),a=h.getEnumGirlsOrderedByClass(3),n=new Set(i),d=o.filter(l=>!n.has(l.id_girl));for(let l of d){let p=this.binarySearchInsertIndex(i,l.carac1,"carac1");i.splice(p,0,l.id_girl);let m=this.binarySearchInsertIndex(r,l.carac2,"carac2");r.splice(m,0,l.id_girl);let g=this.binarySearchInsertIndex(a,l.carac3,"carac3");a.splice(g,0,l.id_girl)}h.setEnumGirlsOrderedByClass(i,1),h.setEnumGirlsOrderedByClass(r,2),h.setEnumGirlsOrderedByClass(a,3),h.setStoredGirlsNumber(t),console.log(`[PoP++] Binary search insertion completed for ${d.length} new girls`)}}whichGirlsInPoP(){for(let e of Object.values(pop_data)){let t=[];e.girls.forEach(o=>{o.assigned===e.id_places_of_power&&t.push(o.id_girl)}),this.currentPoPGirls[e.id_places_of_power]=t}this.isUpdatingGirls=!1}};var ee={baseKey:"noReloadFromClaimingDailyChests",label:"No reload from claiming daily chests",default:!0},C=class extends u{constructor(){super(ee)}shouldRun(){return!0}run(){if(this.hasRun||!this.shouldRun())return location.pathname.includes("/activities.html");this.hasRun=!0,$(".switch-tab[data-tab='daily_goals']").on("click",()=>{console.log("Clicked daily goals"),f.doWhenSelectorAvailable(".progress-bar-claim-reward",()=>{this.applyNoReloadFix()})})}applyNoReloadFix(){let s=this;$(".progress-bar-claim-reward").off("click").on("click",function(e){e.stopPropagation(),e.preventDefault(),$(this).prop("disabled",!0);let t=$(this).attr("tier");if(!t)return;let o={action:"claim_daily_goal_tier_reward",tier:t};daily_goals_member_progression.taken_rewards_array.push(t),shared.general.hh_ajax(o,i=>{let r=i.rewards;shared.reward_popup.Reward.handlePopup(r),s.checkIfAllChestsClaimed()})}),$(".progress-bar-claim-reward").attr("tooltip","Several QoL: Claim without reload")}checkIfAllChestsClaimed(){daily_goals_member_progression.taken_rewards_array.length>=Math.min(Math.floor(daily_goals_member_progression.potions_amount/20),5)&&$('[data-tab="daily_goals"] > .collect_notif').remove()}};var oe={baseKey:"povInfo",label:"PoV Info",default:!0},G=class extends u{constructor(){super(oe)}shouldRun(){return location.pathname.includes("/path-of-valor.html")}run(){this.hasRun||!this.shouldRun()||(this.hasRun=!0,f.doWhenSelectorAvailable(".potions-paths-objective > h4",()=>{$(".potions-paths-objective > h4").text("PoV Info (click)"),$(".potions-paths-objective > h4").css("cursor","pointer"),$(".potions-paths-objective > h4").on("click",()=>{this.activatePopup()})}))}activatePopup(){let s=$('<div class="popup_background clickable"></div><div id="popup_PoVInfo" class="popup"><div class="PoVInfo-container container-special-bg"><span class="PoVInfo-title">Path of Valor Info</span><p>PoV cycle through those goals in order</p><img src="https://raw.githubusercontent.com/infarcactus-HH/HH-Several_QoL/refs/heads/main/images/PoVInfo.png" alt="PoVInfo" /></div><close class="closable"></close></div>'),e=(L(),j(V)).default;GM.addStyle(e);let t={type:"common",init:o=>{console.log("init pov info popup",o);let i=$("#common-popups");t.$dom_element.empty().append(s),i.append(t.$dom_element)},destroy:()=>{console.log("destroy pov info popup"),shared.PopupQueueManager.close({type:"common"})},onClose:()=>{},onOpen:()=>{},$dom_element:$('<div class="popup_wrapper"></div>'),popup_name:"pov_info",close_on_esc:!0,addEventListeners:()=>{console.log("add event listeners pov info popup"),t.$dom_element.find("close.closable").on("click",()=>{t.destroy()}),t.$dom_element.find(".popup_background.clickable").on("click",()=>{t.destroy()})},removeEventListeners:()=>{}};shared.PopupQueueManager.add({popup:t})}};var B=class{constructor(){this.allModules=[new _,new y,new x,new v,new P,new w,new k,new S,new C,new G];if(unsafeWindow.hhPlusPlusConfig===void 0){Promise.race([new Promise(s=>{$(document).one("hh++-bdsm:loaded",()=>s("hh++-bdsm:loaded"))}),new Promise(s=>setTimeout(()=>s("timeout"),50))]).then(s=>{s==="hh++-bdsm:loaded"?this.run():this.runWithoutBdsm()});return}this.run()}run(){unsafeWindow.hhPlusPlusConfig.registerGroup({key:"severalQoL",name:"<span tooltip='by infarctus'>Several QoL</span>"}),this.allModules.forEach(s=>{unsafeWindow.hhPlusPlusConfig.registerModule(s)}),unsafeWindow.hhPlusPlusConfig.loadConfig(),unsafeWindow.hhPlusPlusConfig.runModules()}runWithoutBdsm(){this.allModules.forEach(s=>{try{let e=s.configSchema;if(s.shouldRun())if(e.subSettings){let t=e.subSettings.reduce((o,i)=>(o[i.key]=!0,o),{});s.run(t)}else s.run(void 0)}catch(e){console.error("Error running module",s,e)}})}};new B;})();
