// ==UserScript==
// @name         Several QoL
// @namespace    http://tampermonkey.net/
// @version      1.10.2
// @description  A userscript for QoL for the Haremverse
// @author       infarcactus
// @license      GPLv3
// @match        https://nutaku.haremheroes.com/*
// @match        https://*.hentaiheroes.com/*
// @match        https://*.gayharem.com/*
// @match        https://*.comixharem.com/*
// @match        https://*.hornyheroes.com/*
// @match        https://*.pornstarharem.com/*
// @match        https://*.transpornstarharem.com/*
// @match        https://*.gaypornstarharem.com/*
// @match        https://*.mangarpg.com/*
// @updateURL    https://github.com/infarcactus-HH/HH-Several_QoL/raw/refs/heads/main/dist/userscript.user.js
// @downloadURL  https://github.com/infarcactus-HH/HH-Several_QoL/raw/refs/heads/main/dist/userscript.user.js
// @grant        GM.addStyle
// @grant        GM_addStyle
// @grant        GM.openInTab
// @grant        GM_getValue
// @grant        GM_setValue
// @grant        GM_deleteValue
// @grant        unsafeWindow
// @run-at       document-end
// ==/UserScript==

"use strict";(()=>{var A=Object.defineProperty;var z=Object.getOwnPropertyDescriptor;var J=Object.getOwnPropertyNames;var X=Object.prototype.hasOwnProperty;var I=(u,r)=>()=>(u&&(r=u(u=0)),r);var O=(u,r)=>{for(var e in r)A(u,e,{get:r[e],enumerable:!0})},Y=(u,r,e,o)=>{if(r&&typeof r=="object"||typeof r=="function")for(let t of J(r))!X.call(u,t)&&t!==e&&A(u,t,{get:()=>r[t],enumerable:!(o=z(r,t))||o.enumerable});return u};var E=u=>Y(A({},"__esModule",{value:!0}),u);var D={};O(D,{default:()=>re});var re,W=I(()=>{"use strict";re=".pop-details-container{position:absolute;top:60px;left:10px;width:685px;float:left;min-height:200px;}.pop-details-left{position:absolute;width:300px;height:-webkit-fill-available;}.pop-details-left img{height:800px;mask-image:linear-gradient(to top,transparent 45%,black 60%);overflow:clip;display:block;}.pop-navigation-buttons-original{top:0px;position:absolute;padding:2px 4px;font-size:10px;}.pop-details-right{position:absolute;max-width:320px;width:320px;left:340px;top:35px;}.pop-title{font-size:18px;font-weight:bold;margin-bottom:5px;color:white;overflow:clip;white-space:nowrap;max-width:fit-content;display:block;text-overflow:ellipsis;}.pop-rewards-container{display:flex;justify-content:space-between;max-width:320px;}.claimPoPButton,.startPoPButton{margin-top:5px;width:-webkit-fill-available;}.pop-claimed-rewards-container{position:absolute;bottom:10px;left:340px;max-width:320px;width:320px;margin-top:10px;}.pop-claimed-rewards-items{display:flex;flex-wrap:wrap;justify-content:flex-start;align-items:flex-start;column-gap:20px;row-gap:5px;max-width:320px;}.pop-records-container{display:grid !important;grid-template-columns:repeat(3,1fr) !important;gap:4px !important;justify-content:start;align-items:start;width:300px !important;margin-bottom:10px;position:absolute !important;top:60px !important;right:15px !important;}.pop-record{background-size:cover;background-position:center;position:relative;padding:6px;border-radius:3px;min-height:58px;width:100px;box-shadow:0 1px 3px rgba(0,0,0,0.3);cursor:pointer;}.pop-record.selected{border:2px solid #ffcc00 !important;box-shadow:0 0 10px rgba(255,204,0,0.5) !important;}.pop-icon{position:absolute;top:3px;left:3px;width:15px;height:15px;filter:drop-shadow(0 0 1px rgba(0,0,0,0.6)) drop-shadow(1px 1px 1px rgba(0,0,0,0.6)) drop-shadow(-1px -1px 1px rgba(0,0,0,0.6)) drop-shadow(1px -1px 1px rgba(0,0,0,0.6)) drop-shadow(-1px 1px 1px rgba(0,0,0,0.6));}.pop-lvl{position:absolute;top:3px;right:3px;background:rgba(0,0,0,0.6);font-size:12px;color:#ffb827;}.pop-timer{position:absolute;bottom:3px;background:rgba(0,0,0,0.8);color:white;padding:1px 3px;border-radius:1px;font-size:8px;}.collect_notif{position:absolute;bottom:3px;right:3px;}.pop-koban-buttons-container{position:absolute;left:340px;width:320px;display:flex;flex-direction:row;align-items:center;gap:10px;flex-wrap:nowrap;}.pop-koban-buttons-container > .pop-koban-button{display:flex;flex-direction:row;align-items:center;gap:20px;width:160px;padding:0 10px;margin-top:0;}.pop-koban-button > .action-cost{display:flex;align-items:end;margin-left:auto;}"});var V={};O(V,{default:()=>ie});var ie,F=I(()=>{"use strict";ie=".popup_wrapper > #popup_PoVInfo{width:1020px;height:550px;top:0.62rem;left:0.62rem;}#popup_PoVInfo close{width:2.4rem;height:2.2rem;background-image:url(/images/clubs/ic_xCross.png);opacity:1;}.PoVInfo-container{width:100%;height:100%;box-shadow:none;border:2px solid #ff9900;align-content:center;}.PoVInfo-container img{height:80%;width:auto;}.PoVInfo-container .PoVInfo-title{width:100%;height:10%;font-size:1.8rem;font-weight:bold;color:#FFB827;}"});var q={};O(q,{default:()=>pe});var pe,K=I(()=>{"use strict";pe=".me-ranking-tooltip th,.me-ranking-tooltip td{border:1px solid #ccc;padding:5px;text-align:center;}.me-leaderboard-info{position:absolute;right:13rem;width:20px;}"});var U={};O(U,{default:()=>de});var de,Q=I(()=>{"use strict";de=".several-qol-bestrank-timesreached{margin-left:5px;display:flex;width:100%;align-items:center;text-shadow:1px 0 0 #000,0 1px 0 #000,-1px 0 0 #000,0 -1px 0 #000,1px 1px 0 #000,-1px -1px 0 #000,1px -1px 0 #000,-1px 1px 0 #000;}.several-qol-bestrank-timesreached > .rank-container{background-size:cover;text-align:center;min-width:16px;max-width:32px;width:auto;height:16px;font-size:10px;}.several-qol-bestrank-timesreached > .times-reached{margin-left:3px;}.several-qol-top1{background:transparent radial-gradient(closest-side at 50% 50%,#f5a866 0%,#ec0039 51%,#9e0e27 100%) 0% 0% no-repeat padding-box;}.several-qol-top4{background-image:url(/images/legendary.png);}.several-qol-top15{background:#ffb244;}.several-qol-top30{background:#23b56b;}.several-qol-top30plus{background:#8d8e9f;}"});var h=class{constructor(r){this.hasRun=!1;this.group="severalQoL",this.configSchema=r}};var Z={baseKey:"popupPlusPlus",label:"<span tooltip='Stacking popups,click on popups to make it disappear'>Popup++</span>",default:!0},_=class extends h{constructor(){super(Z)}shouldRun(){return!0}run(){if(this.hasRun||!this.shouldRun())return;this.hasRun=!0,GM.addStyle("#toast-popups {display:inherit!important;}");let r={},e=null;delete shared.general.objectivePopup.show,shared.general.objectivePopup.show=function(t){if(this.LastPoints==null&&(this.LastPoints={}),!(!t.objective_points||t.battle_result)){if(!t.objective_points){let a=t.objective_points;if(Object.keys(this.pointsBox).length)for(let n in a)this.pointsBox[n]?this.pointsBox[n].name===a[n].name&&(this.pointsBox[n].points_gained+=a[n].points_gained):this.pointsBox[n]=a[n];else this.pointsBox=t.objective_points;t?.end?.rewards?.hasOwnProperty("lose")}o(this,t.objective_points)}};function o(t,a){let n=new Set;Object.keys(a).map((i=>{let c=a[i];if(!r[i])r[i]=c,c.points_gained>0&&n.add(i);else{let l=c.points_gained;l>0&&n.add(i),r[i].points_gained+=l}}));let s=$(`<div class="popup_wrapper"><div id="objective_popup" class="popup"><div class="noti_box"><div class="points">${Object.keys(r).map((i=>{let c=r[i];return`<div class="row animate" style="transition: all 20ms;"><div class="contest_name">${c.title}:</div><div class="contest_points"><div class="points_name" style="animation:none;">${c.name}: </div><div class="points_num" style="animation:none;"><div class="points_i" style="animation:none;">+${number_format_lang(c.points_gained)}</div></div></div></div>`})).join("")}</div></div></div></div></div>`);$("#toast-popups .popup_wrapper").remove(),$("#toast-popups").css("display","unset"),$("#toast-popups"),$("#toast-popups").append(s),$("#toast-popups").css("display","unset"),e&&(clearTimeout(e),e=null),e=setTimeout(()=>{s.remove(),e=null,r={}},5e3),s.on("click.removePopup",function(){s.remove(),e=null,r={}})}}};var ee={baseKey:"peopleToWiki",label:"People to Wiki(HH,GH,GPSH)",default:!1,subSettings:[{key:"infoBubbleNameToWiki",default:!0,label:"Info bubble name clickable to wiki"},{key:"portraitToWiki",default:!1,label:"Make portrait clickable to wiki"}]},P=class extends h{constructor(){super(ee)}shouldRun(){return location.host.includes("heroes")||location.host.includes("gayharem")||location.host.includes("gaypornstarharem")}run(r){this.hasRun||!this.shouldRun()||(this.hasRun=!0,r?.infoBubbleNameToWiki&&setInterval(()=>{this.applyInfoBubbleToWiki()},500),r?.portraitToWiki&&setInterval(()=>{this.applyImageToWiki()},500))}applyInfoBubbleToWiki(){let r=this;$(".new_girl_info .girl_name_wrap > h5[style!='cursor: pointer;']").each(function(){let e=$(this);e.css("cursor","pointer"),e.on("click.InfoBubbleToWiki",function(){let o=e.attr("hh_title");if(!o)return;let t=o.replace(/ /g,"-");GM.openInTab(r.getWikiPageForCurrentGame(t),{active:!0})})})}applyImageToWiki(){let r=this;$(".slot_girl_shards > [data-new-girl-tooltip][style!='cursor: pointer;']").each(function(){let e=$(this),o=e.attr("data-new-girl-tooltip");if(!o)return;let t=o.match(/"name":"(.+)","rarity/);t&&t[1]&&(e.css("cursor","pointer"),e.on("click.ImgToWiki",function(a){a.stopPropagation();let n=t[1].replace(/ /g,"-");GM.openInTab(r.getWikiPageForCurrentGame(n),{active:!0})}))})}getWikiPageForCurrentGame(r){if(location.host.includes("heroes.com"))return`https://harem-battle.club/wiki/Harem-Heroes/HH:${r}`;if(location.host.includes("gayharem"))return`https://harem-battle.club/wiki/Gay-Harem/GH:${r}`;if(location.host.includes("gaypornstarharem"))return`https://harem-battle.club/wiki/Gay-Pornstar-Harem/GPSH:${r}`;throw new Error("Unsupported game for wiki link")}};var y=class extends h{constructor(){let r={baseKey:"entirePaid",label:"Removes only $ options",default:!1};super(r)}shouldRun(){return!0}run(){this.hasRun||!this.shouldRun()||(this.hasRun=!0,GM.addStyle(".pass_reward.reward_wrapper{display:none!important;}"),GM.addStyle("#gsp_btn_holder{display:none!important;}"),GM.addStyle(".rewards_seasons_row .rewards_pair .tier_number{top:100%!important;}"),GM.addStyle("#get_mega_pass_shop_btn{display:none!important;}"),GM.addStyle("#bundles_tab{display:none!important;}"),GM.addStyle(".purchase-shop{display:none!important;}"))}};var te={baseKey:"tighterPoPs",label:"Tighter PoPs (requires css tweaks for PoP)",default:!0},v=class extends h{constructor(){super(te)}shouldRun(){return location.pathname.includes("/activities.html")}run(){this.hasRun||!this.shouldRun()||(this.hasRun=!0,GM.addStyle("#pop .pop_list .pop-action-btn {margin-bottom: 0.4rem!important;margin-top: 0rem!important;}#pop .pop_list .pop_list_scrolling_area .pop_thumb img {height: 90px!important;}.activities-container #pop .pop_list .pop_list_scrolling_area .pop_thumb_container .pop_thumb_expanded {height: 89px!important;background: linear-gradient(0deg, #00000087, transparent)!important;}.activities-container #pop .pop_list .pop_list_scrolling_area .pop_thumb_container, .activities-container #pop .pop_list .pop_list_scrolling_area .pop_thumb_container .pop_thumb_active {min-height: 89px!important;height: 89px!important;margin-bottom: 5px!important;}.activities-container #pop .pop_list .pop_list_scrolling_area .pop_thumb>.pop_thumb_level {top: -93px!important;}.activities-container #pop .pop_list .pop_list_scrolling_area .pop_thumb.pop_thumb_active[status=pending_reward]>.pop_thumb_space {top: -126px!important;}.activities-container #pop .pop_list .pop_list_scrolling_area .collect_notif {margin-top: -91px!important;margin-left: 121px!important;}.activities-container .pop_thumb_progress_bar {margin-top: 21px!important;}"))}};var f=class{static doWhenSelectorAvailable(r,e){if($(r).length)e();else{let o=new MutationObserver(()=>{$(r).length&&(o.disconnect(),e())});o.observe(document.documentElement,{childList:!0,subtree:!0})}}};var oe={baseKey:"labyTeamPreset",label:"<span tooltip='Add a button to register laby team presets, and to apply it'>Laby Team Preset</span>",default:!0},w=class extends h{constructor(){super(oe);this.savedTeamPresetKey="SeveralQoL_LabyTeamPreset"}shouldRun(){return location.pathname.includes("/edit-labyrinth-team.html")}run(){if(this.hasRun||!this.shouldRun())return;this.hasRun=!0;let e=$(".boss-bang-panel"),o=$('<button class="green_button_L" tooltip="Save preset for later runs">Save Preset</button>');o.on("click",()=>{this.saveCurrentPreset(),t.removeAttr("disabled")}),e.append(o);let t=$(`<button class="green_button_L" tooltip="Use previously saved preset & leave page" ${localStorage.getItem(this.savedTeamPresetKey)?"":"disabled"}>Fill Preset</button>`);t.on("click",()=>{this.loadSavedPreset()}),f.doWhenSelectorAvailable(".change-team-panel .player-team .average-lvl",()=>{$(".change-team-panel .player-team .average-lvl").replaceWith(t)})}saveCurrentPreset(){let e=[];$(".team-hexagon .team-member-container").each(function(){let o=$(this).attr("data-team-member-position"),t=$(this).attr("data-girl-id");$(this).is("[data-girl-id]")&&o&&t&&(e[o]=t)}),console.log("Saving preset: ",e),localStorage.setItem(this.savedTeamPresetKey,JSON.stringify(e))}loadSavedPreset(){let e=localStorage.getItem(this.savedTeamPresetKey);if(!e){console.warn("No saved preset found");return}try{let o=JSON.parse(e);console.log("Loading preset: ",o);let t={class:"Hero",action:"edit_team",girls:o,battle_type:"labyrinth",id_team:unsafeWindow.teamId};console.log("AJAX settings: ",t),shared.general.hh_ajax(t,a=>{shared.general.navigate(unsafeWindow.redirectUrl)})}catch(o){console.error("Failed to load preset:",o)}}};var x=class extends h{constructor(){let r={baseKey:"noAnnoyingPopups",label:"Removes annoying popup appearing automaticly for shops, paths, news",default:!1};super(r)}shouldRun(){return!0}run(){this.hasRun||!this.shouldRun()||(this.hasRun=!0,document.cookie="disabledPopups=PassReminder,Bundles,News; path=/")}};var ae={baseKey:"whaleBossTournament",label:"Renames WBT to Whale Boss Tournament",default:!1},k=class extends h{constructor(){super(ae)}shouldRun(){return location.pathname.includes("/home.html")}run(){this.hasRun||!this.shouldRun()||(this.hasRun=!0,f.doWhenSelectorAvailable(".world-boss .title",()=>{$(".world-boss .title").text("Whale Boss Tournament")}))}};var m=class{static getStoredGirlsNumber(){return GM_getValue(HH_UNIVERSE+"StoredGirls",0)}static setStoredGirlsNumber(r){GM_setValue(HH_UNIVERSE+"StoredGirls",r)}static setEnumGirlsOrderedByClass(r,e){GM_setValue(HH_UNIVERSE+"EnumGirlsOrderedByClass_"+e,r)}static getEnumGirlsOrderedByClass(r){return GM_getValue(HH_UNIVERSE+"EnumGirlsOrderedByClass_"+r,[])}static setLastSortOfGirls(r){GM_setValue(HH_UNIVERSE+"PoPLastSortOfGirls",r)}static getLastSortOfGirls(){return GM_getValue(HH_UNIVERSE+"PoPLastSortOfGirls",0)}static setLeaguePLayerRecord(r){GM_setValue(HH_UNIVERSE+"LeaguePlayerRecord",r)}static getLeaguePlayerRecord(){return GM_getValue(HH_UNIVERSE+"LeaguePlayerRecord",{})}};var se={baseKey:"placesOfPowerPlusPlus",label:"Places of Power++",default:!0},R=class extends h{constructor(){super(se);this.isUpdatingGirls=!1;this.currentPoPGirls={};this.minPercentToStartPoP=.05;this.criteriaToClassMap={carac_1:1,carac_2:2,carac_3:3}}shouldRun(){return location.pathname.includes("/activities.html")&&!location.search.includes("?tab=pop&index=")}run(){if(this.hasRun||!this.shouldRun())return;this.hasRun=!0;let e=$(".switch-tab[data-tab='pop']");e.contents()[0].nodeValue="Places of Power++",e.attr("tooltip","By infarctus"),e.on("click",async()=>{if(this.isUpdatingGirls){for(shared.animations.loadingAnimation.start();this.isUpdatingGirls;)await new Promise(o=>setTimeout(o,100));shared.animations.loadingAnimation.stop()}this.buildCustomPopInfo()}),this.injectCustomStyles(),this.girlsHandler().then(()=>{this.whichGirlsInPoP()})}updateHHPlusPlusPoPTrackedTime(e){let o="HHPlusPlusTrackedTimes";if(!localStorage.getItem(o)){console.log("No HHPlusPlusTrackedTimes found in localStorage");return}let t=JSON.parse(localStorage.getItem(o)||"{}");if(!t.pop||!t.popDuration){console.log("No trackedTimes.pop or trackedTimes.popDuration found");return}for(let n of Object.values(pop_data))if(n.status==="pending_reward"){console.log("There is a PoP to claim, not updating tracked time");return}let a=Math.floor(Date.now()/1e3);if(a<t.pop+t.popDuration){console.log("Existing PoP tracked time is still valid, not updating");return}t.pop=a+e,t.popDuration=e,localStorage.setItem(o,JSON.stringify(t)),console.log("Updated HHPlusPlusTrackedTimes with new PoP end time",t)}createOrUpdateKobanButtons(){let e=!1,o=!1;for(let s of Object.values(pop_data))if(s.status==="pending_reward"&&(e=!0),s.status==="can_start"&&(o=!0),e&&o)break;$(".pop-koban-buttons-container").length&&$(".pop-koban-buttons-container").remove();let t=$('<div class="pop-koban-buttons-container"></div>'),a=$(`<btn class="pop-koban-button pop-claim-all orange_button_L" price="${hh_prices_auto_claim}" ${e?"":"disabled"}>
        <div class="action-label">Claim All</div>
        <div class="action-cost">
          <div class="hc-cost">
            <span class="hard_currency_icn"></span>
            ${hh_prices_auto_claim}
          </div>
        </div>
      </div>`);a.on("click",function(){let s=$(this);if(s.attr("disabled")!==void 0)return;let i=s.attr("price");shared.general.hc_confirm(i,()=>{s.prop("disabled",!0),shared.general.hh_ajax({action:"pop_claim_all"},c=>{s.prop("disabled",!1);let l=shared.reward.newReward.multipleSlot(c.rewards.data.rewards);$(".pop-claimed-rewards-items").append(l);for(let d of Object.values(pop_data))d.status==="pending_reward"&&(d.status="can_start");$(".pop-record .collect_notif").remove()})})}),t.append(a);let n=$(`<btn class="pop-koban-button pop-fill-all orange_button_L" price="${hh_prices_auto_start}" ${o?"":"disabled"}>
        <div class="action-label">Fill All</div>
        <div class="action-cost">
          <div class="hc-cost">
            <span class="hard_currency_icn"></span>
            ${hh_prices_auto_start}
          </div>
        </div>
      </div>`);n.on("click",function(){let s=$(this);if(s.attr("disabled")!==void 0)return;let i=s.attr("price");shared.general.hc_confirm(i,()=>{s.prop("disabled",!0),shared.general.hh_ajax({action:"pop_auto_start_all"},function(){s.prop("disabled",!1),location.reload()})})}),t.append(n),$(".pop-details-container").append(t)}convertCriteriaKey(e){return e.replace("_","")}assignGirlsToPoP(e){let o=Object.values(pop_data).find(s=>s.id_places_of_power===e);if(!o)return;let t=o.criteria,a=o.max_team_power;return this.selectOptimalGirls(e,a,t)}selectOptimalGirls(e,o,t){let a=this.convertCriteriaKey(t),n=this.criteriaToClassMap[t],s=m.getEnumGirlsOrderedByClass(n);if(s.length===0)return console.error(`[PoP ${e}] No girls available in storage!`),[];let i=new Set;for(let[p,d]of Object.entries(this.currentPoPGirls))parseInt(p)!==e&&d.forEach(g=>i.add(g));let c=[],l=o;for(let p of s){if(i.has(p))continue;let d=pop_hero_girls[p];if(!d)continue;let g=d[a];if(g<=l){if(l-=g,c.push(p),l===0)break}else if(c.length===0||l>0){let b=p,M=s.indexOf(p);for(let B=M+1;B<s.length;B++){let G=s[B];if(i.has(G))continue;let j=pop_hero_girls[G];if(!j)continue;let N=j[a];if(N<=l){N===l&&(b=G);break}b=G}c.push(b);break}}return c}readdGirlsFromCurrentPoP(e){let o=parseInt(e);delete this.currentPoPGirls[o]}selectNextPoPFromFill(e){if(e.length===0)return;let o=e.nextAll().filter(function(){let t=$(this).data("pop-id");return pop_data[t]&&pop_data[t].status!=="in_progress"}).first();if(o.length){o.trigger("click");return}if(o=$(".pop-record").filter(function(){let t=$(this).data("pop-id");return pop_data[t]&&pop_data[t].status!=="in_progress"}).first(),o.length)o.trigger("click");else{for(let t of Object.values(pop_data))if(t.status!=="in_progress"){$(`[data-pop-id='${t.id_places_of_power}']`).trigger("click");return}$(".pop-record").first().trigger("click")}}selectNextPoPFromClaim(){let e=$(".pop-record.selected");if(e.nextAll().find(".collect_notif").length!==0){e.nextAll().find(".collect_notif").first().parent().trigger("click");return}let o=$(".pop-record").find(".collect_notif").first();if(o.length){o.parent().trigger("click");return}else for(let t of Object.values(pop_data))if(t.status==="can_start"){$(`[data-pop-id='${t.id_places_of_power}']`).trigger("click");return}$(".pop-record").first().trigger("click")}sendClaimRequest(e){shared.animations.loadingAnimation.start(),this.readdGirlsFromCurrentPoP(e);let o=pop_data[parseInt(e)];if($(".claimPoPButton").prop("disabled",!0),o.ends_in===null||o.ends_in!==0)$(".claimPoPButton").css("display","none"),$(".startPoPButton").css("display",""),pop_data[parseInt(e)].status="can_start",$(".pop-record.selected .collect_notif").remove();else{let a=$(".pop-record.selected");this.selectNextPoPFromFill(a),delete pop_data[parseInt(e)],a.remove()}let t={namespace:"h\\PlacesOfPower",class:o.type==="standard"?"PlaceOfPower":"TempPlaceOfPower",action:"claim",id_place_of_power:o.id_places_of_power};delete this.currentPoPGirls[o.id_places_of_power],shared.general.hh_ajax(t,a=>{let n=$(".pop-claimed-rewards-items");if(n.length){if(a.rewards.data.rewards){let s=shared.reward.newReward.multipleSlot(a.rewards.data.rewards);n.append(s)}this.selectNextPoPFromClaim(),shared.animations.loadingAnimation.stop()}})}calculateTimeToFinishSeconds(e,o){let t=this.convertCriteriaKey(e.criteria),a=0;for(let s of o){let i=pop_hero_girls[s];i&&(a+=i[t])}if(a>=e.max_team_power)return 360*60;let n=e.level_power/a;return Math.floor(n*60)}sendFillRequest(e){shared.animations.loadingAnimation.start();let o=pop_data[parseInt(e)];if(o.status!=="can_start")return;let t=o.id_places_of_power;console.log(`[PoP ${t}] Building girl assignment for this PoP...`);let a=this.assignGirlsToPoP(t)||[];if(this.currentPoPGirls[t]=a,a.length===0){alert("No girls were assigned to this PoP. This might happen if all your girls are already assigned to other PoPs."),delete this.currentPoPGirls[t],shared.animations.loadingAnimation.stop();return}let n=this.convertCriteriaKey(o.criteria),s=0;for(let d of a){let g=pop_hero_girls[d];g&&(s+=g[n])}if(s/o.max_team_power<this.minPercentToStartPoP/100){alert("Not enough power to start this PoP."),delete this.currentPoPGirls[t],shared.animations.loadingAnimation.stop();return}let i=this.calculateTimeToFinishSeconds(o,a);if(s<o.max_team_power&&!confirm(`Warning: This PoP is not fully maxed!

Current Power: ${Math.floor(s)}
Max Power: ${o.max_team_power}

This will take ${(i/60/60).toFixed(2)} hours to complete.
Do you want to continue?`)){delete this.currentPoPGirls[t],$(".startPoPButton").css("display",""),$(".claimPoPButton").css("display","none"),shared.animations.loadingAnimation.stop();return}$(".startPoPButton").css("display","none"),$(".claimPoPButton").css("display","");let c={namespace:"h\\PlacesOfPower",class:o.type==="standard"?"PlaceOfPower":"TempPlaceOfPower",action:"start",id_place_of_power:t,selected_girls:a},l=$('<div class="pop-timer"></div>'),p=shared.timer.buildTimer(i,"","pop-active-timer",!1);l.append(p),$(".pop-record.selected").append(l),pop_data[parseInt(e)].status="in_progress",shared.general.hh_ajax(c,d=>{shared.timer.activateTimers("pop-record.selected .pop-active-timer",()=>{}),this.selectNextPoPFromFill($(".pop-record.selected")),this.updateHHPlusPlusPoPTrackedTime(i),shared.animations.loadingAnimation.stop()})}buildPopDetails(e){let o=$(".pop-details-container");if(!o.length)return;o.children().not(".pop-claimed-rewards-container").remove();let t=pop_data[parseInt(e)];if(!t)return;let a=$('<div class="pop-details-left"></div>');o.append(a);let n=$("<img></img>");n.attr("src",t.girl?t.girl.avatar:IMAGES_URL+"/pictures/girls/1/avb0-1200x.webp?a=1"),a.append(n);let s=$('<div class="pop-navigation-buttons-original blue_button_L">Visit Original</div>');s.on("click",()=>{shared.general.navigate("/activities.html?tab=pop&index=")}),a.append(s);let i=$("<div class='pop-details-right'></div>");o.prepend(i);let c=$(`<a tooltip="Visit this PoP original page" class="pop-title" href="${shared.general.getDocumentHref("/activities.html?tab=pop&index="+t.id_places_of_power)}">${t.title}</div>`);i.append(c);let l=$('<div class="pop-rewards-container"></div>');for(let[g,b]of Object.entries(t.rewards))if(b.loot){let M=shared.reward.newReward.multipleSlot(b);l.append(M);break}i.append(l);let p=$(`<button class="purple_button_L claimPoPButton" ${t.status!="pending_reward"?"disabled":""}>Claim</button>`);i.append(p),p.on("click",()=>{this.sendClaimRequest(e)});let d=$('<button class="blue_button_L startPoPButton">Fill & Start</button>');if(d.on("click",()=>{this.sendFillRequest(e)}),i.append(d),t.status!=="can_start"?d.css("display","none"):p.css("display","none"),!$(".pop-claimed-rewards-container").length){let g=$("<div class='pop-claimed-rewards-container'></div>");o.append(g),g.append("<b>Claimed Rewards:</b>");let b=$("<div class='pop-claimed-rewards-items'></div>");g.append(b)}this.createOrUpdateKobanButtons()}buildCustomPopInfo(){let e=$("#pop_info");if(!e.length)return;e.empty();let o=$('<div class="pop-details-container"></div>');e.append(o);let t=$('<div class="pop-records-container"></div>');Object.entries(pop_data).forEach(([a,n])=>{let s=$('<div class="pop-record"></div>');s.attr("data-pop-id",a),s.css("background-image",`url(${n.image})`),s.on("click",()=>{$(".pop-record").removeClass("selected"),s.addClass("selected"),this.buildPopDetails(a)});let i=$(`<img src="https://hh.hh-content.com/pictures/misc/items_icons/${n.class}.png" class="pop-icon" />`);s.append(i);let c=$(`<div class="pop-lvl">Lv. ${n.level}</div>`);if(s.append(c),n.status==="in_progress"){let l=$('<div class="pop-timer"></div>'),p=shared.timer.buildTimer(n.remaining_time,"","pop-active-timer",!1);l.append(p),s.append(l)}if(n.status==="pending_reward"){let l=$('<div class="collect_notif"></div>');s.append(l)}t.append(s),s.attr("tooltip",n.title)}),e.append(t),$(".pop-record").find(".collect_notif").length!==0?$(".pop-record").find(".collect_notif").first().parent().trigger("click"):$(".pop-record").first().trigger("click"),shared.timer.activateTimers("pop-active-timer",a=>{let n=a.$dom_element.parent().parent().parent();n.hasClass("selected")&&$(".claimPoPButton").prop("disabled",!1);let s=n.data("pop-id");pop_data[s].status="pending_reward",n.append('<div class="collect_notif"></div>')})}injectCustomStyles(){let e=(W(),E(D)).default;GM.addStyle(e)}binarySearchInsertIndex(e,o,t){let a=0,n=e.length;for(;a<n;){let s=Math.floor((a+n)/2),i=pop_hero_girls[e[s]];if(!i){a=s+1;continue}let c=i[t];o>c?n=s:a=s+1}return a}async girlsHandler(){let e=m.getStoredGirlsNumber(),o=Object.keys(pop_hero_girls).length;if(o-e<5)return;this.isUpdatingGirls=!0;let t=Object.values(pop_hero_girls);if(e<=100||e<m.getLastSortOfGirls()-20){m.setLastSortOfGirls(o);let n=[...t].sort((p,d)=>d.carac1-p.carac1).map(p=>p.id_girl);m.setEnumGirlsOrderedByClass(n,1);let i=[...t].sort((p,d)=>d.carac2-p.carac2).map(p=>p.id_girl);m.setEnumGirlsOrderedByClass(i,2);let l=[...t].sort((p,d)=>d.carac3-p.carac3).map(p=>p.id_girl);m.setEnumGirlsOrderedByClass(l,3),m.setStoredGirlsNumber(o),console.log("[PoP++] Full sort completed")}else{let a=m.getEnumGirlsOrderedByClass(1),n=m.getEnumGirlsOrderedByClass(2),s=m.getEnumGirlsOrderedByClass(3),i=new Set(a),c=t.filter(l=>!i.has(l.id_girl));for(let l of c){let p=this.binarySearchInsertIndex(a,l.carac1,"carac1");a.splice(p,0,l.id_girl);let d=this.binarySearchInsertIndex(n,l.carac2,"carac2");n.splice(d,0,l.id_girl);let g=this.binarySearchInsertIndex(s,l.carac3,"carac3");s.splice(g,0,l.id_girl)}m.setEnumGirlsOrderedByClass(a,1),m.setEnumGirlsOrderedByClass(n,2),m.setEnumGirlsOrderedByClass(s,3),m.setStoredGirlsNumber(o),console.log(`[PoP++] Binary search insertion completed for ${c.length} new girls`)}}whichGirlsInPoP(){for(let e of Object.values(pop_hero_girls))e.id_places_of_power!=null&&(this.currentPoPGirls[e.id_places_of_power]||(this.currentPoPGirls[e.id_places_of_power]=[]),this.currentPoPGirls[e.id_places_of_power].push(e.id_girl));this.isUpdatingGirls=!1}};var ne={baseKey:"noReloadFromClaimingDailyChests",label:"No reload from claiming daily chests",default:!0},S=class extends h{constructor(){super(ne)}shouldRun(){return!0}run(){if(this.hasRun||!this.shouldRun())return location.pathname.includes("/activities.html");this.hasRun=!0,$(".switch-tab[data-tab='daily_goals']").on("click",()=>{console.log("Clicked daily goals"),f.doWhenSelectorAvailable(".progress-bar-claim-reward",()=>{this.applyNoReloadFix()})})}applyNoReloadFix(){let r=this;$(".progress-bar-claim-reward").off("click").on("click",function(e){e.stopPropagation(),e.preventDefault(),$(this).prop("disabled",!0);let o=$(this).attr("tier");if(!o)return;let t={action:"claim_daily_goal_tier_reward",tier:o};daily_goals_member_progression.taken_rewards_array.push(o),shared.general.hh_ajax(t,a=>{let n=a.rewards;shared.reward_popup.Reward.handlePopup(n),r.checkIfAllChestsClaimed()})}),$(".progress-bar-claim-reward").attr("tooltip","Several QoL: Claim without reload")}checkIfAllChestsClaimed(){daily_goals_member_progression.taken_rewards_array.length>=Math.min(Math.floor(daily_goals_member_progression.potions_amount/20),5)&&$('[data-tab="daily_goals"] > .collect_notif').remove()}};var le={baseKey:"povInfo",label:"PoV Info",default:!0},C=class extends h{constructor(){super(le)}shouldRun(){return location.pathname.includes("/path-of-valor.html")}run(){this.hasRun||!this.shouldRun()||(this.hasRun=!0,f.doWhenSelectorAvailable(".potions-paths-objective > h4",()=>{$(".potions-paths-objective > h4").text("PoV Info (click)"),$(".potions-paths-objective > h4").css("cursor","pointer"),$(".potions-paths-objective > h4").on("click",()=>{this.activatePopup()})}))}activatePopup(){let r=$(`
    <div class="popup_background clickable"></div>
    <div id="popup_PoVInfo" class="popup">
        <div class="PoVInfo-container container-special-bg">
            <span class="PoVInfo-title">Path of Valor Info</span>
            <p>PoV cycle through those goals in order</p>
            <img src="https://raw.githubusercontent.com/infarcactus-HH/HH-Several_QoL/refs/heads/main/images/PoVInfo.png" alt="PoVInfo" />
        </div>
        <close class="closable"></close>
    </div>
    `),e=(F(),E(V)).default;GM.addStyle(e);let o={type:"common",init:t=>{console.log("init pov info popup",t);let a=$("#common-popups");o.$dom_element.empty().append(r),a.append(o.$dom_element)},destroy:()=>{console.log("destroy pov info popup"),shared.PopupQueueManager.close({type:"common"})},onClose:()=>{},onOpen:()=>{},$dom_element:$('<div class="popup_wrapper"></div>'),popup_name:"pov_info",close_on_esc:!0,addEventListeners:()=>{console.log("add event listeners pov info popup"),o.$dom_element.find("close.closable").on("click",()=>{o.destroy()}),o.$dom_element.find(".popup_background.clickable").on("click",()=>{o.destroy()})},removeEventListeners:()=>{}};shared.PopupQueueManager.add({popup:o})}};var ce={baseKey:"meRankingInfo",label:"Adds info about rankings in seasonal event",default:!0},H=class extends h{constructor(){super(ce);this.heroData=null;this.leaderboardData=null}shouldRun(){return location.pathname.includes("seasonal.html")}run(){this.hasRun||!this.shouldRun()||(this.hasRun=!0,this.injectCSS(),this.hookAjaxRequest())}async injectCSS(){let e=(K(),E(q)).default;GM.addStyle(e)}hookAjaxRequest(){$(document).ajaxComplete((e,o,t)=>{t?.data==="action=leaderboard&feature=seasonal_event_top"&&(this.heroData=o.responseJSON?.hero_data,this.leaderboardData=o.responseJSON?.leaderboard,this.hookSpecialHeroRow())})}hookSpecialHeroRow(){f.doWhenSelectorAvailable("#leaderboard_holder > #outer-hero-row",()=>{console.log("found special hero row");let e=this.createTooltipTableRankingContent(),o=$('<img class="me-leaderboard-info" src="https://hh.hh-content.com/leagues/ic_rankup.png" tooltip></img>');o.attr("hh_title",e),$("#leaderboard_holder > #outer-hero-row").append(o)})}createTooltipTableRankingContent(){if(!this.heroData||!this.leaderboardData)return"";let e=[10,50,100,250,500,1e3],o=this.heroData.rank,t=this.heroData.potions,a='<div class="me-ranking-tooltip">';a+='<table style="border-collapse: collapse; width: 100%;">',a+="<thead><tr>",a+="<th>Rank</th>",a+="<th>Resource</th>",a+="<th>Difference</th>",a+="</tr></thead><tbody>";let n=this.leaderboardData.find(s=>s.rank===o);return e.forEach(s=>{let i=this.leaderboardData.find(d=>d.rank===s),c=i?.potions??"?",l="?",p="black";if(i){let d=t-i.potions;if(d===0){let g=n?n.id_member:1/0,b=i.id_member;g<b?(l="+0 (above)",p="green"):g>b?(l="+0 (below)",p="red"):(l="= (tie)",p="orange")}else l=d>0?`+${d}`:`${d}`,p=d>0?"green":"red"}a+="<tr>",a+=`<td>${s}</td>`,a+=`<td>${c}</td>`,a+=`<td style="color: ${p}; font-weight: bold;">${l}</td>`,a+="</tr>"}),a+="</tbody></table></div>",a}};var ue={baseKey:"leagueOponentHistory",label:"Show history of opponents in league (click on the row to refresh)",default:!0},T=class extends h{constructor(){super(ue);this.updatedPlayerRecordsThisSession=new Set}shouldRun(){return location.pathname.includes("/leagues.html")}run(){this.hasRun||!this.shouldRun()||(this.hasRun=!0,this.injectCSS(),this.leaguePlayerRecord=m.getLeaguePlayerRecord(),f.doWhenSelectorAvailable(".league_table",()=>{this.applyRankingsToOpponentLists(),this.startObserverClickOnTable(),this.applyRankingsToTable()}),$(document).on("league:table-sorted",()=>{this.startObserverClickOnTable(),this.applyRankingsToTable()}))}async injectCSS(){let e=(Q(),E(U)).default;GM.addStyle(e)}applyRankingsToOpponentLists(){this.leaguePlayerRecord!==void 0&&opponents_list.forEach(e=>{let o=e.player.id_fighter,t=this.leaguePlayerRecord[o];t&&(e.Several_QoL={chechExpiresAt:server_now_ts,bestPlace:t.bestPlace,timesReached:t.timesReached})})}startObserverClickOnTable(){let e=this;$(".league_table > .data-list > .body-row").on("click.SeveralQoL",function(){let o=parseInt($(this).children("[column='place']").text().trim()),t=opponents_list.find(a=>a.place===o);if(!t){console.warn("Could not find opponent for place ",o);return}t.Several_QoL&&t.Several_QoL.chechExpiresAt<server_now_ts||e.updatedPlayerRecordsThisSession.has(t.player.id_fighter)||e.sendRequestAndAnalyzeOpponent(t.player.id_fighter,$(this))})}sendRequestAndAnalyzeOpponent(e,o){let t={action:"fetch_hero",id:"profile",preview:!1,player_id:e},a=/<img src="https:\/\/.*?\/pictures\/design\/leagues\/9\.png">\n\s*?<div class="tier-stats">\n\s*?<div>Best place:\s*<span>(\d+)<sup>[^<]+<\/sup><\/span><\/div>[\s\S]*?<div>Times reached: <span>(\d+)<\/span><\/div>/g;shared.general.hh_ajax(t,n=>{let s=a.exec(n.html),i=s?parseInt(s[1]):null,c=s?parseInt(s[2]):null;if(!i||!c){console.warn("Could not find D3 placement info for opponent id ",e);return}this.updatedPlayerRecordsThisSession.add(e);let l=this.leaguePlayerRecord[e];l&&l.bestPlace===i&&l.timesReached===c||(this.updateOpponentRecord(e,i,c),o.children("[column='nickname']").find(".several-qol-bestrank-timesreached").remove(),o.children("[column='nickname']").append(this.generateRankHtml(i,c)))})}updateOpponentRecord(e,o,t){this.leaguePlayerRecord[e]={bestPlace:o,timesReached:t,checkExpiresAt:server_now_ts+season_end_at+10},m.setLeaguePLayerRecord(this.leaguePlayerRecord)}applyRankingsToTable(){let e=$(".data-row.body-row");this.leaguePlayerRecord!==void 0&&e.each((o,t)=>{let a=parseInt($(t).children("[column='place']").text().trim());if(!a)return;let n=opponents_list.find(c=>c.place===a);if(!n)return;let s=n.player.id_fighter,i=this.leaguePlayerRecord[s];i&&$(t).children("[column='nickname']").append(this.generateRankHtml(i.bestPlace,i.timesReached))})}generateRankHtml(e,o){let t=$('<div class="several-qol-bestrank-timesreached"></div>'),a=$(`<span class="rank-container ${this.generateRankClass(e)}">${e}</span>`),n=$(`<span class="times-reached">x${o}</span>`);return t.prepend(a),t.append(n),t}generateRankClass(e){return e==1?"several-qol-top1":e<=4?"several-qol-top4":e<=15?"several-qol-top15":e<=30?"several-qol-top30":"several-qol-top30plus"}};var L=class{constructor(){this.allModules=[new _,new w,new x,new y,new P,new v,new k,new R,new S,new C,new H,new T];if(unsafeWindow.hhPlusPlusConfig===void 0){Promise.race([new Promise(r=>{$(document).one("hh++-bdsm:loaded",()=>r("hh++-bdsm:loaded"))}),new Promise(r=>setTimeout(()=>r("timeout"),50))]).then(r=>{r==="hh++-bdsm:loaded"?this.run():this.runWithoutBdsm()});return}this.run()}run(){unsafeWindow.hhPlusPlusConfig.registerGroup({key:"severalQoL",name:"<span tooltip='by infarctus'>Several QoL</span>"}),this.allModules.forEach(r=>{unsafeWindow.hhPlusPlusConfig.registerModule(r)}),unsafeWindow.hhPlusPlusConfig.loadConfig(),unsafeWindow.hhPlusPlusConfig.runModules()}runWithoutBdsm(){this.allModules.forEach(r=>{try{let e=r.configSchema;if(r.shouldRun())if(e.subSettings){let o=e.subSettings.reduce((t,a)=>(t[a.key]=!0,t),{});r.run(o)}else r.run(void 0)}catch(e){console.error("Error running module",r,e)}})}};new L;})();
